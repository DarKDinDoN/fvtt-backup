{"_id":"3dGySNraAqFjLdy9","name":"Carte et lumières","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"systems/pf2e/icons/equipment/consumables/other-consumables/spell-scroll.jpg","tooltip":"Carte et lumières","colour":"#f7d488","trigger":""}},"core":{"sourceId":"Macro.qw58ratRgUZquswi"}},"scope":"global","command":"let applyChanges = false;\nnew Dialog({\n  title: `Map Configuration`,\n  content: `\n    <form>\n      <div class=\"form-group\">\n        <label>Map type:</label>\n        <select id=\"map-type\" name=\"map-type\">\n          <option value=\"nochange\">Aucun changement</option>\n          <option value=\"withsight\">Vision activée</option>\n          <option value=\"withoutsight\">Vision désactivée</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n        <label>Light Source:</label>\n        <select id=\"light-source\" name=\"light-source\">\n          <option value=\"nochange\">Aucun changement</option>\n          <option value=\"none\">Pas de source de lumière</option>\n          <option value=\"candle\">Bougie</option>\n          <option value=\"bullseye\">Lanterne à capote</option>\n          <option value=\"hooded-bright\">Lanterne sourde (normale)</option>\n          <option value=\"hooded-dim\">Lanterne sourde (couverte)</option>\n          <option value=\"torch\">Torche</option>\n          <option value=\"light\">Lumière (sort)</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n          <label for=\"turn-on-off\">Switch turn on / off</label>\n          <input type=\"checkbox\" name=\"turn-on-off\" id=\"turn-on-off\">\n      </div>\n    </form>\n    `,\n  buttons: {\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: `Cancel Changes`\n    },\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: `Apply Changes`,\n      callback: () => applyChanges = true\n    }\n  },\n  default: \"yes\",\n  close: html => {\n    if (applyChanges) {\n      let mapSource = html.find('[name=\"map-type\"]')[0].value || \"withsight\";\n      let lightSource = html.find('[name=\"light-source\"]')[0].value || \"none\";\n      let turnOnOff = html.find('[name=\"turn-on-off\"]')[0].checked || false;\n\n      if (mapSource !== \"nochange\") {\n        let hasGlobalThreshold = false;\n        let globalLightThreshold = 0;\n        let padding = 0;\n        let scene = game.scenes.viewed\n        let backgroundColor = \"#404040\";\n        let gridColor = \"#404040\";\n        let gridUnits = \"m\";\n        let gridDistance = 1.5;\n        let gridAlpha = 0.5;\n        let tokenVision = false;\n        let globalLight = false;\n        let fogExploration = false;\n        let navigation = false;\n        let initial = {\n          x: parseInt(canvas.stage.pivot.x),\n          y: parseInt(canvas.stage.pivot.y),\n          scale: canvas.stage.scale.x\n        };\n        // Get Scene Source Values\n        switch (mapSource) {\n          case \"withsight\":\n            hasGlobalThreshold = true;\n            globalLightThreshold = 0.95;\n            tokenVision = true;\n            fogExploration = true;\n            globalLight = true;\n            break;\n          case \"withoutsight\":\n            hasGlobalThreshold = false;\n            globalLightThreshold = 0;\n            globalLight = true;\n            gridUnits = scene.data.gridUnits;\n            gridDistance = scene.data.gridDistance;\n            break;\n          case \"nochange\":\n          default:\n            hasGlobalThreshold = scene.data.hasGlobalThreshold;\n            globalLightThreshold = scene.data.globalLightThreshold;\n            padding = scene.data.padding;\n            backgroundColor = scene.data.backgroundColor;\n            gridColor = scene.data.gridColor;\n            gridUnits = scene.data.gridUnits;\n            gridDistance = scene.data.gridDistance;\n            gridAlpha = scene.data.gridAlpha;\n            tokenVision = scene.data.tokenVision;\n            globalLight = scene.data.globalLight;\n            fogExploration = scene.data.fogExploration;\n            navigation = scene.data.navigation;\n            initial = {\n              x: scene.data.initial.x,\n              y: scene.data.initial.y,\n              scale: scene.data.initial.scale\n            };\n        }\n        // Update scene\n        scene.update({\n          hasGlobalThreshold: hasGlobalThreshold,\n          globalLightThreshold: globalLightThreshold,\n          padding: padding,\n          backgroundColor: backgroundColor,\n          gridColor: gridColor,\n          gridUnits: gridUnits,\n          gridDistance: gridDistance,\n          gridAlpha: gridAlpha,\n          tokenVision: tokenVision,\n          globalLight: globalLight,\n          fogExploration: fogExploration,\n          navigation: navigation,\n          initial: initial\n        });\n      }\n\n      if (lightSource !== \"nochange\") {\n        for (let light of canvas.lighting.objects.children) {\n          let dim = 0;\n          let bright = 0;\n          let angle = 360;\n          let tintAlpha = 0.3;\n          let tintColor = '#f27d0c';\n          let flags = {\n            CommunityLighting: {\n              secondaryColor: '', ratioDamper: 0, blurStrength: 0\n            }\n          }\n          let lightAnimation = { type: '', speed: 1, intensity: 1, blurStrength: 0, ratioDamper: 0, secondaryColor: '' }\n          let darknessThreshold = 0.7;\n          let hidden = false;\n          // Get Light Source Values\n          switch (lightSource) {\n            case \"none\":\n              dim = 0;\n              bright = 0;\n              lightAnimation.type = '';\n              flags.CommunityLighting = {}\n              hidden = true;\n              break;\n            case \"candle\":\n              dim = 3.75;\n              bright = 0.75;\n              lightAnimation.type = 'BlitzBlurred Torch';\n              lightAnimation.blurStrength = 10;\n              lightAnimation.ratioDamper = 1;\n              lightAnimation.secondaryColor = '#e25822';\n              flags.CommunityLighting.blurStrength = 10;\n              flags.CommunityLighting.ratioDamper = 1;\n              flags.CommunityLighting.secondaryColor = '#e25822';\n              break;\n            case \"bullseye\":\n              dim = 36.75;\n              bright = 18.75;\n              angle = 52.5;\n              lightAnimation.type = 'BlitzBlurred Torch';\n              lightAnimation.blurStrength = 20;\n              lightAnimation.ratioDamper = 9;\n              lightAnimation.secondaryColor = '#e25822';\n              flags.CommunityLighting.blurStrength = 20;\n              flags.CommunityLighting.ratioDamper = 9;\n              flags.CommunityLighting.secondaryColor = '#e25822';\n              break;\n            case \"hooded-dim\":\n              dim = 0.85;\n              bright = 0;\n              lightAnimation.type = 'BlitzBlurred Torch';\n              lightAnimation.blurStrength = 1;\n              lightAnimation.ratioDamper = 1;\n              lightAnimation.secondaryColor = '#e25822';\n              flags.CommunityLighting.blurStrength = 1;\n              flags.CommunityLighting.ratioDamper = 1;\n              flags.CommunityLighting.secondaryColor = '#e25822';\n              break;\n            case \"hooded-bright\":\n              dim = 18.75;\n              bright = 9.75;\n              lightAnimation.type = 'BlitzBlurred Torch';\n              lightAnimation.blurStrength = 20;\n              lightAnimation.ratioDamper = 6;\n              lightAnimation.secondaryColor = '#e25822';\n              flags.CommunityLighting.blurStrength = 20;\n              flags.CommunityLighting.ratioDamper = 6;\n              flags.CommunityLighting.secondaryColor = '#e25822';\n              break;\n            case \"torch\":\n              dim = 12.75;\n              bright = 6.75;\n              lightAnimation.type = 'BlitzBlurred Torch';\n              lightAnimation.blurStrength = 20;\n              lightAnimation.ratioDamper = 3;\n              lightAnimation.secondaryColor = '#e25822';\n              flags.CommunityLighting.blurStrength = 20;\n              flags.CommunityLighting.ratioDamper = 3;\n              flags.CommunityLighting.secondaryColor = '#e25822';\n              break;\n            case \"light\":\n              dim = 12.75;\n              bright = 6.75;\n              tintColor = '';\n              lightAnimation.type = 'BlitzStatic Blur';\n              lightAnimation.blurStrength = 20;\n              flags.CommunityLighting.blurStrength = 20;\n              break;\n            case \"nochange\":\n            default:\n              flags = light.data.flags;\n              dim = light.data.dim;\n              tintColor = light.data.tintColor;\n              lightAnimation = light.data.lightAnimation;\n              bright = light.data.bright;\n              angle = light.data.angle;\n              tintAlpha = light.data.tintAlpha;\n              darknessThreshold = light.data.darknessThreshold;\n              hidden = light.data.hidden;\n          }\n          // Update light\n          light.update({\n            flags: flags,\n            dim: dim,\n            tintColor: tintColor,\n            lightAnimation: lightAnimation,\n            bright: bright,\n            angle: angle,\n            tintAlpha: tintAlpha,\n            darknessThreshold: darknessThreshold,\n            hidden: hidden\n          });\n        }\n      }\n\n      if (turnOnOff === true) {\n        for (let light of canvas.lighting.objects.children) {\n          light.update({\n            hidden: !light.data.hidden\n          });\n        }\n      }\n    }\n  }\n}).render(true);","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/equipment/consumables/other-consumables/spell-scroll.webp","actorIds":[]}
{"_id":"6IAfgLYqJmLiYDRo","name":"Pluie","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"macro-marker":{"activeData":{"tooltip":"","icon":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false}},"scope":"global","command":"Hooks.call('switchWeather', {name: \"7T0JJT6S3L\", type: \"raintop\", options: {density: 6, speed: 53, scale: 33}});","author":"amdu4xTh7PPZZgSP","img":"modules/fxmaster/icons/weather/rain.png","actorIds":[]}
{"_id":"9iW9zrJxwYXHDiJ3","name":"Aurore/Crépuscule","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/sunset.jpg","tooltip":"Aurore/Crépuscule","colour":"#f7d488","trigger":""}},"core":{"sourceId":"Macro.DFlJC5R4NvKwBJTs"}},"scope":"global","command":"canvas.scene.update({darkness: 0.85})","author":"amdu4xTh7PPZZgSP","img":"icons/sunset.jpg","actorIds":[]}
{"_id":"C8qOD74GupYZemA6","name":"Convertir distance en mètres","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"Convertir en mètres              ","colour":"#f7d488","trigger":""}},"core":{"sourceId":"Macro.OHX4nTGNUD9XXl28"}},"scope":"global","command":"if (canvas.tokens.controlled.length === 0)\r\n  return ui.notifications.error(\"Please select a token first\");\r\n\r\nlet numberUpdated = 0\r\nfor (let token of canvas.tokens.controlled) {\r\n    if (String(token.actor.data.data.attributes.speed.value).indexOf('feet') !== -1) {\r\n        let actor = game.actors.get(token.actor._id)\r\n        actor.data.data.attributes.speed.value = parseFloat(actor.data.data.attributes.speed.value) * 0.3\r\n        actor.update(actor.data)\r\n        numberUpdated++\r\n    }\r\n}\r\nreturn ui.notifications.info(`${numberUpdated} tokens updated`);","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/equipment/adventuring-gear/swim-fins.webp","actorIds":[]}
{"_id":"LMssPhAwprtgsE6D","name":"Neige","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"macro-marker":{"activeData":{"tooltip":"","icon":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false}},"scope":"global","command":"Hooks.call('switchWeather', {name: \"JcEHMtoLa8\", type: \"snow\", options: {density: 33, speed: 25, scale: 34}});","author":"amdu4xTh7PPZZgSP","img":"modules/fxmaster/icons/weather/snow.png","actorIds":[]}
{"_id":"LYk6KJkDMdsM5Iy2","name":"Forme animale","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"systems/pf2e/icons/spells/animal-form.jpg","tooltip":"Forme animale","colour":"#f7d488","trigger":""},"markers":{"markers":{"rNst4n6AMW5irgk7":false},"type":"Macro"}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.rNst4n6AMW5irgk7"}},"scope":"global","command":"// Configuration\nconst transformationsFolder = \"Transformations Bellis\"\nconst baseAC = 17\nconst hpTemp = 10\nconst athBonus = 14\nconst bonusAttack = 14\nconst dmgBonus = 5\n\n//Must have a token\nif (!token) return ui.notifications.warn(\"You must select a token first\")\n\nif (MacroMarker.isActive(this)) {\n    MacroMarker.toggle(this)\n\n    // Transform back the token if we can find an active transformation\n    if (token.data.flags && token.data.flags.transformationFrom) {\n        const originalPC = game.actors.get(token.data.flags.transformationFrom)\n        originalPC.update({\n            data: {\n                attributes: {\n                    hp: {\n                        value: token.actor.data.data.attributes.hp.value\n                    }\n                }\n            }\n        })\n\n        token.actor.sheet.close()\n        originalPC.sheet.render(true)\n\n        let macro = game.macros.getName(\"transformToken\")\n        await macro.execute(token.data._id, token.data.flags.transformationFrom, originalPC.data.name)\n\n        setTimeout(() => {\n            const newToken = canvas.tokens.placeables.find(t => t.data.name === originalPC.data.name)\n            newToken.control()\n        }, 1000);\n    }\n\n    return\n}\n\n// Settings variables\nconst isGm = game.user.isGM\nconst currentUserId = game.userId\nconst npcType = \"npc\"\nconst ownedValue = 3\nlet applyChanges = false\n\n// Search for the transformations folder\nlet creatures = game.folders.filter(f => f.data.name === transformationsFolder)\nif (creatures.length < 1) return ui.notifications.warn(\"You must input a valid transformations folder name\")\n\n// Filter out non npc and non controlled creatures\ncreatures = creatures[0].content.filter(c =>\n    c.data.type === npcType &&\n    (isGm ||\n        c.data.permission.default === ownedValue ||\n        (c.data.permission.hasOwnProperty(currentUserId) && c.data.permission[currentUserId] === ownedValue)\n    )\n)\n\n// Dialog template\nconst template = `\n<style>\n    #pf2-transformator header {\n    border-radius: 0;\n    background: linear-gradient(90deg, var(--secondary) 0%, #202b93 50%, var(--secondary) 100%);\n    border: none;\n    box-shadow: inset 0 0 0 1px #9f725b,inset 0 0 0 2px var(--tertiary),inset 0 0 0 3px #956d58;\n    margin-bottom: 2px;\n    font-size: .75rem;\n    }\n    #pf2-transformator .window-content {\n    background-image: url(systems/pf2e/assets/sheet/red_bg.jpg);\n    background-size: cover;\n    padding: 9px;\n    background-origin: border-box;\n    color: #ffefbd;\n    border-width: 9px;\n    border-image: url(systems/pf2e/assets/sheet/corner-box.png) 9 repeat;\n    border-style: solid;\n    border-image-outset: 0;\n    }\n    #pf2-transformator form {\n    margin-bottom: 20px;\n    }\n    #pf2-transformator .form-fields.buttons {\n    justify-content: flex-start !important;\n    }\n    #pf2-transformator .button {\n    flex: 1 !important;\n    border-width: 9px;        \n    border-image: url(systems/pf2e/assets/sheet/corner-box.png) 9 repeat;\n    font-size: 12px;\n    padding: 0;\n    background: #171f69;\n    color: #ffefbd;\n    cursor: pointer;\n    }\n    #pf2-transformator .button:hover {\n    box-shadow: 0 0 8px white;\n    }\n    #pf2-transformator .dialog-buttons {\n    align-items: flex-end;\n    }\n    #pf2-transformator .dialog-button {\n    height: 50px;\n    background: #171f69;\n    border-image: url(systems/pf2e/assets/sheet/corner-box.png) 9 repeat;\n    color: #ffefbd;\n    border-width: 9px;\n    display: inline-flex;\n    justify-content: space-evenly;\n    align-items: center;\n    cursor: pointer;\n    }\n    #pf2-transformator .notes {\n    color: #ffefbd !important;\n    flex: 0 0 100% !important;\n    font-size: 12px !important;\n    line-height: 16px !important;\n    margin: 10px 0 5px 0 !important;\n    }\n    #pf2-transformator .notes.title {\n    border-bottom: 1px solid #f7d488;\n    font-size: 14px !important;\n    font-weight: bold;\n    margin: 20px 0 10px 0 !important;\n    }\n\n    #pf2-transformator select {\n    cursor: pointer;\n    margin: -2px 0;\n    font-size: 13px;\n    font-family: \"Signika\", sans-serif;\n    background: #171f69;\n    color: #ffefbd;\n    border-width: 9px;\n    height: 35px;\n    border-image: url(systems/pf2e/assets/sheet/corner-box.png) 9 repeat;\n    }\n</style>\n<form>\n    <div class=\"form-group\">\n    <p class=\"notes title\">Choisissez votre forme :</p>\n    <div class=\"form-fields\">\n        <select name=\"transformation\">\n        <option value=\"none\">Aucune</option>\n        ${creatures.map(c => `\n            <option value=\"${c.data._id}\">${c.data.name}</option>\n        `).join('')}\n        </select>\n    </div>\n    </div>\n</form>\n`\n\n// Transformation dialog\nnew Dialog({\n    title: `Sélection de la forme`,\n    content: template,\n    buttons: {\n        no: {\n            icon: \"<i class='fas fa-times'></i>\",\n            label: `Annuler`\n        },\n        yes: {\n            icon: \"<i class='fas fa-check'></i>\",\n            label: `Appliquer`,\n            callback: () => applyChanges = true\n        }\n    },\n    default: \"yes\",\n    close: async html => {\n        if (!applyChanges) return\n        game.pf2e.rollItemMacro(\"WMun7IKhJp7LS7kc\");\n\n        const chosenTransformation = html.find('[name=\"transformation\"]')[0].value\n        if (chosenTransformation === 'none') return\n\n        // Find the creature\n        const creature = creatures.filter(c => c.data._id === chosenTransformation)[0]\n\n        let unarmed = token.actor.data.data.martial.unarmed.value\n        let dex = token.actor.data.data.abilities.dex.mod\n        let rawUnarmedBonus = unarmed + dex\n        creature.items.forEach(i => {\n            if (i.data.type === 'melee') {\n                i.data.data.bonus.value = rawUnarmedBonus >= bonusAttack ? rawUnarmedBonus : bonusAttack\n\n                let found = false\n                for (const [key, value] of Object.entries(i.data.data.damageRolls)) {\n                    if (key === \"bonus\") {\n                        found = true\n                        i.data.data.damageRolls[key].damage = dmgBonus\n                    }\n                }\n                if (!found) {\n                    i.data.data.damageRolls['bonus'] = { damage: dmgBonus, damageType: 'bonus' }\n                }\n\n                i.update(i.data)\n            }\n\n            if (i.data.type === 'lore' && i.data.name === 'Athlétisme') {\n                i.data.data.mod.value = token.actor.data.data.skills.ath.totalModifier >= athBonus ? token.actor.data.data.skills.ath.totalModifier : athBonus\n                i.update(i.data)\n            }\n        })\n\n        if (!creature.items.find(i => i.data.name === \"Athlétisme\")) {\n            creature.createEmbeddedEntity('OwnedItem', {\n                \"name\": \"Athlétisme\",\n                \"type\": \"lore\",\n                \"img\": \"/icons/svg/d20-black.svg\",\n                \"data\": {\n                    \"description\": {\n                        \"value\": \"\",\n                        \"chat\": \"\",\n                        \"unidentified\": \"\"\n                    },\n                    \"source\": {\n                        \"value\": \"\"\n                    },\n                    \"traits\": {\n                        \"value\": []\n                    },\n                    \"rarity\": {\n                        \"value\": \"common\"\n                    },\n                    \"usage\": {\n                        \"value\": \"held-in-one-hand\"\n                    },\n                    \"rules\": [],\n                    \"featType\": \"\",\n                    \"mod\": {\n                        \"value\": token.actor.data.data.skills.ath.totalModifier >= athBonus ? token.actor.data.data.skills.ath.totalModifier : athBonus\n                    },\n                    \"proficient\": {\n                        \"value\": 0\n                    },\n                    \"item\": {\n                        \"value\": 0\n                    }\n                },\n                \"sort\": 300000\n            })\n        }\n\n        creature.update({\n            data: {\n                attributes: {\n                    ac: {\n                        base: baseAC + token.actor.data.data.details.level.value\n                    },\n                    hp: {\n                        value: token.actor.data.data.attributes.hp.value,\n                        max: token.actor.data.data.attributes.hp.totalModifier,\n                        temp: hpTemp\n                    },\n                    perception: {\n                        base: token.actor.data.data.attributes.perception.totalModifier\n                    }\n                },\n                abilities: {\n                    cha: {\n                        value: token.actor.data.data.abilities.cha.value,\n                        mod: token.actor.data.data.abilities.cha.mod\n                    },\n                    con: {\n                        value: token.actor.data.data.abilities.con.value,\n                        mod: token.actor.data.data.abilities.con.mod\n                    },\n                    dex: {\n                        value: token.actor.data.data.abilities.dex.value,\n                        mod: token.actor.data.data.abilities.dex.mod\n                    },\n                    int: {\n                        value: token.actor.data.data.abilities.int.value,\n                        mod: token.actor.data.data.abilities.int.mod\n                    },\n                    str: {\n                        value: token.actor.data.data.abilities.str.value,\n                        mod: token.actor.data.data.abilities.str.mod\n                    },\n                    wis: {\n                        value: token.actor.data.data.abilities.wis.value,\n                        mod: token.actor.data.data.abilities.wis.mod\n                    },\n                },\n                saves: {\n                    fortitude: {\n                        base: token.actor.data.data.saves.fortitude.totalModifier\n                    },\n                    reflex: {\n                        base: token.actor.data.data.saves.reflex.totalModifier\n                    },\n                    will: {\n                        base: token.actor.data.data.saves.will.totalModifier\n                    }\n                }\n            }\n        })\n\n        // Place a creature token on the canvas instead and delete the original token\n        let macro = game.macros.getName(\"transformToken\")\n        const creatureName = token.actor.data.name\n        await macro.execute(token.data._id, creature.data._id, creatureName)\n\n        // Set the macro as active\n        MacroMarker.toggle(this)\n\n        // Search for the new token and open the relevant sheet\n        setTimeout(() => {\n            const newToken = canvas.tokens.placeables.find(t => t.data.name === token.data.name)\n\n            // Add relevant image to token\n            if (newToken && !newToken.data.effects.includes(token.data.img)) {\n                newToken.toggleEffect(token.data.img)\n            }\n            newToken.actor.sheet.render(true)\n            newToken.control()\n        }, 1000);\n    }\n}, {\n    id: 'pf2-transformator'\n}).render(true)","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/spells/animal-form.webp","actorIds":[]}
{"_id":"TJd7bCAwoz32JRnH","name":"Nuit","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.wUNb2TfULY5chNLD"}},"scope":"global","command":"canvas.scene.update({darkness: 1.0})","author":"amdu4xTh7PPZZgSP","img":"icons/night.jpg","actorIds":[]}
{"_id":"VmRQLvFwtiWiMcr1","name":"Vision du token","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"systems/pf2e/icons/equipment/adventuring-gear/lantern.jpg","tooltip":"Vision du token","colour":"#f7d488","trigger":""}},"core":{"sourceId":"Macro.IGUxdzrg6yA9sAnl"}},"scope":"global","command":"if (canvas.tokens.controlled.length === 0)\n  return ui.notifications.error(\"Please select a token first\");\n\nlet applyChanges = false;\nnew Dialog({\n  title: `Token Vision Configuration`,\n  content: `\n    <form>\n      <div class=\"form-group\">\n        <label>Vision Type:</label>\n        <select id=\"vision-type\" name=\"vision-type\">\n          <option value=\"nochange\">Aucun changement</option>\n          <option value=\"none\">Aucune vision</option>\n          <option value=\"nightvision\">Vision nocturne</option>\n          <option value=\"darkvision\">Vision dans le noir</option>\n          <option value=\"superiordarkvision\">Vision dans le noir améliorée</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n        <label>Light Source:</label>\n        <select id=\"light-source\" name=\"light-source\">\n          <option value=\"nochange\">Aucun changement</option>\n          <option value=\"none\">Pas de source de lumière</option>\n          <option value=\"candle\">Bougie</option>\n          <option value=\"bullseye\">Lanterne à capote</option>\n          <option value=\"hooded-bright\">Lanterne sourde (normale)</option>\n          <option value=\"hooded-dim\">Lanterne sourde (couverte)</option>\n          <option value=\"torch\">Torche</option>\n          <option value=\"light\">Lumière (sort)</option>\n        </select>\n      </div>\n    </form>\n    `,\n  buttons: {\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: `Cancel Changes`\n    },\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: `Apply Changes`,\n      callback: () => applyChanges = true\n    }\n  },\n  default: \"yes\",\n  close: html => {\n    if (applyChanges) {\n      for (let token of canvas.tokens.controlled) {\n        let visionType = html.find('[name=\"vision-type\"]')[0].value || \"none\";\n        let lightSource = html.find('[name=\"light-source\"]')[0].value || \"none\";\n        let dimSight = 0;\n        let brightSight = 0;\n        let dimLight = 0;\n        let brightLight = 0;\n        let lightAngle = 360;\n        let lockRotation = token.data.lockRotation;\n        let lightAlpha = 0.3;\n        let lightColor = '#f27d0c';\n        let lightAnimation = { type: '', speed: 1, intensity: 1, blurStrength: 0, ratioDamper: 0, secondaryColor: '' }\n        // Get Vision Type Values\n        switch (visionType) {\n          case \"none\":\n            dimSight = 0;\n            brightSight = 0;\n            break;\n          case \"nightvision\":\n            dimSight = 300;\n            brightSight = 0;\n            break;\n          case \"darkvision\":\n            dimSight = 0;\n            brightSight = 300;\n            break;\n          case \"superiordarkvision\":\n            dimSight = 0;\n            brightSight = 300;\n            break;\n          case \"nochange\":\n          default:\n            dimSight = token.data.dimSight;\n            brightSight = token.data.brightSight;\n        }\n        // Get Light Source Values\n        switch (lightSource) {\n          case \"none\":\n            dimLight = 0;\n            brightLight = 0;\n            lightAnimation.type = '';\n            break;\n          case \"candle\":\n            dimLight = 3;\n            brightLight = 0;\n            lightAnimation.type = 'BlitzBlurred Torch';\n            lightAnimation.blurStrength = 10;\n            lightAnimation.ratioDamper = 1;\n            lightAnimation.secondaryColor = '#e25822';\n            break;\n          case \"bullseye\":\n            dimLight = 36;\n            brightLight = 18;\n            lockRotation = false;\n            lightAngle = 52.5;\n            lightAnimation.type = 'BlitzBlurred Torch';\n            lightAnimation.blurStrength = 20;\n            lightAnimation.ratioDamper = 9;\n            lightAnimation.secondaryColor = '#e25822';\n            break;\n          case \"hooded-dim\":\n            dimLight = 0.1;\n            brightLight = 0;\n            lightAnimation.type = 'BlitzBlurred Torch';\n            lightAnimation.blurStrength = 1;\n            lightAnimation.ratioDamper = 1;\n            lightAnimation.secondaryColor = '#e25822';\n            break;\n          case \"hooded-bright\":\n            dimLight = 18;\n            brightLight = 9;\n            lightAnimation.type = 'BlitzBlurred Torch';\n            lightAnimation.blurStrength = 20;\n            lightAnimation.ratioDamper = 6;\n            lightAnimation.secondaryColor = '#e25822';\n            break;\n          case \"torch\":\n            dimLight = 12;\n            brightLight = 6;\n            lightAnimation.type = 'BlitzBlurred Torch';\n            lightAnimation.blurStrength = 20;\n            lightAnimation.ratioDamper = 3;\n            lightAnimation.secondaryColor = '#e25822';\n            break;\n          case \"light\":\n            dimLight = 12;\n            brightLight = 6;\n            lightAnimation.type = '';\n            lightColor = '';\n            lightAnimation.type = 'BlitzStatic Blur';\n            lightAnimation.blurStrength = 20;\n            break;\n          case \"nochange\":\n          default:\n            dimLight = token.data.dimLight;\n            brightLight = token.data.brightLight;\n            lightAngle = token.data.lightAngle;\n            lockRotation = token.data.lockRotation;\n            lightAlpha = token.data.lightAlpha\n            lightColor = token.data.lightColor\n            lightAnimation = token.data.lightAnimation\n        }\n        // Update Token\n        console.log(token);\n        token.update({\n          vision: true,\n          dimSight: dimSight,\n          brightSight: brightSight,\n          dimLight: dimLight,\n          brightLight: brightLight,\n          lightAngle: lightAngle,\n          lockRotation: lockRotation,\n          lightAlpha: lightAlpha,\n          lightColor: lightColor,\n          lightAnimation: lightAnimation\n        });\n      }\n    }\n  }\n}).render(true);","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/equipment/adventuring-gear/lantern.webp","actorIds":[]}
{"_id":"WsRMFiJovim61uRB","name":"Rage","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"pf2e":{"itemMacro":true},"combat-utility-belt":{"macroTrigger":""},"macro-marker":{"activeMacros":{"xnJokrkx8XTmogQ0":{"active":false}},"activeData":{"tooltip":"Rage          ","icon":"systems/pf2e/icons/features/classes/rage.jpg","module":"macro-marker","colour":"#000000","trigger":""},"markers":{"markers":{"xnJokrkx8XTmogQ0":false},"type":"Macro"}},"core":{"sourceId":"Macro.xnJokrkx8XTmogQ0"}},"scope":"global","command":"(async () => {\r\n  if (actor) {\r\n    if ((actor.data.data.customModifiers['ac'] || []).some(modifier => modifier.name === 'Rage')) {\r\n      MacroMarker.toggle(this)\r\n      await actor.removeCustomModifier('ac', 'Rage')\r\n      await actor.removeCustomModifier('damage', 'Rage')\r\n      /// Remove the line below if you do not wish for your character to lose all temp hp when toggled \"off\".\r\n      await actor.update({ 'data.attributes.hp.temp': 0 });\r\n      /// Remove the line above if you do not wish for your character to lose all temp hp when toggled \"off\".\r\n      if (token && token.data.effects.includes(\"systems/pf2e/icons/features/classes/rage.jpg\")) {\r\n        token.toggleEffect(\"systems/pf2e/icons/features/classes/rage.jpg\")\r\n      }\r\n      TokenMagic.deleteFilters(token)\r\n    } else {\r\n      MacroMarker.toggle(this)\r\n      game.pf2e.rollItemMacro(\"r6SglyLd3EN1buni\");\r\n      const tmpHP = (actor.data.data.details.level.value + actor.data.data.abilities.con.mod);\r\n      if (actor.data.data.attributes.hp.temp < tmpHP) {\r\n        await actor.update({ 'data.attributes.hp.temp': tmpHP });\r\n      }\r\n      await actor.addCustomModifier('ac', 'Rage', -1, 'untyped');\r\n      await actor.addCustomModifier('damage', 'Rage', 4, 'status');\r\n      if (token && !token.data.effects.includes(\"systems/pf2e/icons/features/classes/rage.jpg\")) {\r\n        token.toggleEffect(\"systems/pf2e/icons/features/classes/rage.jpg\")\r\n      }\r\n      TokenMagic.addFilters(token, [{\r\n        filterType: \"fire\",\r\n        intensity: 1,\r\n        color: 0xffffff,\r\n        amplitude: 1,\r\n        time: 0,\r\n        blend: 2,\r\n        fireBlend: 1,\r\n        animated:\r\n        {\r\n          time:\r\n          {\r\n            active: true,\r\n            speed: -0.0019,\r\n            animType: \"move\"\r\n          },\r\n          intensity:\r\n          {\r\n            active: true,\r\n            loopDuration: 15485,\r\n            val1: 1,\r\n            val2: 2,\r\n            animType: \"syncCosOscillation\"\r\n          },\r\n          amplitude:\r\n          {\r\n            active: true,\r\n            loopDuration: 4567,\r\n            val1: 0.2,\r\n            val2: 1,\r\n            animType: \"syncCosOscillation\"\r\n          }\r\n\r\n        }\r\n      }])\r\n    }\r\n  } else {\r\n    ui.notifications.warn(\"You must have an actor selected.\");\r\n  }\r\n})(); ","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/features/classes/rage.webp","actorIds":[]}
{"_id":"YZJBNllfNDiwYGIO","name":"Brumes","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"macro-marker":{"activeData":{"tooltip":"","icon":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false}},"scope":"global","command":"Hooks.call('switchWeather', {name: \"qFjGHbsQhb\", type: \"fog\", options: {density: 12, speed: 31, scale: 50}});","author":"amdu4xTh7PPZZgSP","img":"modules/fxmaster/icons/weather/fog.png","actorIds":[]}
{"_id":"dNMt867YwA8xNQIu","name":"Métamorphose sauvage","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"pf2e":{"itemMacro":true},"macro-marker":{"activeData":{"icon":"systems/pf2e/icons/spells/wild-morph.jpg","tooltip":"Métamorphose sauvage              ","colour":"#f7d488","trigger":""},"markers":{"markers":{"jVsOeaFwf1wnE1d2":false},"type":"Macro"}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.jVsOeaFwf1wnE1d2"}},"scope":"global","command":"if (actor) {\r\n    if (!MacroMarker.isActive(this)) {\r\n        MacroMarker.toggle(this)\r\n        game.pf2e.rollItemMacro(\"BdYbZpzEsRvvCgrK\")\r\n        if (token && !token.data.effects.includes(\"systems/pf2e/icons/spells/wild-morph.jpg\")) {\r\n            token.toggleEffect(\"systems/pf2e/icons/spells/wild-morph.jpg\")\r\n        }\r\n        TokenMagic.addFilters(token, [{\r\n            filterType: \"bevel\",\r\n            rotation: 0,\r\n            thickness: 4,\r\n            lightColor: 0x00FF00,\r\n            lightAlpha: 0.7,\r\n            shadowColor: 0xFF0000,\r\n            shadowAlpha: 0.4,\r\n            animated:\r\n            {\r\n                rotation:\r\n                {\r\n                    active: true,\r\n                    clockWise: true,\r\n                    loopDuration: 500,\r\n                    animType: \"syncRotation\"\r\n                }\r\n            }\r\n        }])\r\n    } else {\r\n        if (token && token.data.effects.includes(\"systems/pf2e/icons/spells/wild-morph.jpg\")) {\r\n            token.toggleEffect(\"systems/pf2e/icons/spells/wild-morph.jpg\")\r\n        }\r\n        MacroMarker.toggle(this)\r\n        TokenMagic.deleteFilters(token)\r\n    }\r\n}","author":"amdu4xTh7PPZZgSP","img":"systems/pf2e/icons/spells/wild-morph.webp","actorIds":[]}
{"_id":"hou1gAbUlx4YQ6of","name":"Jour","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.cuoDlTI2fxEzjOeI"}},"scope":"global","command":"canvas.scene.update({darkness: 0.0})","author":"amdu4xTh7PPZZgSP","img":"icons/sun-icon.jpg","actorIds":[]}
{"_id":"lMHjdoHydiLu89qt","name":"transformToken","permission":{"default":0,"amdu4xTh7PPZZgSP":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"placeTokenOnCanvas","colour":"#f7d488","trigger":""}},"core":{"sourceId":"Macro.peVKjyhQnxKdFfg2"}},"scope":"global","command":"// Arguments\n// TODO SET SAME SCENE AS PLAYER\nconst originalToken = canvas.tokens.placeables.find(t => t.id === args[0])\nlet newToken = game.actors.get(args[1]).data.token\nconst newTokenName = args[2]\n\n// Place a creature token on the canvas instead and delete the original token\nnewToken.x = originalToken.x\nnewToken.y = originalToken.y\nlet id = originalToken.actor.data._id\n\nToken.create(newToken).then(c => {\n    let toUpdate;\n    console.log(originalToken)\n    if (originalToken.data.flags && originalToken.data.flags.transformationFrom) {\n        toUpdate = {\n            actorLink: true\n        }\n    } else {\n        toUpdate = {\n            name: newTokenName,\n            actorLink: false,\n            flags: {\n                transformationFrom: id\n            }\n        }\n    }\n\n    c.update(toUpdate).then((t) => {\n        if (game.combats && game.combats.size > 0) {\n            game.combats.forEach(c => {\n                let combatant = c.getCombatantByToken(originalToken.id)\n                if (combatant) {\n                    let round = c.round\n                    let turn = c.turn\n                    c.createCombatant({\n                        tokenId: t.data._id,\n                        active: combatant.active,\n                        hidden: combatant.hidden,\n                        initiative: combatant.initiative,\n                        hasRolled: combatant.hasRolled,\n                        visible: combatant.visible\n                    }).then(() => {\n                        setTimeout(() => {\n                            if (c.started) c.update({ round: round, turn: turn })        \n                        }, 200);\n                    })\n                }\n            })\n        }\n\n        originalToken.delete()\n    })\n})","author":"amdu4xTh7PPZZgSP","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Création de gabarits","type":"script","author":"amdu4xTh7PPZZgSP","img":"icons/template.jpg","scope":"global","command":"let applyChanges = false\nnew Dialog({\n  title: `Création de gabarits pour PF2`,\n  content: `\n    <style>\n      #pf2-template-creator header {\n        border-radius: 0;\n        background: linear-gradient(90deg, var(--secondary) 0%, #202b93 50%, var(--secondary) 100%);\n        border: none;\n        box-shadow: inset 0 0 0 1px #9f725b,inset 0 0 0 2px var(--tertiary),inset 0 0 0 3px #956d58;\n        margin-bottom: 2px;\n        font-size: .75rem;\n      }\n      #pf2-template-creator .window-content {\n        background-image: url(systems/pf2e/assets/sheet/red_bg.webp);\n        background-size: cover;\n        padding: 9px;\n        background-origin: border-box;\n        color: #ffefbd;\n        border-width: 9px;\n        border-image: url(systems/pf2e/assets/sheet/corner-box.webp) 9 repeat;\n        border-style: solid;\n        border-image-outset: 0;\n      }\n      #pf2-template-creator form {\n        margin-bottom: 20px;\n      }\n      #pf2-template-creator .form-fields.buttons {\n        justify-content: flex-start !important;\n      }\n      #pf2-template-creator .button {\n        flex: 1 !important;\n        border-width: 9px;        \n        border-image: url(systems/pf2e/assets/sheet/corner-box.webp) 9 repeat;\n        font-size: 12px;\n        padding: 0;\n        background: #171f69;\n        color: #ffefbd;\n        cursor: pointer;\n      }\n      #pf2-template-creator .button:hover {\n        box-shadow: 0 0 8px white;\n      }\n      #pf2-template-creator .radios input[type=\"radio\"] {\n        opacity: 0;\n        position: fixed;\n        width: 0;\n      }\n      #pf2-template-creator .radios label {\n        cursor: pointer;\n        display: flex;\n        flex: 1 !important;\n        margin: -2px 0;\n        background: rgba(0, 0, 0, 0.1);\n        border: 2px groove #f0f0e0;\n        width: 100%;\n        border-radius: 3px;\n        font-size: 13px;\n        font-family: \"Signika\", sans-serif;\n        justify-content: center;\n        align-items: center;\n        background: #171f69;\n        color: #ffefbd;\n        border-width: 9px;\n        border-image: url(systems/pf2e/assets/sheet/corner-box.webp) 9 repeat;\n      }\n      #pf2-template-creator .radios label i {\n        margin-right: 5px;\n        color: #ffefbd;\n        background: #171f69;\n      }\n      #pf2-template-creator .radios label:hover {\n        box-shadow: 0 0 8px white;\n      }\n      #pf2-template-creator .radios input[type=\"radio\"]:checked + label {\n        background: rgba(0, 0, 0, 0.2);\n      }\n      #pf2-template-creator .dialog-buttons {\n        align-items: flex-end;\n      }\n      #pf2-template-creator .dialog-button {\n        height: 50px;\n        background: #171f69;\n        border-image: url(systems/pf2e/assets/sheet/corner-box.webp) 9 repeat;\n        color: #ffefbd;\n        border-width: 9px;\n        display: inline-flex;\n        justify-content: space-evenly;\n        align-items: center;\n        cursor: pointer;\n      }\n      #pf2-template-creator .notes {\n        color: #ffefbd !important;\n        flex: 0 0 100% !important;\n        font-size: 12px !important;\n        line-height: 16px !important;\n        margin: 10px 0 5px 0 !important;\n      }\n      #pf2-template-creator .notes.title {\n        border-bottom: 1px solid #f7d488;\n        font-size: 14px !important;\n        font-weight: bold;\n        margin: 20px 0 10px 0 !important;\n      }\n    </style>\n    <form>\n      <div class=\"form-group\">\n        <p class=\"notes title\">Type de gabarit :</p>\n        <div class=\"form-fields buttons radios\">\n          <input type=\"radio\" name=\"shape\" id=\"emanation\" value=\"emanation\" checked>\n          <label for=\"emanation\" onclick=\"toggleEmanationMessage(true)\"><i class=\"fas fa-dot-circle\"></i> Émanation</label>\n          <input type=\"radio\" name=\"shape\" id=\"burst\" value=\"burst\">\n          <label for=\"burst\" onclick=\"toggleEmanationMessage(false)\"><i class=\"fas fa-circle\"></i> Explosion</label>\n          <input type=\"radio\" name=\"shape\" id=\"cone\" value=\"cone\">\n          <label for=\"cone\" onclick=\"toggleEmanationMessage(false)\"><i class=\"fas fa-wifi\"></i> Cône</label>\n          <input type=\"radio\" name=\"shape\" id=\"line\" value=\"line\">\n          <label for=\"line\" onclick=\"toggleEmanationMessage(false)\"><i class=\"fas fa-ruler-horizontal\"></i> Ligne</label>\n        </div>\n      </div>\n\n      <div class=\"notes\" id=\"emanation-message\">\n        ${token ? `\n          ➡️ L'émanation va être automatiquement positionnée sur le token sélectionné : ${token.data.name}.<br>\n          ${game[\"modules\"].has(\"token-attacher\") ? `➡️ Le gabarit suivra le mouvement du token.` : `⚠️ Pour que le gabarit suive automatiquement le mouvement du token, veuillez installer et activer le module \"Token-attacher\".` }\n        ` : `\n          ➡️ Pour automatiqment positionner l'émanation sur un token, veuillez relancer la macro avec un token sélectionné.\n        ` }\n      </div>\n\n      <div class=\"form-group\">\n        <p class=\"notes title\">Valeurs prédéfinies :</p>\n        <div class=\"form-fields buttons\">\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(1.5)\">1.5 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(3)\">3 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(4.5)\">4.5 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(6)\">6 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(9)\">9 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(18)\">18 m</button>\n          <button type=\"button\" class=\"button\" onclick=\"updateRadiusValue(36)\">36 m</button>\n        </div>\n      </div>\n\n      <div class=\"form-group\">\n      <p class=\"notes title\">Rayon du gabarit en mètres :</p>\n      <div class=\"form-fields\">\n        <input type=\"range\" id=\"radius\" name=\"radius\" value=\"1.5\" min=\"1.5\" max=\"36\" step=\"0.5\" oninput=\"updateRangeValue(this.value);\">\n        <span id=\"range-value\" class=\"range-value\">1.5</span>\n      </div>\n      </div>\n    </form>\n    <script>\n      function toggleEmanationMessage (isVisible) {\n        document.getElementById(\"emanation-message\").style.display = isVisible ? \"block\" : \"none\"\n      }\n      function updateRadiusValue(val) {\n        document.getElementById(\"radius\").value = val\n        updateRangeValue(val)\n      }\n      function updateRangeValue(val) {\n        document.getElementById(\"range-value\").innerHTML = val\n      }\n    </script>\n  `,\n  buttons: {\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: `Annuler`\n    },\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: `Appliquer`,\n      callback: () => applyChanges = true\n    }\n  },\n  default: \"yes\",\n  close: async html => {\n    if (applyChanges) {\n\n      // Template settings\n      const templateData = {\n        user: game.user._id,\n        distance: parseFloat(html.find('[name=\"radius\"]')[0].value),\n        direction: 0,\n        x: 0,\n        y: 0,\n        fillColor: game.user.color\n      }\n\n      let templateShape = html.find('[name=\"shape\"]')\n      for (var i = 0, length = templateShape.length; i < length; i++) {\n        if (templateShape[i].checked) {\n          templateShape = templateShape[i].value\n          break\n        }\n      }\n\n      switch (templateShape) {\n        case \"cone\":\n          templateData.t = \"cone\"\n          templateData.angle = 90\n          break\n        case \"emanation\":\n          templateData.t = \"circle\"\n          break\n        case \"line\":\n          templateData.t = \"ray\"\n          templateData.width = 1.5\n          break\n        case \"burst\":\n          templateData.t = \"circle\"\n          break\n        default:\n          break\n      }\n\n      const measuredTemplate = new MeasuredTemplate(new MeasuredTemplateDocument(templateData, { parent: canvas.scene }))\n\n      // If emanation shape then place template on token if token is selected\n      if (token && templateShape === \"emanation\") {\n        const topleft = canvas.grid.getTopLeft(token.x, token.y)\n        measuredTemplate.data.update({x: topleft[0] + (canvas.scene.data.grid * token.data.width / 2), y: topleft[1] + (canvas.scene.data.grid * token.data.width / 2)})\n\n        if (token.data.width && token.data.width > 1) {\n          measuredTemplate.data.update({distance: measuredTemplate.data.distance + token.data.width / 2 * 1.5})\n        }\n\n        canvas.scene.createEmbeddedDocuments(\"MeasuredTemplate\", [measuredTemplate.data]).then(template => {\n          // If token-attacher is installed and activated, stick the template to the token\n          if (game[\"modules\"].has(\"token-attacher\")) {\n            template = canvas.templates.get(template[0].data._id)\n            tokenAttacher.attachElementToToken(template, token, true)\n          }\n        });\n      } else {\n        // Else prepare layer for preview\n        const highlighterName = 'Preview.' + Math.random().toString(36).substr(2, 9)\n        const highlighter = canvas.grid.addHighlightLayer(highlighterName)\n        const initialLayer = canvas.activeLayer\n        measuredTemplate.draw()\n        measuredTemplate.layer.activate()\n        measuredTemplate.layer.preview.addChild(measuredTemplate)\n\n        // Calculate the shape position\n        function getTemplatePosition(event) {\n          const center = event.data.getLocalPosition(measuredTemplate.layer)\n\n          if (templateShape === \"emanation\" || templateShape === \"line\") {\n            const shapeCenter = canvas.grid.getCenter(center.x, center.y)\n            return { x: shapeCenter[0], y: shapeCenter[1] }\n          } else if (templateShape === \"burst\") {\n            return canvas.grid.getSnappedPosition(center.x, center.y, 1)\n          } else if (templateShape === \"cone\") {\n            let shift = 0\n            const shapePosition = canvas.grid.getSnappedPosition(center.x, center.y, 2)\n            const centerPosition = canvas.grid.getCenter(shapePosition.x, shapePosition.y)\n            if (shapePosition.x === centerPosition[0] && shapePosition.y === centerPosition[1]) {\n              shapePosition.x += canvas.dimensions.size / 2\n            }\n            return shapePosition\n          } else {\n            return canvas.grid.getSnappedPosition(center.x, center.y, 2)\n          }\n        }\n\n        /*\n        ----------- THX TO PF2 SYSTEM CREATOR FOR THIS CODE. --------------\n        */\n\n        // Calculate the highlight\n        function highlightGrid() {\n          const grid = canvas.grid,\n            d = canvas.dimensions,\n            bc = \"0x000000\",\n            fc = measuredTemplate.data.fillColor.replace('#', '0x')\n\n          // Clear existing highlight\n          canvas.grid.clearHighlightLayer(highlighterName)\n          if ([\"circle\", \"cone\"].includes(measuredTemplate.data.t)) {\n            // Get number of rows and columns\n            let nr = Math.ceil(((measuredTemplate.data.distance * 1.5) / d.distance) / (d.size / grid.h)),\n              nc = Math.ceil(((measuredTemplate.data.distance * 1.5) / d.distance) / (d.size / grid.w))\n\n            // Get the center of the grid position occupied by the template\n            let x = measuredTemplate.data.x,\n              y = measuredTemplate.data.y\n\n            let [cx, cy] = grid.getCenter(x, y),\n              [col0, row0] = grid.grid.getGridPositionFromPixels(cx, cy),\n              minAngle = (360 + ((measuredTemplate.data.direction - measuredTemplate.data.angle * 0.5) % 360)) % 360,\n              maxAngle = (360 + ((measuredTemplate.data.direction + measuredTemplate.data.angle * 0.5) % 360)) % 360\n\n            const within_angle = function (min, max, value) {\n              min = (360 + min % 360) % 360\n              max = (360 + max % 360) % 360\n              value = (360 + value % 360) % 360\n\n              if (min < max) return (value >= min && value <= max)\n              return (value >= min || value <= max)\n            }\n\n            const measureDistance = function (p0, p1) {\n              let gs = canvas.dimensions.size,\n                ray = new Ray(p0, p1),\n                // How many squares do we travel across to get there? If 2.3, we should count that as 3 instead of 2; hence, Math.ceil\n                nx = Math.ceil(Math.abs(ray.dx / gs)),\n                ny = Math.ceil(Math.abs(ray.dy / gs))\n\n              // Get the number of straight and diagonal moves\n              let nDiagonal = Math.min(nx, ny),\n                nStraight = Math.abs(ny - nx)\n\n              // Diagonals in PF pretty much count as 1.5 times a straight\n              let distance = Math.floor(nDiagonal * 1.5 + nStraight)\n              let distanceOnGrid = distance * canvas.dimensions.distance\n              return distanceOnGrid\n            }\n\n            const degtorad = function (degrees) {\n              return degrees * Math.PI / 180\n            }\n\n            let originOffset = { x: 0, y: 0 }\n            // Offset measurement for cones\n            // Offset is to ensure that cones only start measuring from cell borders, as in https://www.d20pfsrd.com/magic/#Aiming_a_Spell\n            if (measuredTemplate.data.t === \"cone\") {\n              // Degrees anticlockwise from pointing right. In 45-degree increments from 0 to 360\n              const dir = (measuredTemplate.data.direction >= 0 ? 360 - measuredTemplate.data.direction : -measuredTemplate.data.direction) % 360\n              // If we're not on a border for X, offset by 0.5 or -0.5 to the border of the cell in the direction we're looking on X axis\n              let xOffset = measuredTemplate.data.x % d.size != 0 ?\n                Math.sign(1 * (Math.round(Math.cos(degtorad(dir)) * 100)) / 100) / 2 // /2 turns from 1/0/-1 to 0.5/0/-0.5\n                : 0\n              // Same for Y, but cos Y goes down on screens, we invert\n              let yOffset = measuredTemplate.data.y % d.size != 0 ?\n                -Math.sign(1 * (Math.round(Math.sin(degtorad(dir)) * 100)) / 100) / 2\n                : 0\n              originOffset.x = xOffset\n              originOffset.y = yOffset\n            }\n\n            // Point we are measuring distances from\n            let origin = {\n              x: measuredTemplate.data.x + (originOffset.x * d.size),\n              y: measuredTemplate.data.y + (originOffset.y * d.size)\n            }\n\n            for (let a = -nc; a < nc; a++) {\n              for (let b = -nr; b < nr; b++) {\n                // Position of cell's top-left corner, in pixels\n                let [gx, gy] = canvas.grid.grid.getPixelsFromGridPosition(col0 + a, row0 + b)\n                // Position of cell's center, in pixels\n                let [cellCenterX, cellCenterY] = [gx + d.size * 0.5, gy + d.size * 0.5]\n\n                // Determine point of origin\n                let origin = { x: measuredTemplate.data.x, y: measuredTemplate.data.y }\n                origin.x += (originOffset.x * d.size)\n                origin.y += (originOffset.y * d.size)\n\n                let ray = new Ray(origin, { x: cellCenterX, y: cellCenterY })\n\n                let rayAngle = (360 + (ray.angle / (Math.PI / 180)) % 360) % 360\n                if (measuredTemplate.data.t === \"cone\" && ray.distance > 0 && !within_angle(minAngle, maxAngle, rayAngle)) {\n                  continue\n                }\n\n                // Determine point we're measuring the distance to - always in the center of a grid square\n                let destination = { x: cellCenterX, y: cellCenterY }\n\n                let distance = measureDistance(destination, origin)\n                if (distance <= measuredTemplate.data.distance) {\n                  grid.grid.highlightGridPosition(highlighter, { x: gx, y: gy, color: fc, border: bc })\n                }\n              }\n            }\n          } else {\n            /*\n            ----------- THX TO FOUNDRY CREATOR FOR THIS CODE FROM CORE FOUNDRY. --------------\n            */\n            // Get number of rows and columns\n            const nr = Math.ceil(((measuredTemplate.data.distance * 1.5) / d.distance) / (d.size / grid.h));\n            const nc = Math.ceil(((measuredTemplate.data.distance * 1.5) / d.distance) / (d.size / grid.w));\n            // Get the offset of the template origin relative to the top-left grid space\n            const [tx, ty] = canvas.grid.getTopLeft(measuredTemplate.data.x, measuredTemplate.data.y);\n            const [row0, col0] = grid.grid.getGridPositionFromPixels(tx, ty);\n            const hx = canvas.grid.w / 2;\n            const hy = canvas.grid.h / 2;\n            const isCenter = (measuredTemplate.data.x - tx === hx) && (measuredTemplate.data.y - ty === hy);\n            // Identify grid coordinates covered by the template Graphics\n            for (let r = -nr; r < nr; r++) {\n              for (let c = -nc; c < nc; c++) {\n                let [gx, gy] = canvas.grid.grid.getPixelsFromGridPosition(row0 + r, col0 + c);\n                const testX = (gx + hx) - measuredTemplate.data.x;\n                const testY = (gy + hy) - measuredTemplate.data.y;\n                let contains = ((r === 0) && (c === 0) && isCenter) || measuredTemplate.shape.contains(testX, testY);\n                if (!contains) continue;\n                grid.grid.highlightGridPosition(highlighter, { x: gx, y: gy, color: fc, border: bc });\n              }\n            }\n          }\n        }\n\n        /*\n        ----------- THX TO FOUNDRY CREATOR FOR THIS CODE FROM DND 5. --------------\n        */\n\n        // Preview handlers\n        const handlers = {}\n        let moveTime = 0\n\n        // Update placement (mouse-move)\n        handlers.mm = event => {\n          event.stopPropagation()\n          let now = Date.now() // Apply a 20ms throttle\n          if (now - moveTime <= 20) return\n          const snapped = getTemplatePosition(event)\n          measuredTemplate.data.update(snapped)\n          measuredTemplate.refresh()\n          highlightGrid()\n          moveTime = now\n        }\n\n        // Cancel the workflow (right-click)\n        handlers.rc = event => {\n          canvas.grid.destroyHighlightLayer(highlighterName)\n          measuredTemplate.layer.preview.removeChildren()\n          canvas.stage.off(\"mousemove\", handlers.mm)\n          canvas.stage.off(\"mousedown\", handlers.lc)\n          canvas.app.view.oncontextmenu = null\n          canvas.app.view.onwheel = null\n          initialLayer.activate()\n        }\n\n        // Confirm the workflow (left-click)\n        handlers.lc = event => {\n          handlers.rc(event)\n\n          const destination = getTemplatePosition(event)\n          measuredTemplate.data.update(destination)\n\n          canvas.scene.createEmbeddedDocuments(\"MeasuredTemplate\", [measuredTemplate.data]);\n        }\n\n        // Rotate the template by 3 degree increments (mouse-wheel)\n        handlers.mw = event => {\n          if (event.ctrlKey) event.preventDefault()\n          event.stopPropagation()\n          let delta = canvas.grid.type > CONST.GRID_TYPES.SQUARE ? 30 : 15\n          let snap = event.shiftKey ? delta : 5\n          measuredTemplate.data.update({ direction: measuredTemplate.data.direction + (snap * Math.sign(event.deltaY))});\n          measuredTemplate.refresh()\n          highlightGrid()\n        }\n\n        // Activate listeners\n        canvas.stage.on(\"mousemove\", handlers.mm)\n        canvas.stage.on(\"mousedown\", handlers.lc)\n        canvas.app.view.oncontextmenu = handlers.rc\n        canvas.app.view.onwheel = handlers.mw\n      }\n    }\n  }\n}, {\n  id: 'pf2-template-creator'\n}).render(true)","folder":null,"sort":0,"permission":{"default":3,"amdu4xTh7PPZZgSP":3},"flags":{"macro-marker":{"activeData":{"tooltip":"Création de gabarits","icon":"icons/template.jpg","colour":"#000000","trigger":"","module":"macro-marker"}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.C3VYjDnK0LyPdsd4"}},"_id":"tI6ICoXKMWMx3TJw"}
