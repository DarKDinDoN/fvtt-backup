var R=Object.defineProperty;var w=(O,T)=>R(O,"name",{value:T,configurable:!0});(()=>{"use strict";var O={},T={};function l(i){var e=T[i];if(e!==void 0)return e.exports;var t=T[i]={exports:{}};return O[i].call(t.exports,t,t.exports,l),t.exports}w(l,"__webpack_require__"),l.m=O,(()=>{var i=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,e;l.t=function(t,a){if(a&1&&(t=this(t)),a&8||typeof t=="object"&&t&&(a&4&&t.__esModule||a&16&&typeof t.then=="function"))return t;var s=Object.create(null);l.r(s);var r={};e=e||[null,i({}),i([]),i(i)];for(var n=a&2&&t;typeof n=="object"&&!~e.indexOf(n);n=i(n))Object.getOwnPropertyNames(n).forEach(c=>r[c]=()=>t[c]);return r.default=()=>t,l.d(s,r),s}})(),l.d=(i,e)=>{for(var t in e)l.o(e,t)&&!l.o(i,t)&&Object.defineProperty(i,t,{enumerable:!0,get:e[t]})},l.f={},l.e=i=>Promise.all(Object.keys(l.f).reduce((e,t)=>(l.f[t](i,e),e),[])),l.u=i=>""+{348:"worker",736:"vendor"}[i]+".js",l.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch{if(typeof window=="object")return window}}(),l.o=(i,e)=>Object.prototype.hasOwnProperty.call(i,e),(()=>{var i={},e="@elvispereira/nameforge:";l.l=(t,a,s,r)=>{if(i[t]){i[t].push(a);return}var n,c;if(s!==void 0)for(var m=document.getElementsByTagName("script"),d=0;d<m.length;d++){var o=m[d];if(o.getAttribute("src")==t||o.getAttribute("data-webpack")==e+s){n=o;break}}n||(c=!0,n=document.createElement("script"),n.charset="utf-8",n.timeout=120,l.nc&&n.setAttribute("nonce",l.nc),n.setAttribute("data-webpack",e+s),n.src=t),i[t]=[a];var f=w((p,u)=>{n.onerror=n.onload=null,clearTimeout(g);var y=i[t];if(delete i[t],n.parentNode&&n.parentNode.removeChild(n),y&&y.forEach(M=>M(u)),p)return p(u)},"onScriptComplete"),g=setTimeout(f.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=f.bind(null,n.onerror),n.onload=f.bind(null,n.onload),c&&document.head.appendChild(n)}})(),l.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},l.p="/modules/nameforge/dist/",(()=>{l.b=document.baseURI||self.location.href;var i={426:0};l.f.j=(a,s)=>{var r=l.o(i,a)?i[a]:void 0;if(r!==0)if(r)s.push(r[2]);else{var n=new Promise((o,f)=>r=i[a]=[o,f]);s.push(r[2]=n);var c=l.p+l.u(a),m=new Error,d=w(o=>{if(l.o(i,a)&&(r=i[a],r!==0&&(i[a]=void 0),r)){var f=o&&(o.type==="load"?"missing":o.type),g=o&&o.target&&o.target.src;m.message="Loading chunk "+a+` failed.
(`+f+": "+g+")",m.name="ChunkLoadError",m.type=f,m.request=g,r[1](m)}},"loadingEnded");l.l(c,d,"chunk-"+a,a)}};var e=w((a,s)=>{var[r,n,c]=s,m,d,o=0;if(r.some(g=>i[g]!==0)){for(m in n)l.o(n,m)&&(l.m[m]=n[m]);if(c)var f=c(l)}for(a&&a(s);o<r.length;o++)d=r[o],l.o(i,d)&&i[d]&&i[d][0](),i[d]=0},"webpackJsonpCallback"),t=self.webpackChunk_elvispereira_nameforge=self.webpackChunk_elvispereira_nameforge||[];t.forEach(e.bind(null,0)),t.push=e.bind(null,t.push.bind(t))})();var x={};class b{prepareData(e){if(!e||e?.length===0)throw new Error("Provided list don't contain any names.");const t=[...new Set(e.toLowerCase().split(","))].sort();if(t.length===1)throw new Error("The list is too short");return t.map(a=>a.trim())}async createModel(e={path:null,json:null}){const{recurrent:t}=await l.e(736).then(l.t.bind(l,291,19)),a=new t.LSTM({activation:"tanh"});if(e.path){const s=await fetch(e.path);return s.ok?(a.fromJSON(await s.json()),a):null}return e.json&&a.fromJSON(JSON.parse(e.json)),a}trainModel(e,t,a={}){const s={iterations:500,errorThreshold:.1,callback:null,callbackPeriod:10,learningRate:.01,timeout:"Infinity",...a},r=t.train(e,s);return console.info(`Training completed after ${r.iterations} iterations, loss ${r.error}`),t}static async getModels(){const e={userModels:null,defaultModels:null},t=await fetch("nameforge-models/models.json"),a=await fetch("modules/nameforge/models/models.json");return t.ok&&(e.userModels=await t.json()),a.ok&&(e.defaultModels=await a.json()),e}static filterModels(e){return{userModels:{names:Object.values(e.userModels).filter(t=>!t?.type||t?.type==="name"),surnames:Object.values(e.userModels).filter(t=>t?.type==="surname")},defaultModels:{names:Object.values(e.defaultModels).filter(t=>!t?.type||t?.type==="name"),surnames:Object.values(e.defaultModels).filter(t=>t?.type==="surname")}}}selectRandom(e){const t=e.map(r=>{const n=r?.weight??1;return{value:r,weight:n}}),a=t.reduce((r,n)=>r+Number(n.weight),0);let s=Math.random()*a;for(let r=0;r<t.length;r++){const n=t[r];if(s<n.weight)return n.value;s-=n.weight}}capitalize(e,t=game.i18n.lang){const[a,...s]=e;return a===void 0?"":a.toLocaleUpperCase(t)+s.join("")}generateName(e,t={}){const a={count:1,original:!1,seed:"",temperature:1,...t},s=e.options.dataFormatter.values;if((a.temperature<=0||isNaN(a.temperature))&&(a.temperature=1),a.count>1){const n=new Set;for(;n.size<a.count;)a.original?(a.count>s.length&&(a.count=s.length),n.add(this.capitalize(this.selectRandom(s)))):n.add(this.capitalize(a.seed+e.run(a.seed.toLowerCase(),!0,a.temperature)));return Array.from(n)}return a.original?[this.capitalize(this.selectRandom(s))]:[this.capitalize(a.seed+e.run(a.seed.toLowerCase(),!0,a.temperature))]}generateFullName(e,t,a={name:{},surname:{}}){const s={name:{count:1,original:!1,seed:"",temperature:1,...a.name},surname:{count:1,original:!1,seed:"",temperature:1,...a.surname}};return this.generateName(e,s.name).map(c=>{const m=Math.round(Math.random()*(s.surname.count-1)+1),d=this.generateName(t,{...s.surname,count:m});return`${c} ${d.join(" ")}`})}}w(b,"NameForge");class F extends Application{constructor(e=!1){super(),this.sheet=e}encodeName(e){return e.toLowerCase().replace(/\s/g,"-").replace(/[^a-z0-9_-]/g,"")}addNames(e,t,a){e.replaceChildren(),t.forEach(s=>{const r=document.createElement("a");if(r.classList="nf-tag",r.innerText=s,!this.sheet)r.addEventListener("click",()=>{navigator.clipboard.writeText(r.innerText),ui.notifications.info(game.i18n.localize("NAMEFORGE.GENERATE.clipboard"))});else if(this.sheet){const n=this.sheet.actor;r.addEventListener("click",async()=>{const c=a==="surname"?`${n.name} ${s}`:s;await n.update({name:c}),ui.notifications.info(game.i18n.localize("NAMEFORGE.GENERATE.actorUpdated"))})}e.appendChild(r)})}async addNameChanger(e,t,a){const s=this.encodeName(a.name);await t.setFlag("nameforge","models",{...t.getFlag("nameforge","models"),[s]:a});const r=document.createElement("a");r.classList="nf-tag",r.innerText=a.name,r.id=s,r.addEventListener("click",async()=>await this.removeNameChanger(t,r));const n=e.querySelector(`#${r.id}`);n&&n.remove(),e.appendChild(r)}async removeNameChanger(e,t){const a=e.getFlag("nameforge","models");delete a[t.id],await e.unsetFlag("nameforge","models"),await e.setFlag("nameforge","models",a),t.remove()}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/nameforge/templates/generate-names.hbs",e.width=800,e.resizable=!0,e.title=game.i18n.localize("NAMEFORGE.TITLE.generate"),e}async getData(){return{actor:this.sheet?this.sheet.actor:!1,config:game.settings.get("nameforge","defaultConfig"),models:b.filterModels(game.modules.get("nameforge").models),show:{seed:!0,temperature:!0,count:!0,weight:this.sheet}}}async activateListeners(e){const t=e[0].querySelector("#names"),a=e[0].querySelector("#nameChangers"),s=e[0].querySelector('p[name="original"]'),r=e[0].querySelector("#nameforge");if(this.sheet){const n=this.sheet.actor,c=n.getFlag("nameforge","models"),m=document.createElement("a");m.classList="nf-tag",m.innerText=n.name,m.addEventListener("click",async()=>await n.update({name:m.innerText})),s.appendChild(m);for(const d in c){const o=document.createElement("a");o.classList="nf-tag",o.innerText=c[d].name,o.id=d,o.addEventListener("click",async()=>await this.removeNameChanger(n,o)),a.appendChild(o)}}r.addEventListener("submit",async n=>{await n.preventDefault();const c=new b,m=n.submitter.name,d=new FormData(r),o={name:{model:d.get("nameModel"),count:d.get("nameCount"),seed:d.get("nameSeed"),temperature:d.get("nameTemperature"),weight:d.get("nameWeight"),original:r.querySelector('input[name="nameOriginal"]').checked},surname:{model:d.get("surnameModel"),count:d.get("surnameCount"),seed:d.get("surnameSeed"),temperature:d.get("surnameTemperature"),weight:d.get("surnameWeight"),original:r.querySelector('input[name="surnameOriginal"]').checked}},f=r.querySelector('select[name="nameModel"]'),g=r.querySelector('select[name="surnameModel"]'),p={name:f.options[f.selectedIndex].text,surname:g.options[g.selectedIndex].text};if(o.name.model==="none"^o.surname.model==="none"){const u=o.name.model!=="none"?"name":"surname",y={count:o[u].count,original:o[u].original,seed:o[u].seed,temperature:o[u].temperature};if(m==="generate"){const M=await c.createModel({path:o[u].model}),N=c.generateName(M,y);this.addNames(t,N,u)}else m==="add"&&this.addNameChanger(a,this.sheet.actor,{name:p[u],model:o[u].model,options:y,type:u,weight:o[u].weight})}else if(o.name.model!=="none"&&o.surname.model!=="none"){const u={name:{count:o.name.count,seed:o.name.seed,temperature:o.name.temperature},surname:{count:o.surname.count,seed:o.surname.seed,temperature:o.surname.temperature}};if(m==="generate"){const y=await c.createModel({path:o.name.model}),M=await c.createModel({path:o.surname.model}),N=c.generateFullName(y,M,u);this.addNames(t,N,"fullName")}else m==="add"&&this.addNameChanger(a,this.sheet.actor,{name:`${p.name}/${p.surname}`,model:{name:o.name.model,surname:o.surname.model},options:u,type:"fullName",weight:o.name.weight})}super.setPosition({height:"auto"})})}}w(F,"GenerateApplication");class C extends Application{async saveModel(e,t,a){const s=e.toLowerCase().replace(/\s/g,"-").replace(/[^a-z0-9_-]/g,""),n=await(await fetch("nameforge-models/models.json")).json();n[s]={name:e,path:`nameforge-models/${s}.json`,type:a},await FilePicker.upload("data","nameforge-models",new File([t],`${s}.json`,{type:"application/json"}),{},{notify:!1}),await FilePicker.upload("data","nameforge-models",new File([JSON.stringify(n,null,2)],"models.json",{type:"application/json"})),game.modules.get("nameforge").models.userModels[s]={name:e,path:`nameforge-models/${s}.json`,type:a}}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/nameforge/templates/train-model.hbs",e.width=600,e.resizable=!0,e.title=game.i18n.localize("NAMEFORGE.TITLE.train"),e}activateListeners(e){const t=e[0].querySelector("#train-model"),a=e[0].querySelector('#train-model button[name="train"]'),s=e[0].querySelector('#train-model button[name="stop"]'),r=e[0].querySelector("#results"),n=e[0].querySelector("#results p"),c=document.createElement("progress");c.classList="nf-progress",t.addEventListener("submit",async m=>{await m.preventDefault(),a.disabled=!0,s.disabled=!1;const d=Object.fromEntries(new FormData(t).entries()),{modelName:o,errorThreshold:f,iterations:g,learningRate:p,timeout:u,trainingData:y,type:M}=d,N={...u>0&&{timeout:u*6e4},...g>0&&{iterations:g},...p>=0&&p<=1&&{learningRate:p},...f>=0&&f<=1&&{errorThreshold:f}};c.max=g-1,r.append(c);const S=new Worker(new URL(l.p+l.u(348),l.b));s.addEventListener("click",async()=>{S.terminate(),await this.saveModel(o,E.model,M),a.disabled=!1,s.disabled=!0});const E={number:0,error:1,model:null},_=new b;S.postMessage({name:"train",options:N,names:y}),S.onmessage=async v=>{const{name:A,details:j,model:P}=v.data;if(A==="progress"&&(c.value=j.iterations,j.error<E.error)){E.iteration=j.iterations,E.error=j.error,E.model=await _.createModel({json:P});const z=_.generateName(E.model,{count:5});n.innerText=`Best iteration (${E.iteration}) -> Loss: ${E.error.toPrecision(2)} | ${z.join(", ")}`}A==="complete"&&(await this.saveModel(o,P,M),a.disabled=!1,s.disabled=!0)},S.onerror=v=>{throw console.log(`Worker error: ${v.message}`),v},super.setPosition({height:"auto"})})}}w(C,"TrainApplication");class L extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.closeOnSubmit=!1,e.template="modules/nameforge/templates/config-menu.hbs",e.width=600,e.resizable=!0,e.title=game.i18n.localize("NAMEFORGE.TITLE.config"),e}async getData(){return{config:game.settings.get("nameforge","defaultConfig"),models:b.filterModels(game.modules.get("nameforge").models),show:{seed:!1,temperature:!0,count:!0,weight:!1}}}async _updateObject(e,t){if(e.type==="submit"){const a={name:{model:t.nameModel,count:t.nameCount,temperature:t.nameTemperature,original:t.nameOriginal},surname:{model:t.surnameModel,count:t.surnameCount,temperature:t.surnameTemperature,original:t.surnameOriginal}};game.settings.set("nameforge","defaultConfig",a),ui.notifications.info(game.i18n.localize("NAMEFORGE.SETTINGS.saved"))}}}w(L,"ConfigMenu");class k extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.closeOnSubmit=!1,e.template="modules/nameforge/templates/upload-menu.hbs",e.width=600,e.resizable=!0,e.title=game.i18n.localize("NAMEFORGE.TITLE.upload"),e}async _updateObject(e,t){if(e.type==="submit"){const a=e.currentTarget[2].files[0],s=t.name.toLowerCase().replace(/\s/g,"-").replace(/[^a-z0-9_-]/g,""),n=await(await fetch("nameforge-models/models.json")).json();n[s]={name:t.name,path:`nameforge-models/${a.name}`,type:t.type},await FilePicker.upload("data","nameforge-models",a),await FilePicker.upload("data","nameforge-models",new File([JSON.stringify(n,null,2)],"models.json",{type:"application/json"}),{},{notify:!1}),game.modules.get("nameforge").models.userModels[a.name]={name:t.name,path:`nameforge-models/${a.name}`,type:t.type}}}}w(k,"UploadMenu");const h=new b;Hooks.once("init",()=>{game.settings.register("nameforge","defaultConfig",{scope:"client",config:!1,requiresReload:!1,type:Object,default:{name:{model:null,temperature:1,count:1,original:!1},surname:{model:"none",temperature:1,count:1,original:!1}}}),game.settings.registerMenu("nameforge","defaultConfigMenu",{name:game.i18n.localize("NAMEFORGE.SETTINGS.name"),label:game.i18n.localize("NAMEFORGE.SETTINGS.label"),hint:game.i18n.localize("NAMEFORGE.SETTINGS.hint"),icon:"fas fa-wrench",type:L,restricted:!1}),game.settings.registerMenu("nameforge","modelUpload",{name:game.i18n.localize("NAMEFORGE.SETTINGS.UPLOAD.name"),label:game.i18n.localize("NAMEFORGE.SETTINGS.UPLOAD.label"),hint:game.i18n.localize("NAMEFORGE.SETTINGS.UPLOAD.hint"),icon:"fas fa-upload",type:k,restricted:!0}),loadTemplates(["modules/nameforge/templates/partials/generate-options.hbs"])}),Hooks.on("ready",async()=>{if(game.user.hasPermission("FILES_UPLOAD")&&game.user.hasPermission("FILES_BROWSE")){try{await FilePicker.createDirectory("data","nameforge-models")}catch{console.log("Folder already exists, skipping creation")}const{files:i}=await FilePicker.browse("data","nameforge-models");i.includes("nameforge-models/models.json")||await FilePicker.upload("data","nameforge-models",new File([JSON.stringify({},null,2)],"models.json",{type:"application/json"}),{},{notify:!1})}game.modules.get("nameforge").api=new b,game.modules.get("nameforge").models=await b.getModels()}),Hooks.on("renderActorDirectory",(i,e)=>{const t=e[0].querySelector("footer.directory-footer.action-buttons");t.insertAdjacentHTML("afterbegin",`<button id="generate-names"><i class="fas fa-plus"></i>${game.i18n.localize("NAMEFORGE.BUTTON.generate")}</button>`),e[0].querySelector("#generate-names").addEventListener("click",()=>new F().render(!0)),game.user.hasPermission("FILES_UPLOAD")&&(t.insertAdjacentHTML("beforeend",`<button id="train-model"><i class="fas fa-head-side-brain"></i>${game.i18n.localize("NAMEFORGE.BUTTON.train")}</button>`),e[0].querySelector("#train-model").addEventListener("click",()=>new C().render(!0)))}),Hooks.on("renderDialog",async(i,e)=>{if(i.data.title===game.i18n.format("DOCUMENT.Create",{type:game.i18n.localize("DOCUMENT.Actor")})){const t=b.filterModels(game.modules.get("nameforge").models),a=await renderTemplate("modules/nameforge/templates/create-new-actor.hbs",{config:game.settings.get("nameforge","defaultConfig"),models:t,show:{seed:!0,temperature:!1,count:!1,weight:!1}});e[0].querySelector("#document-create").insertAdjacentHTML("afterend",a),e[0].querySelector("div.dialog-buttons").insertAdjacentHTML("afterbegin",`<button form="nameforge" class="dialog-button default"><i class="fas fa-plus"></i>${game.i18n.localize("NAMEFORGE.BUTTON.generate")}</button>`);const n=e[0].querySelector("#nameforge");n.addEventListener("submit",async c=>{await c.preventDefault();const m=new FormData(n);let d;const o={name:{model:m.get("nameModel"),seed:m.get("nameSeed"),temperature:m.get("nameTemperature")},surname:{model:m.get("surnameModel"),seed:m.get("surnameSeed"),temperature:m.get("surnameTemperature")}};if(o.name.model==="none"^o.surname.model==="none"){const g=o.name.model!=="none"?"name":"surname",p={count:o[g].count,seed:o[g].seed,temperature:o[g].temperature},u=await h.createModel({path:o[g].model});d=h.generateName(u,p)}else if(o.name.model!=="none"&&o.surname.model!=="none"){const g={name:{count:o.name.count,seed:o.name.seed,temperature:o.name.temperature},surname:{count:o.surname.count,seed:o.surname.seed,temperature:o.surname.temperature}},p=await h.createModel({path:o.name.model}),u=await h.createModel({path:o.surname.model});[d]=h.generateFullName(p,u,g)}const f=e[0].querySelector('input[name="name"]');f.value=d}),i.setPosition({height:"auto"})}}),Hooks.on("getActorSheetHeaderButtons",(i,e)=>{e.unshift({label:"NameForge",class:"nameforge",icon:"fas fa-user-edit",onclick:()=>new F(i).render(!0)})}),Hooks.on("createToken",async(i,e)=>{const t=i.actor.getFlag("nameforge","models");if(!t||Object.values(t||{}).length===0)return;const a=h.selectRandom(Object.values(t)),s=a?.type??"name";let r;if(s==="fullName"){const n=await h.createModel({path:a.model.name}),c=await h.createModel({path:a.model.surname});[r]=h.generateFullName(n,c,a.options)}else if(s==="name"||s==="surname"){const n=await h.createModel({path:a.model});if(s==="name")delete a.options.count,[r]=h.generateName(n,a.options);else{const c=h.generateName(n,a.options).join(" ");r=`${i.name} ${c}`}}i.update({name:r})}),Hooks.on("hotReload",i=>{const{packageType:e,packageId:t,extension:a}=i;e==="module"&&t==="nameforge"&&a==="js"&&location.reload()})})();

//# sourceMappingURL=nameforge.js.map