class LancerCombat extends Combat{_sortCombatants(t,e){const a=e.disposition-t.disposition;return 0!==a?a:super._sortCombatants(t,e)}async _preCreate(...[t,e,a]){return this.updateSource({turn:null}),super._preCreate(t,e,a)}async resetActivations(){const t=CONFIG.LancerInitiative.module,e="skipDefeated"in this.settings&&this.settings.skipDefeated,a=this.combatants.map((a=>({_id:a.id,[`flags.${t}.activations.value`]:e&&a.isDefeated?0:a.activations.max??0})));return this.updateEmbeddedDocuments("Combatant",a)}async startCombat(){return await this.resetActivations(),this.update({round:1,turn:null})}async nextRound(){await this.resetActivations();let t=Math.max(this.turns.length-(this.turn||0),0)*CONFIG.time.turnTime;return t+=CONFIG.time.roundTime,this.update({round:this.round+1,turn:null},{advanceTime:t})}async nextTurn(){return this.update({turn:null})}async previousRound(){await this.resetActivations();const t=Math.max(this.round-1,0);let e=0;return t>0&&(e-=CONFIG.time.roundTime),this.update({round:t,turn:null},{advanceTime:e})}async resetAll(){return await this.resetActivations(),this.combatants.forEach((t=>t.updateSource({initiative:null}))),this.update({turn:null,combatants:this.combatants.toObject()},{diff:!1})}async activateCombatant(t,e=!1){if(!game.user?.isGM&&!e)return this.requestActivation(t);const a=this.getEmbeddedDocument("Combatant",t);if(!a?.activations.value)return this;await(a?.modifyCurrentActivations(-1));const i=this.turns.findIndex((e=>e.id===t));return this.update({turn:i})}async deactivateCombatant(t){const e=this.turns.findIndex((e=>e.id===t));return e!==this.turn?this:this.turns[e].testUserPermission(game.user,"OWNER")||game.user?.isGM?this.nextTurn():this}async requestActivation(t){return Hooks.callAll("LancerCombatRequestActivate",this,t),this}}class LancerCombatant extends Combatant{testUserPermission(...[t,e,a]){return this.actor?.testUserPermission(t,e,a)??t.isGM}prepareBaseData(){super.prepareBaseData();const t=CONFIG.LancerInitiative.module;if(void 0===this.flags?.[t]?.activations?.max&&canvas?.ready){let e;switch(typeof CONFIG.LancerInitiative.activations){case"string":e=foundry.utils.getProperty(this.actor?.getRollData()??{},CONFIG.LancerInitiative.activations)??1;break;case"number":e=CONFIG.LancerInitiative.activations;break;default:e=1}this.updateSource({[`flags.${t}.activations`]:{max:e,value:(this.parent?.round??0)>0?e:0}})}}get activations(){const t=CONFIG.LancerInitiative.module;return this.getFlag(t,"activations")??{}}get disposition(){const t=CONFIG.LancerInitiative.module;return this.getFlag(t,"disposition")??(this.actor?.hasPlayerOwner?2:this.token?.disposition??this.actor?.prototypeToken.disposition??-2)}async addActivations(t){const e=CONFIG.LancerInitiative.module;return 0===t?this:this.update({[`flags.${e}.activations`]:{max:Math.max((this.activations.max??1)+t,1),value:Math.max((this.activations.value??0)+t,0)}})}async modifyCurrentActivations(t){const e=CONFIG.LancerInitiative.module;return 0===t?this:this.update({[`flags.${e}.activations`]:{value:Math.clamped((this.activations?.value??0)+t,0,this.activations?.max??1)}})}}class LancerCombatTracker extends CombatTracker{static get defaultOptions(){return{...super.defaultOptions,template:CONFIG.LancerInitiative.templatePath}}scrollToTurn(){if(null==this.viewed?.turn||!(CONFIG.LancerInitiative?.sort??1))return super.scrollToTurn();this.element.find("ol#combat-tracker")[0].scrollTop=0}async getData(t){const e=CONFIG.LancerInitiative,a=getTrackerAppearance(),i=await super.getData(t),n=e.sort??!0,r={[-2]:"",[-1]:"enemy",0:"neutral",1:"friendly",2:"player"};return i.turns=i.turns.map((t=>{const e=this.viewed.getEmbeddedDocument("Combatant",t.id);return{...t,css:t.css+" "+r[e?.disposition??-2],pending:e?.activations.value??0,finished:(e?.activations.max??1)-(e?.activations.value??0)}})),n&&i.turns.sort((function(t,e){const a=-1!==t.css.indexOf("active")?1:0,i=-1!==e.css.indexOf("active")?1:0;if(i-a!=0)return i-a;return(0===t.pending?1:0)-(0===e.pending?1:0)})),i.icon_class=a.icon,i.enable_initiative=CONFIG.LancerInitiative.enable_initiative??!1,i}activateListeners(t){super.activateListeners(t),t.find(".lancer-combat-control").on("click",this._onActivateCombatant.bind(this))}async _onActivateCombatant(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget,a=e.closest(".combatant")?.dataset.combatantId;if(a)switch(e.dataset.control){case"deactivateCombatant":await this.viewed.deactivateCombatant(a);break;case"activateCombatant":await this.viewed.activateCombatant(a)}}async _onAddActivation(t){const e=this.viewed.getEmbeddedDocument("Combatant",t.data("combatant-id"));await e.addActivations(1)}async _onRemoveActivation(t){const e=this.viewed.getEmbeddedDocument("Combatant",t.data("combatant-id"));await e.addActivations(-1)}async _onUndoActivation(t){const e=this.viewed.getEmbeddedDocument("Combatant",t.data("combatant-id"));await e.modifyCurrentActivations(1)}_getEntryContextOptions(){const t=[{name:"LANCERINITIATIVE.AddActivation",icon:'<i class="fas fa-plus"></i>',callback:this._onAddActivation.bind(this)},{name:"LANCERINITIATIVE.RemoveActivation",icon:'<i class="fas fa-minus"></i>',callback:this._onRemoveActivation.bind(this)},{name:"LANCERINITIATIVE.UndoActivation",icon:'<i class="fas fa-undo"></i>',callback:this._onUndoActivation.bind(this)}];return t.push(...super._getEntryContextOptions().filter((t=>"COMBAT.CombatantReroll"!==t.name))),t}}function getTrackerAppearance(){const t=CONFIG.LancerInitiative;if(!t.def_appearance)throw new Error("No default appearance specified in CONFIG.LancerInitiative");return{...t.def_appearance,...game.settings.get(t.module,"combat-tracker-appearance")}}function setAppearance(t){const e=CONFIG.LancerInitiative.def_appearance;document.documentElement.style.setProperty("--lancer-initiative-icon-size",`${t?.icon_size??e.icon_size}rem`),document.documentElement.style.setProperty("--lancer-initiative-player-color",t?.player_color??e.player_color),document.documentElement.style.setProperty("--lancer-initiative-friendly-color",t?.friendly_color??e.friendly_color),document.documentElement.style.setProperty("--lancer-initiative-neutral-color",t?.neutral_color??e.neutral_color),document.documentElement.style.setProperty("--lancer-initiative-enemy-color",t?.enemy_color??e.enemy_color),document.documentElement.style.setProperty("--lancer-initiative-done-color",t?.done_color??e.done_color),game.combats?.render()}Handlebars.registerHelper("lancerinitiative-repeat",(function(t,e){let a="";for(let i=0;i<t;i++)a+=e.fn(i);return a}));class LancerInitiativeConfigForm extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,title:"Lancer Intiative",id:"lancer-initiative-settings",template:"modules/lancer-initiative/templates/lancer-initiative-settings.html",width:350}}getData(){return getTrackerAppearance()}activateListeners(t){super.activateListeners(t),t.find('input[name="icon"]').on("change",(e=>{t.find("a.preview").removeClass().addClass($(e.target).val()+" preview")})),t.find('input[name="icon_size"]').on("change",(e=>{t.find("a.preview").css("font-size",$(e.target).val()+"rem")})),t.find('input[type="color"]').on("mouseenter mouseleave",(e=>{t.find("a.preview").css("color",$(e.target).val()),"done_selector"!==$(e.target).attr("name")&&t.find("li.combatant").css("border-color",$(e.target).val())})),t.find('button[name="reset"]').on("click",this.resetSettings.bind(this))}async _updateObject(t,e){const a=CONFIG.LancerInitiative;game.settings.set(a.module,"combat-tracker-appearance",foundry.utils.diffObject(a.def_appearance,e,{inner:!0}))}async resetSettings(){const t=CONFIG.LancerInitiative;return await game.settings.set(t.module,"combat-tracker-appearance",{}),this.render()}}const t="lancer-initiative";Hooks.once("init",(function registerSettings(){if(console.log(`${t} | Initializing Lancer Initiative Module`),CONFIG.LancerInitiative?.module)throw Hooks.once("ready",(()=>ui.notifications.warn("The system you are using implements lancer initiative natively. You can disable the module",{permanent:!0}))),new Error(`${t} | Lancer Intitiative already initiatilized, does your system implement it?`);CONFIG.LancerInitiative={module:t,templatePath:"modules/lancer-initiative/templates/lancer-combat-tracker.hbs",def_appearance:{icon:"fas fa-chevron-circle-right",icon_size:1.5,player_color:"#44abe0",friendly_color:"#44abe0",neutral_color:"#146464",enemy_color:"#d98f30",done_color:"#444444"}},Object.defineProperty(CONFIG.LancerInitiative,"module",{writable:!1}),CONFIG.Combat.documentClass=LancerCombat,CONFIG.Combatant.documentClass=LancerCombatant,CONFIG.ui.combat=LancerCombatTracker,game.system.id,game.settings.registerMenu(t,"lancerInitiative",{name:"LANCERINITIATIVE.IconSettingsMenu",label:"LANCERINITIATIVE.IconSettingsMenu",type:LancerInitiativeConfigForm,restricted:!0}),game.settings.register(t,"combat-tracker-appearance",{scope:"world",config:!1,type:Object,onChange:setAppearance,default:{}}),game.settings.register(t,"combat-tracker-sort",{name:"LANCERINITIATIVE.SortTracker",hint:"LANCERINITIATIVE.SortTrackerDesc",scope:"world",config:!0,type:Boolean,onChange:t=>{CONFIG.LancerInitiative.sort=t,game.combats?.render()},default:!0}),CONFIG.LancerInitiative.sort=game.settings.get(t,"combat-tracker-sort"),game.settings.register(t,"combat-tracker-enable-initiative",{name:"LANCERINITIATIVE.EnableInitiative",hint:"LANCERINITIATIVE.EnableInitiativeDesc",scope:"world",config:!!CONFIG.Combat.initiative.formula,type:Boolean,onChange:t=>{CONFIG.LancerInitiative.enable_initiative=t,game.combats?.render()},default:!1}),CONFIG.LancerInitiative.enable_initiative=game.settings.get(t,"combat-tracker-enable-initiative"),Hooks.callAll("LancerInitiativeInit"),setAppearance(getTrackerAppearance())}));
//# sourceMappingURL=lancer-initiative.js.map
