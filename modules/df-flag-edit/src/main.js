/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__=[,()=>{if(!globalThis.HooksExt){class _HooksExt{static on(t,e){console.debug(`${vtt} | Registered callback for ${t} hook`);const o=Hooks._id++;if(t instanceof RegExp){const i=t.toString();let n=this._regex.get(i);n||(n={regex:t,fns:[]},this._regex.set(i,n)),n.fns.push(o),Hooks._hooks[i]=Hooks._hooks[i]||[],Hooks._hooks[i].push(e)}else Hooks._hooks[t]=Hooks._hooks[t]||[],Hooks._hooks[t].push(e);return Hooks._ids[o]=e,o}static off(t,e){if("number"==typeof e){const t=e;e=Hooks._ids[e],delete Hooks._ids[t]}else{const t=Object.entries(Hooks._ids).find((t=>t[1]===e));t&&delete Hooks._ids[parseInt(t[0])]}if(t instanceof RegExp&&(t=t.toString()),this._regex.delete(t),!Hooks._hooks.hasOwnProperty(t))return;const o=Hooks._hooks[t],i=o.indexOf(e);-1!==i&&o.splice(i,1),console.debug(`${vtt} | Unregistered callback for ${t} hook`)}static callAll(t,...e){CONFIG.debug.hooks&&(console.log(`DEBUG | Calling ${t} hook with args:`),console.log(e),this._hookRepo.add(t));for(const o of this._regex)if(o[1].regex.test(t))for(const i of o[1].fns)Hooks._call(t,Hooks._ids[i],e);if(!Hooks._hooks.hasOwnProperty(t))return!0;const o=new Array(...Hooks._hooks[t]);for(const i of o)Hooks._call(t,i,e);return!0}static call(t,...e){CONFIG.debug.hooks&&(console.log(`DEBUG | Calling ${t} hook with args:`),console.log(e),this._hookRepo.add(t));let o=[];for(const e of this._regex)e[1].regex.test(t)&&(o=o.concat(e[1].fns.map((t=>Hooks._ids[t]))));const i=Hooks._hooks.hasOwnProperty(t);if(!i&&0==o.length)return!0;i&&(o=o.concat(...Hooks._hooks[t]));for(const i of o){if(!1===Hooks._call(t,i,e))return!1}return!0}static allUniqueHooks(){return[...this._hookRepo.values()]}}_HooksExt._regex=new Map,_HooksExt._hookRepo=new Set,globalThis.HooksExt=_HooksExt,Hooks.on=_HooksExt.on.bind(_HooksExt),Hooks.off=_HooksExt.off.bind(_HooksExt),Hooks.callAll=_HooksExt.callAll.bind(_HooksExt),Hooks.call=_HooksExt.call.bind(_HooksExt)}},(t,e,o)=>{o.r(e),o.d(e,{default:()=>SETTINGS});class SETTINGS{static init(t){this.MOD_NAME=t,String.prototype.localize||(String.prototype.localize=function(){return game.i18n.localize(this.valueOf())})}static register(t,e){game.settings.register(SETTINGS.MOD_NAME,t,e)}static registerMenu(t,e){game.settings.registerMenu(SETTINGS.MOD_NAME,t,e)}static get(t){return game.settings.get(SETTINGS.MOD_NAME,t)}static async set(t,e){return await game.settings.set(SETTINGS.MOD_NAME,t,e)}static default(t){return game.settings.settings.get(SETTINGS.MOD_NAME+"."+t).default}static typeOf(){return Object}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>FlagEditor});var _common_Settings__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2);class FlagEditor extends Application{constructor(){super({title:game.i18n.localize("DF_FLAG_EDIT.Title").replace(" - {0} ({1})","")}),this._document=null}static get defaultOptions(){return mergeObject(Application.defaultOptions,{template:`modules/${_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.MOD_NAME}/templates/flag-edit.hbs`,minimizable:!0,resizable:!0,height:500,width:500})}static async _findObject(t){return"string"==typeof t||t instanceof String?await new Promise(((e,o)=>{const i=game.collections;for(const[o,n]of i.entries())if(!FlagEditor.IGNORED_COLLECTIONS.includes(o)&&n.has(t)){e(n.get(t));break}o()})).catch((()=>new Promise(((e,o)=>{for(const o of canvas.layers)if(o instanceof PlaceablesLayer&&o.documentCollection.has(t)){e(o.documentCollection.get(t));break}o()})))).catch((()=>Promise.resolve(null))):Promise.reject("Invalid parameter: id must be type 'string'")}static init(){_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.register(FlagEditor.PREF_LAST_OBJ,{scope:"client",type:String,default:"",config:!1}),Hooks.on("renderSettings",((t,e)=>{if(!game.user.isGM)return;const o=$(`<div><button data-action="edit-json"><i class="fas fa-code"></i>${game.i18n.localize("DF_FLAG_EDIT.EditButtonLabel")}</button></div>`);o.find("button").on("click",(()=>(new FlagEditor).render(!0))),e.find("#game-details").after(o)}))}set document(t){var e,o;this._document=t,this.editor.set((null===(o=null===(e=this._document)||void 0===e?void 0:e.data)||void 0===o?void 0:o.flags)||"")}get document(){return this._document}async _render(t,e){await FlagEditor._loadEditor();const o=await super._render(t,e),i={ace:"ace"in window?ace:void 0,limitDragging:!1,mode:"tree",modes:["tree","code"],indentation:4,mainMenuBar:!0,navigationBar:!0,statusBar:!0,colorPicker:!0,onCreateMenu:(t,e)=>t.filter((t=>!["jsoneditor-extract","jsoneditor-transform"].includes(t.className)))};this.editor=new JSONEditor(this.element.find("#editor")[0],i),this.document||await this._handlePathChange(_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.get(FlagEditor.PREF_LAST_OBJ));const n=this.element.find("#object-path");n.on("input",(()=>n.trigger("change"))),n.on("change",(async()=>this._handlePathChange(n.val().trim()))),this.element.find("#cancel").on("click",(()=>this.close()));const s=this.element.find("#apply"),a=this.element.find("#save");return a.on("click",(()=>{s.trigger("click"),this.close()})),s.on("click",(async()=>{var t,e,o,i,n,r;if(void 0===(null===(e=null===(t=this.document)||void 0===t?void 0:t.data)||void 0===e?void 0:e.flags)||null===(null===(i=null===(o=this.document)||void 0===o?void 0:o.data)||void 0===i?void 0:i.flags))return;a.prop("disabled",!0),s.prop("disabled",!0);const _=this.editor.get(),l=Object.keys(_).flatMap((t=>Object.keys(_[t]).map((e=>`${t}_____${e}`)))).filter((t=>!t.endsWith("_____"))),d=Object.keys(this.document.data.flags).flatMap((t=>Object.keys(this.document.data.flags[t]).map((e=>`${t}_____${e}`)))).filter((t=>!t.endsWith("_____"))).filter((t=>!l.includes(t)));for(const t of d){const e=t.split("_____")[0],o=t.split("_____")[1];try{const t=o.split("."),i=`-=${t.pop()}`,n=[e,...t,i].join(".");_[n]=null}catch(t){console.warn(t)}}await this.document.update({flags:_}),this.editor.set((null===(r=null===(n=this._document)||void 0===n?void 0:n.data)||void 0===r?void 0:r.flags)||""),a.prop("disabled",!1),s.prop("disabled",!1)})),o}static _loadEditor(){if(null==this._loadEditorPromise){const t=new Promise((t=>{const e=document.createElement("script");e.async=!0,e.onload=()=>t(),"ace"in window?e.src=`/modules/${_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.MOD_NAME}/libs/jsoneditor-minimalist.min.js`:e.src=`/modules/${_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.MOD_NAME}/libs/jsoneditor.min.js`,document.body.append(e)})),e=new Promise((t=>{const e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.onload=()=>t(),e.href=`/modules/${_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.MOD_NAME}/libs/jsoneditor.min.css`,document.body.append(e)}));this._loadEditorPromise=Promise.all([t,e])}return this._loadEditorPromise}_showError(t){const e=this.element.find(".error");e.attr("title",t||game.i18n.localize("DF_FLAG_EDIT.ErrorObjectNotFound")),e.show(),this.document=null,this._updateTitle()}_hideError(){this.element.find(".error").hide()}_updateTitle(){var t,e;this.options.title=game.i18n.localize("DF_FLAG_EDIT.Title").replace("{0}",null!==this.document?Object.getPrototypeOf(this.document).constructor.name:"#").replace("{1}",(null===(e=null===(t=this.document)||void 0===t?void 0:t.data)||void 0===e?void 0:e._id)||"#"),this.element.find("h4.window-title").text(this.options.title)}getData(){return{path:_common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.get(FlagEditor.PREF_LAST_OBJ)}}async _handlePathChange(t){var e,o,i,n,s;let a;if(await _common_Settings__WEBPACK_IMPORTED_MODULE_0__.default.set(FlagEditor.PREF_LAST_OBJ,t),0===t.length)return this._hideError(),void(a=null);try{if(FlagEditor.isID(t))a=await FlagEditor.extractID(t);else{let e=FlagEditor.evaluateDocument(t);if(!FlagEditor.isDocument(e)){if(!(e instanceof String||"string"==typeof e)||!FlagEditor.isID(e))throw"Invalid object from path";e=await FlagEditor.extractID(e)}a=e}}catch(t){return this._showError(t),void(a=null)}if(void 0===(null==a?void 0:a.data)||null===(null==a?void 0:a.data)){if(void 0===(null===(e=a)||void 0===e?void 0:e.document)||null===(null===(o=a)||void 0===o?void 0:o.document))return void this._showError("Invalid object: document must be of type 'string', 'Document', or 'DocumentData'");a=null===(i=a)||void 0===i?void 0:i.document}void 0!==(null===(n=null==a?void 0:a.data)||void 0===n?void 0:n.flags)&&null!==(null===(s=null==a?void 0:a.data)||void 0===s?void 0:s.flags)?(this._hideError(),this.document=a,this._updateTitle()):this._showError("Invalid object: does not contain a flags field")}static isID(t){return/^['"`]?[a-z0-9]+['"`]?$/im.test(t)}static isDocument(t){return void 0!==(null==t?void 0:t.data)||void 0!==(null==t?void 0:t.document)}static extractID(t){return FlagEditor._findObject(t.match(/^['"`]?([a-z0-9]+)['"`]?$/im)[1])}static evaluateDocument(target){return eval(target)}}FlagEditor.PREF_LAST_OBJ="FlagEditor.LastObject",FlagEditor.IGNORED_COLLECTIONS=["FogExploration","Setting"],FlagEditor._loadEditorPromise=null,window.showFlagEditorForDocument=async t=>{if(void 0===t.data)if(void 0===t.document){if(!(t instanceof String||"string"==typeof t))throw Error("Invalid object: document must be of type 'string', 'Document', or 'DocumentData'");t=FlagEditor._findObject(t)}else t=t.document;if(null===t)return ui.notifications.error(`Could not find an object with ID '${t}'`),void console.error(`Could not find an object with ID '${t}'`);const e=new FlagEditor;await e.render(!0),e.document=t}}],__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var o=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](o,o.exports,__webpack_require__),o.exports}__webpack_require__.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return __webpack_require__.d(e,{a:e}),e},__webpack_require__.d=(t,e)=>{for(var o in e)__webpack_require__.o(e,o)&&!__webpack_require__.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{__webpack_require__.r(__webpack_exports__);__webpack_require__(1);var t=__webpack_require__(2),e=__webpack_require__(3);function launchFlagEditorForEvent(o){const i=$(o.currentTarget).parents(".window-app").attr("id").split("-").pop();i&&(t.default.set(e.default.PREF_LAST_OBJ,i),(new e.default).render(!0))}t.default.init("df-flag-edit"),Hooks.once("init",(function(){e.default.init()})),Hooks.once("ready",(function(){game.user.isGM&&Hooks.on(/get.*HeaderButtons/,((t,e)=>{e.find((t=>"edit-flags"===t.class))||t instanceof DocumentSheet&&e.unshift({icon:"fas fa-code",label:"Edit Flags",class:"edit-flags",onclick:launchFlagEditorForEvent})}))})),Hooks.on("editFlags",(o=>!!(o=null==o?void 0:o.trim())&&(t.default.set(e.default.PREF_LAST_OBJ,o),(new e.default).render(!0),!1)))})()})();
//# sourceMappingURL=main.js.map