const D="autocomplete-mentions",k="Autocomplete Mentions",C="@mention actors, items, scenes, etc. from any editor box (without having to drag & drop or remember names)",v={minimum:"11",verified:"11.315"},E=["scripts/index.js"],L=["styles/autocomplete-mentions.css"],A=[],K=[{lang:"en",name:"English",path:"lang/en.json"}],N=[{name:"Dov Rosenberg","#discord":"","#email":"","#url":""}],F="https://github.com/dovrosenberg/fvt--autocomplete-mentions",I="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/releases/latest/download/module.json",x="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/releases/download/v1.0.0/module.zip",j="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/LICENSE.md",H="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/README.md",J="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/issues",O="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/CHANGELOG.md";var p={id:D,title:k,description:C,compatibility:v,esmodules:E,styles:L,packs:A,languages:K,authors:N,url:F,manifest:I,download:x,"## version":"will be added when we build",license:j,readme:H,bugs:J,changelog:O};const m=function(){if(!(game instanceof Game))throw new Error("Game is not initialized yet!");return game},l=t=>m().i18n.localize(t),z="autocomplete-mentions | ";function M(t,...e){var n,s;try{const i=((s=(n=m().modules.get("_dev-mode"))==null?void 0:n.api)==null?void 0:s.getPackageDebugValue("autocomplete-mentions"))||!1;(t||i)&&console.log(z,...e)}catch(i){console.log("ERROR IN LOG FUNCTION:"+i)}}var a=(t=>(t[t.singleAtWaiting=0]="singleAtWaiting",t[t.docSearch=1]="docSearch",t[t.journalPageSearch=2]="journalPageSearch",t))(a||{}),h=(t=>(t[t.Actor=0]="Actor",t[t.Item=1]="Item",t[t.Journal=2]="Journal",t[t.RollTable=3]="RollTable",t[t.Scene=4]="Scene",t))(h||{}),d=(t=>(t[t.ProseMirror=0]="ProseMirror",t[t.TinyMCE=1]="TinyMCE",t))(d||{}),R=(t=>(t.resultLength="resultLength",t))(R||{});let T;function G(t){T=t}class W{constructor(){this.localMenuParams=[],this.displayParams=[{settingID:"resultLength",name:"acm.settings.resultLength",hint:"acm.settings.resultLengthHelp",default:5,type:Number}],this.localDisplayParams=[],this.internalParams=[],this.localInternalParams=[],this.registerSettings()}isSettingValueEmpty(e){return Object.keys(e).length===0||e===null||e===void 0}get(e){return m().settings.get(p.id,e)}async set(e,n){await m().settings.set(p.id,e,n)}register(e,n){m().settings.register(p.id,e,n)}registerMenu(e,n){m().settings.registerMenu(p.id,e,n)}registerSettings(){for(let e=0;e<this.localMenuParams.length;e++){const{settingID:n,...s}=this.localMenuParams[e];this.registerMenu(n,{...s,name:s.name?l(s.name):"",hint:s.hint?l(s.hint):"",restricted:!0})}for(let e=0;e<this.displayParams.length;e++){const{settingID:n,...s}=this.displayParams[e];this.register(n,{...s,name:s.name?l(s.name):"",hint:s.hint?l(s.hint):"",scope:"world",config:!0})}for(let e=0;e<this.localDisplayParams.length;e++){const{settingID:n,...s}=this.localDisplayParams[e];this.register(n,{...s,name:s.name?l(s.name):"",hint:s.hint?l(s.hint):"",scope:"client",config:!0})}for(let e=0;e<this.internalParams.length;e++){const{settingID:n,...s}=this.internalParams[e];this.register(n,{...s,scope:"world",config:!1})}for(let e=0;e<this.localInternalParams.length;e++){const{settingID:n,...s}=this.localInternalParams[e];this.register(n,{...s,scope:"client",config:!1})}}}let u=[];function q(){M(!1,"Loading localized document text"),u=[{type:h.Actor,keypress:l("acm.documents.keys.actors"),title:l("acm.documents.titles.actors"),searchName:"Actors",collectionName:"actors",referenceText:"Actor"},{type:h.Item,keypress:l("acm.documents.keys.items"),title:l("acm.documents.titles.items"),searchName:"Items",collectionName:"items",referenceText:"Item"},{type:h.Journal,keypress:l("acm.documents.keys.journals"),title:l("acm.documents.titles.journals"),searchName:"Journals",collectionName:"journal",referenceText:"JournalEntry"},{type:h.RollTable,keypress:l("acm.documents.keys.rollTables"),title:l("acm.documents.titles.rollTables"),searchName:"Roll Tables",collectionName:"tables",referenceText:"RollTable"},{type:h.Scene,keypress:l("acm.documents.keys.scenes"),title:l("acm.documents.titles.scenes"),searchName:"Scenes",collectionName:"scenes",referenceText:"Scene"}]}class U extends Application{constructor(e,n,s){super(),this._focusedMenuKey=0,this._searchDocType=null,this._shownFilter="",this._lastPulledSearchResults=[],this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledRowCount=0,this._filteredSearchResults=[],this._onListClick=async i=>{if(!(i!=null&&i.currentTarget))return;const r=i.currentTarget.attributes["data-acm-index"].nodeValue;this._focusedMenuKey=Number.parseInt(r),this._onKeydown({key:"Enter",preventDefault:()=>{},stopPropagation:()=>{}})},this._onListMouseover=async i=>{if(!(i!=null&&i.currentTarget))return;const r=Number.parseInt(i.currentTarget.attributes["data-acm-index"].nodeValue);this._focusedMenuKey!==r&&(this._focusedMenuKey=r,this.render())},this._onKeydown=async i=>{switch(i.preventDefault(),i.stopPropagation(),this._currentMode){case a.singleAtWaiting:{switch(i.key){case"Enter":{if(!u[this._focusedMenuKey])return;const o=u[this._focusedMenuKey].type;await this._moveToDocSearch(o);break}case"Escape":{this._insertTextAndClose("@");break}case"Backspace":{this.close();return}case"ArrowUp":{this._focusedMenuKey=(this._focusedMenuKey-1+u.length)%u.length;break}case"ArrowDown":{this._focusedMenuKey=(this._focusedMenuKey+1)%u.length;break}default:const r=u.find(o=>o.keypress.toLocaleLowerCase()===i.key.toLocaleLowerCase());if(r){await this._moveToDocSearch(r.type);break}else return}break}case a.docSearch:case a.journalPageSearch:{if(i.key.length===1)this._shownFilter+=i.key,await this._refreshSearch();else switch(i.key){case"Enter":{if(this._currentMode===a.docSearch){if(this._searchDocType===null)return;if(!this._focusedMenuKey)this._createDocument(this._searchDocType);else if(this._searchDocType===h.Journal){this._currentMode=a.journalPageSearch;const r=this._filteredSearchResults[this._focusedMenuKey-1];this._selectedJournal={...r},this._shownFilter="",this._focusedMenuKey=0,await this._refreshSearch()}else{const r=this._filteredSearchResults[this._focusedMenuKey-1];r&&(u.find(o=>o.type===this._searchDocType),this._insertReferenceAndClose(r.uuid))}}else if(!this._focusedMenuKey)this._insertReferenceAndClose(this._selectedJournal.uuid);else{const r=this._filteredSearchResults[this._focusedMenuKey-1];r&&(u.find(o=>o.type===this._searchDocType),this._insertReferenceAndClose(r.uuid))}break}case"Backspace":{this._shownFilter.length===0?(this._currentMode===a.docSearch?this._currentMode=a.singleAtWaiting:(this._currentMode=a.docSearch,this._shownFilter="",await this._refreshSearch()),this._focusedMenuKey=0):(this._shownFilter=this._shownFilter.slice(0,-1),await this._refreshSearch(),this._focusedMenuKey=0);break}case"Escape":{this.close();return}case"ArrowUp":{this._focusedMenuKey=(this._focusedMenuKey-1+this._filteredSearchResults.length+1)%(this._filteredSearchResults.length+1);break}case"ArrowDown":{this._focusedMenuKey=(this._focusedMenuKey+1)%(this._filteredSearchResults.length+1);break}default:return}break}default:return}await this.render()},this._getSelectionCoords=function(i,r){var b;const o=this._editor.ownerDocument.getSelection();if(!o||!o.rangeCount)return null;const c=o.getRangeAt(0).cloneRange();if(!c.getClientRects())return null;c.collapse(!1);let g=c.getClientRects();if(g.length||(c.startContainer&&c.collapsed&&c.selectNodeContents(c.startContainer),g=c.getClientRects()),g.length<=0||!((b=this._editor)==null?void 0:b.getBoundingClientRect()))return null;const w=g[0];let y={left:0,top:0};if(this._editorType===d.TinyMCE){const S=this._editor.ownerDocument.defaultView.frameElement;if(!S)throw"Error locating TinyMCE - is it not in an iframe???";y=S.getBoundingClientRect()}return{left:w.left+y.left+i,top:w.top+y.top+r}},this._refreshSearch=async function(){this._filteredSearchResults=[],this._currentMode===a.journalPageSearch?await this._pullJournalData():await this._pullData(),this._filteredSearchResults=this._getFilteredSearchResults(),this._filteredSearchResults.length>=1?this._focusedMenuKey=1:this._focusedMenuKey=0},M(!1,"Autocompleter construction"),this._editor=e,this._editorType=n,this._currentMode=a.singleAtWaiting,this._onClose=s,this._location=this._getSelectionCoords(10,0)||{left:0,top:0},this.render()}static get defaultOptions(){const e=super.defaultOptions;return e.classes=["acm-autocomplete"],e.template=`modules/${p.id}/templates/autocompleter.hbs`,e.popOut=!1,e.resizable=!1,e.height="auto",e}retarget(e){this._editor=e,this.render()}async getData(){var n,s,i;return{...await super.getData(),location:this._location,docTypes:u,singleAtWaiting:this._currentMode===a.singleAtWaiting,docSearch:this._currentMode===a.docSearch,journalPageSearch:this._currentMode===a.journalPageSearch,journalName:(n=this._selectedJournal)==null?void 0:n.name,docType:(s=u.find(r=>r.type===this._searchDocType))==null?void 0:s.searchName,highlightedEntry:this._focusedMenuKey,searchResults:this._filteredSearchResults,shownFilter:this._shownFilter,hasMore:(this._lastPulledRowCount||0)>(((i=this._filteredSearchResults)==null?void 0:i.length)||0)}}activateListeners(e){super.activateListeners(e);const n=e[0],s=n.querySelector("#acm-wrapper");s.focus(),s.addEventListener("keydown",this._onKeydown);const i=n.querySelectorAll(".acm-data-entry");for(let o=0;o<i.length;o++)i[o].addEventListener("click",this._onListClick),i[o].addEventListener("mouseover",this._onListMouseover);const r=o=>{const c=document.querySelector("#acm-wrapper");c?c.contains(o.target)||this.close():(document.removeEventListener("pointerdown",this._onPointerDown),this._editorType===d.TinyMCE&&this._editor.ownerDocument.removeEventListener("pointerdown",this._onPointerDown))};this._onPointerDown&&(document.removeEventListener("pointerdown",this._onPointerDown),this._editorType===d.TinyMCE&&this._editor.ownerDocument.removeEventListener("pointerdown",this._onPointerDown)),this._onPointerDown=r,document.addEventListener("pointerdown",r),this._editorType===d.TinyMCE&&this._editor.ownerDocument.addEventListener("pointerdown",r)}async render(e){return await super.render(e)}async close(e={}){const n=document.querySelector(".acm-autocomplete");return n&&(n.style.display="none"),document.removeEventListener("pointerdown",this._onPointerDown),this._editorType===d.TinyMCE&&this._editor.ownerDocument.removeEventListener("pointerdown",this._onPointerDown),this._onClose&&this._onClose(),super.close(e)}_getFilteredSearchResults(){const e=T.get(R.resultLength);let n;return n=this._lastPulledSearchResults,n.slice(0,e)}async _pullData(){if(this._searchDocType===null){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[],this._lastPulledRowCount=0;return}this._lastPulledFilter=this._shownFilter,this._lastPulledType=this._searchDocType;const e=u.find(i=>i.type===this._searchDocType);if(!(e!=null&&e.collectionName)){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[];return}const n=m()[e.collectionName];let s;s=n.search({query:this._shownFilter,filters:[]}),s=s.filter(i=>i.name),this._lastPulledRowCount=s.length,this._lastPulledSearchResults=s.map(i=>({uuid:i.uuid,name:i.name,pages:this._searchDocType===h.Journal?i.pages:void 0}))}async _pullJournalData(){if(this._currentMode!==a.journalPageSearch){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[],this._lastPulledRowCount=0;return}this._lastPulledFilter=this._shownFilter,this._lastPulledType=null;const e=this._selectedJournal.pages;if(!e)return;let n;n=e.search({query:this._shownFilter,filters:[]}),n=n.filter(s=>s.name),this._lastPulledRowCount=n.length,this._lastPulledSearchResults=n.map(s=>({uuid:s.uuid,name:s.name,pages:null}))}async _moveToDocSearch(e){this._currentMode=a.docSearch,this._searchDocType=e,this._shownFilter="",this._focusedMenuKey=0,await this._refreshSearch()}_insertReferenceAndClose(e){this._insertTextAndClose(`@UUID[${e}]`)}_insertTextAndClose(e){this._editor.focus(),this._editor.ownerDocument.execCommand("insertText",!1,e),this.close()}async _createDocument(e){const n=u.find(_=>_.type===e);if(!n)return;const s=m()[n.collectionName],i={folder:void 0},r={width:320,left:300,top:300},o=this._editor.ownerDocument.getSelection(),c=o!=null&&o.rangeCount?o==null?void 0:o.getRangeAt(0):null;getDocumentClass(s.documentName).createDialog(i,r).then(_=>{_&&(c&&(o==null||o.removeAllRanges(),o==null||o.addRange(c)),this._insertReferenceAndClose(_.uuid))}),this.close()}}function B(){Hooks.once("i18nInit",Q)}async function Q(){q()}let f=null;function $(){Hooks.once("init",X)}async function X(){G(new W),Y()}function Y(){jQuery(document).on("keydown",'.ProseMirror.editor-content[contenteditable="true"]',{editorType:d.ProseMirror},P);var t=new MutationObserver(function(e){e.forEach(function(n){for(let s=0;s<n.addedNodes.length;s++)n.addedNodes[s].nodeName==="IFRAME"&&setTimeout(()=>{jQuery(n.addedNodes[s].contentDocument).on("keydown",'body#tinymce.mce-content-body[contenteditable="true"]',{editorType:d.TinyMCE},P)},100)})});t.observe(document,{subtree:!0,childList:!0})}function P(t){if(t.key==="@"){t.preventDefault();let e;e=t.data.editorType,Z(t.target,e)}}function Z(t,e){f==null||f.close(),f=new U(t,e,()=>{f=null}),f.render(!0)}function V(t,e){return typeof t=="number"&&typeof e=="number"?t+e:t}const ee="acm";function te(){Handlebars.registerHelper(`${ee}-add`,V)}function se(){Hooks.once("ready",ne)}async function ne(){te()}function ie(){$(),se(),B()}Hooks.once("devModeReady",async({registerPackageDebugFlag:t})=>{t("autocomplete-mentions","boolean")});ie();
//# sourceMappingURL=index.js.map
