const b="autocomplete-mentions",P="Autocomplete Mentions",R="@mention actors, items, scenes, etc. from any editor box (without having to drag & drop or remember names)",M={minimum:"11",verified:"11.315"},k=["scripts/index.js"],D=["styles/autocomplete-mentions.css"],T=[],C=[{lang:"en",name:"English",path:"lang/en.json"}],v=[{name:"Dov Rosenberg","#discord":"","#email":"","#url":""}],L="https://github.com/dovrosenberg/fvt--autocomplete-mentions",A="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/releases/latest/download/module.json",K="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/releases/download/v0.0.8/module.zip",F="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/LICENSE.md",I="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/README.md",N="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/issues",E="https://github.com/dovrosenberg/fvtt-autocomplete-mentions/blob/master/CHANGELOG.md";var f={id:b,title:P,description:R,compatibility:M,esmodules:k,styles:D,packs:T,languages:C,authors:v,url:L,manifest:A,download:K,"## version":"will be added when we build",license:F,readme:I,bugs:N,changelog:E};const d=function(){if(!(game instanceof Game))throw new Error("Game is not initialized yet!");return game},l=n=>d().i18n.localize(n),x="autocomplete-mentions | ";function p(n,...e){var s,t;try{const i=((t=(s=d().modules.get("_dev-mode"))==null?void 0:s.api)==null?void 0:t.getPackageDebugValue("autocomplete-mentions"))||!1;(n||i)&&console.log(x,...e)}catch(i){console.log("ERROR IN LOG FUNCTION:"+i)}}var a=(n=>(n[n.singleAtWaiting=0]="singleAtWaiting",n[n.docSearch=1]="docSearch",n[n.journalPageSearch=2]="journalPageSearch",n))(a||{}),h=(n=>(n[n.Actor=0]="Actor",n[n.Item=1]="Item",n[n.Journal=2]="Journal",n[n.RollTable=3]="RollTable",n[n.Scene=4]="Scene",n))(h||{}),y=(n=>(n.resultLength="resultLength",n))(y||{});let w;function j(n){w=n}class H{constructor(){this.localMenuParams=[],this.displayParams=[{settingID:"resultLength",name:"acm.settings.resultLength",hint:"acm.settings.resultLengthHelp",default:5,type:Number}],this.localDisplayParams=[],this.internalParams=[],this.localInternalParams=[],this.registerSettings()}isSettingValueEmpty(e){return Object.keys(e).length===0||e===null||e===void 0}get(e){return d().settings.get(f.id,e)}async set(e,s){await d().settings.set(f.id,e,s)}register(e,s){d().settings.register(f.id,e,s)}registerMenu(e,s){d().settings.registerMenu(f.id,e,s)}registerSettings(){for(let e=0;e<this.localMenuParams.length;e++){const{settingID:s,...t}=this.localMenuParams[e];this.registerMenu(s,{...t,name:t.name?l(t.name):"",hint:t.hint?l(t.hint):"",restricted:!0})}for(let e=0;e<this.displayParams.length;e++){const{settingID:s,...t}=this.displayParams[e];this.register(s,{...t,name:t.name?l(t.name):"",hint:t.hint?l(t.hint):"",scope:"world",config:!0})}for(let e=0;e<this.localDisplayParams.length;e++){const{settingID:s,...t}=this.localDisplayParams[e];this.register(s,{...t,name:t.name?l(t.name):"",hint:t.hint?l(t.hint):"",scope:"client",config:!0})}for(let e=0;e<this.internalParams.length;e++){const{settingID:s,...t}=this.internalParams[e];this.register(s,{...t,scope:"world",config:!1})}for(let e=0;e<this.localInternalParams.length;e++){const{settingID:s,...t}=this.localInternalParams[e];this.register(s,{...t,scope:"client",config:!1})}}}let c=[];function J(){p(!1,"Loading localized document text"),c=[{type:h.Actor,keypress:l("acm.documents.keys.actors"),title:l("acm.documents.titles.actors"),searchName:"Actors",collectionName:"actors",referenceText:"Actor"},{type:h.Item,keypress:l("acm.documents.keys.items"),title:l("acm.documents.titles.items"),searchName:"Items",collectionName:"items",referenceText:"Item"},{type:h.Journal,keypress:l("acm.documents.keys.journals"),title:l("acm.documents.titles.journals"),searchName:"Journals",collectionName:"journal",referenceText:"JournalEntry"},{type:h.RollTable,keypress:l("acm.documents.keys.rollTables"),title:l("acm.documents.titles.rollTables"),searchName:"Roll Tables",collectionName:"tables",referenceText:"RollTable"},{type:h.Scene,keypress:l("acm.documents.keys.scenes"),title:l("acm.documents.titles.scenes"),searchName:"Scenes",collectionName:"scenes",referenceText:"Scene"}]}class z extends Application{constructor(e,s){super(),this._focusedMenuKey=0,this._searchDocType=null,this._shownFilter="",this._lastPulledSearchResults=[],this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledRowCount=0,this._filteredSearchResults=[],this._onListClick=async t=>{if(!(t!=null&&t.currentTarget))return;const i=t.currentTarget.attributes["data-acm-index"].nodeValue;this._focusedMenuKey=Number.parseInt(i),this._onKeydown({key:"Enter",preventDefault:()=>{},stopPropagation:()=>{}})},this._onListMouseover=async t=>{if(!(t!=null&&t.currentTarget))return;const i=Number.parseInt(t.currentTarget.attributes["data-acm-index"].nodeValue);this._focusedMenuKey!==i&&(this._focusedMenuKey=i,this.render())},this._onKeydown=async t=>{switch(t.preventDefault(),t.stopPropagation(),this._currentMode){case a.singleAtWaiting:{switch(t.key){case"Enter":{if(!c[this._focusedMenuKey])return;const o=c[this._focusedMenuKey].type;await this._moveToDocSearch(o);break}case"Escape":{this._insertTextAndClose("@");break}case"Backspace":{this.close();return}case"ArrowUp":{this._focusedMenuKey=(this._focusedMenuKey-1+c.length)%c.length;break}case"ArrowDown":{this._focusedMenuKey=(this._focusedMenuKey+1)%c.length;break}default:const i=c.find(o=>o.keypress.toLocaleLowerCase()===t.key.toLocaleLowerCase());if(i){await this._moveToDocSearch(i.type);break}else return}break}case a.docSearch:case a.journalPageSearch:{if(t.key.length===1)this._shownFilter+=t.key,await this._refreshSearch();else switch(t.key){case"Enter":{if(this._currentMode===a.docSearch){if(this._searchDocType===null)return;if(!this._focusedMenuKey)this._createDocument(this._searchDocType);else if(this._searchDocType===h.Journal){this._currentMode=a.journalPageSearch;const i=this._filteredSearchResults[this._focusedMenuKey-1];this._selectedJournal={...i},this._shownFilter="",this._focusedMenuKey=0,await this._refreshSearch()}else{const i=this._filteredSearchResults[this._focusedMenuKey-1];i&&(c.find(o=>o.type===this._searchDocType),this._insertReferenceAndClose(i.uuid))}}else if(!this._focusedMenuKey)this._insertReferenceAndClose(this._selectedJournal.uuid);else{const i=this._filteredSearchResults[this._focusedMenuKey-1];i&&(c.find(o=>o.type===this._searchDocType),this._insertReferenceAndClose(i.uuid))}break}case"Backspace":{this._shownFilter.length===0?(this._currentMode===a.docSearch?this._currentMode=a.singleAtWaiting:(this._currentMode=a.docSearch,this._shownFilter="",await this._refreshSearch()),this._focusedMenuKey=0):(this._shownFilter=this._shownFilter.slice(0,-1),await this._refreshSearch(),this._focusedMenuKey=0);break}case"Escape":{this.close();return}case"ArrowUp":{this._focusedMenuKey=(this._focusedMenuKey-1+this._filteredSearchResults.length+1)%(this._filteredSearchResults.length+1);break}case"ArrowDown":{this._focusedMenuKey=(this._focusedMenuKey+1)%(this._filteredSearchResults.length+1);break}default:return}break}default:return}await this.render()},this._getSelectionCoords=function(t,i){var _;const o=document.getSelection();if(!o||!o.rangeCount)return null;const r=o.getRangeAt(0).cloneRange();if(!r.getClientRects())return null;r.collapse(!1);let u=r.getClientRects();if(u.length||(r.startContainer&&r.collapsed&&r.selectNodeContents(r.startContainer),u=r.getClientRects()),u.length<=0||!((_=this._editor)==null?void 0:_.getBoundingClientRect()))return null;const m=u[0];return{left:m.left+t,top:m.top+i}},this._refreshSearch=async function(){this._filteredSearchResults=[],this._currentMode===a.journalPageSearch?await this._pullJournalData():await this._pullData(),this._filteredSearchResults=this._getFilteredSearchResults(),this._filteredSearchResults.length>=1?this._focusedMenuKey=1:this._focusedMenuKey=0},p(!1,"Autocompleter construction"),this._editor=e,this._currentMode=a.singleAtWaiting,this._onClose=s,this._location=this._getSelectionCoords(10,0)||{left:0,top:0},this.render()}static get defaultOptions(){const e=super.defaultOptions;return e.classes=["acm-autocomplete"],e.template=`modules/${f.id}/templates/autocompleter.hbs`,e.popOut=!1,e.resizable=!1,e.height="auto",e}retarget(e){this._editor=e,this.render()}async getData(){var s,t,i;return{...await super.getData(),location:this._location,docTypes:c,singleAtWaiting:this._currentMode===a.singleAtWaiting,docSearch:this._currentMode===a.docSearch,journalPageSearch:this._currentMode===a.journalPageSearch,journalName:(s=this._selectedJournal)==null?void 0:s.name,docType:(t=c.find(o=>o.type===this._searchDocType))==null?void 0:t.searchName,highlightedEntry:this._focusedMenuKey,searchResults:this._filteredSearchResults,shownFilter:this._shownFilter,hasMore:(this._lastPulledRowCount||0)>(((i=this._filteredSearchResults)==null?void 0:i.length)||0)}}activateListeners(e){super.activateListeners(e);const s=e[0],t=s.querySelector("#acm-wrapper");t.focus(),t.addEventListener("keydown",this._onKeydown);const i=s.querySelectorAll(".acm-data-entry");for(let r=0;r<i.length;r++)i[r].addEventListener("click",this._onListClick),i[r].addEventListener("mouseover",this._onListMouseover);const o=r=>{const u=document.querySelector("#acm-wrapper");u?u.contains(r.target)||this.close():document.removeEventListener("pointerdown",this._onPointerDown)};this._onPointerDown&&document.removeEventListener("pointerdown",this._onPointerDown),this._onPointerDown=o,document.addEventListener("pointerdown",o)}async render(e){return await super.render(e)}async close(e={}){const s=document.querySelector(".acm-autocomplete");return s&&(s.style.display="none"),document.removeEventListener("pointerdown",this._onPointerDown),this._onClose&&this._onClose(),super.close(e)}_getFilteredSearchResults(){const e=w.get(y.resultLength);let s;return s=this._lastPulledSearchResults,s.slice(0,e)}async _pullData(){if(this._searchDocType===null){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[],this._lastPulledRowCount=0;return}this._lastPulledFilter=this._shownFilter,this._lastPulledType=this._searchDocType;const e=c.find(i=>i.type===this._searchDocType);if(!(e!=null&&e.collectionName)){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[];return}const s=d()[e.collectionName];let t;t=s.search({query:this._shownFilter,filters:[]}),t=t.filter(i=>i.name),this._lastPulledRowCount=t.length,this._lastPulledSearchResults=t.map(i=>({uuid:i.uuid,name:i.name,pages:this._searchDocType===h.Journal?i.pages:void 0}))}async _pullJournalData(){if(this._currentMode!==a.journalPageSearch){this._lastPulledFilter="",this._lastPulledType=null,this._lastPulledSearchResults=[],this._lastPulledRowCount=0;return}this._lastPulledFilter=this._shownFilter,this._lastPulledType=null;const e=this._selectedJournal.pages;if(!e)return;let s;s=e.search({query:this._shownFilter,filters:[]}),s=s.filter(t=>t.name),this._lastPulledRowCount=s.length,this._lastPulledSearchResults=s.map(t=>({uuid:t.uuid,name:t.name,pages:null}))}async _moveToDocSearch(e){this._currentMode=a.docSearch,this._searchDocType=e,this._shownFilter="",this._focusedMenuKey=0,await this._refreshSearch()}_insertReferenceAndClose(e){this._insertTextAndClose(`@UUID[${e}]`)}_insertTextAndClose(e){this._editor.focus(),document.execCommand("insertText",!1,e),this.close()}async _createDocument(e){const s=c.find(m=>m.type===e);if(!s)return;const t=d()[s.collectionName],i={folder:void 0},o={width:320,left:300,top:300},r=document.getSelection(),u=r!=null&&r.rangeCount?r==null?void 0:r.getRangeAt(0):null;getDocumentClass(t.documentName).createDialog(i,o).then(m=>{m&&(u&&(r==null||r.removeAllRanges(),r==null||r.addRange(u)),this._insertReferenceAndClose(m.uuid))}),this.close()}}function O(){Hooks.once("i18nInit",G)}async function G(){J()}let g=null;function W(){Hooks.once("init",q)}async function q(){j(new H),U()}function U(){jQuery(document).on("keydown",'.ProseMirror.editor-content[contenteditable="true"]',B)}function B(n){n.key==="@"&&(n.preventDefault(),$(n.target))}function $(n){g==null||g.close(),g=new z(n,()=>{g=null}),g.render(!0)}function Q(n,e){return typeof n=="number"&&typeof e=="number"?n+e:n}const X="acm";function Y(){Handlebars.registerHelper(`${X}-add`,Q)}function Z(){Hooks.once("ready",V)}async function V(){Y()}function ee(){W(),Z(),O()}Hooks.once("devModeReady",async({registerPackageDebugFlag:n})=>{n("autocomplete-mentions","boolean")});ee();
//# sourceMappingURL=index.js.map
