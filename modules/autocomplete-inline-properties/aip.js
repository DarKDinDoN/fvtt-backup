const t="autocomplete-inline-properties",e={ENTITY_DATA:"entity",DOCUMENT_DATA:"document",ROLL_DATA:"roll",OWNING_ACTOR_DATA:"owning-actor",OWNING_ACTOR_ROLL_DATA:"actor-roll",CUSTOM:"custom"},a={[e.ENTITY_DATA]:t=>t.object?.toObject(!1),[e.DOCUMENT_DATA]:t=>t.object?.toObject(!1),[e.ROLL_DATA]:t=>t.object?.getRollData(),[e.OWNING_ACTOR_DATA]:t=>_getSheetDocumentParentActor(t)?.toObject(!1)??function _getFallbackActorData(){if(!n){n={};for(const t of _getDummyActors())foundry.utils.mergeObject(n,t.toObject(!1))}return n}(),[e.OWNING_ACTOR_ROLL_DATA]:t=>_getSheetDocumentParentActor(t)?.getRollData()??_getFallbackActorRollData(),[e.CUSTOM]:(t,e)=>e(t)};function _getSheetDocumentParentActor(t){const e=t.object?.actor??t.object?.parent;return e&&e instanceof Actor?e:null}let o,n,i;function _getDummyActors(){if(!o){const t=getDocumentClass("Actor");o=game.system.template.Actor.types.map((e=>new t({type:e,name:"dummy"})))}return o}function _getFallbackActorRollData(){if(!i){i={};for(const t of _getDummyActors())foundry.utils.mergeObject(i,t.getRollData())}return i}const s=[{packageName:"dnd5e",sheetClasses:[{name:"ActorSheetFlags",fieldConfigs:["system","data"].flatMap((t=>[{selector:`input[type="text"][name^="${t}.bonuses"]`,showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA}]))},{name:"ItemSheet5e",fieldConfigs:["system","data"].flatMap((t=>[{selector:`.tab.details input[type="text"][name="${t}.attackBonus"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??_getFallbackActorRollData(t.object),inlinePrefix:"@"},{selector:`.tab.details input[type="text"][name^="${t}.damage"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??_getFallbackActorRollData(t.object),inlinePrefix:"@"},{selector:`.tab.details input[type="text"][name="${t}.formula"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??function _getFallbackParentItemRollData(t){const e=t.toObject(),a={},o=getDocumentClass("Item");for(const t of _getDummyActors()){const n=new o(e,{parent:t});foundry.utils.mergeObject(a,n.getRollData())}return a}(t.object),inlinePrefix:"@"}]))},{name:"ActiveEffectConfig",fieldConfigs:[{selector:'.tab[data-tab="effects"] .key input[type="text"]',defaultPath:"data",showButton:!0,allowHotkey:!0,dataMode:e.OWNING_ACTOR_DATA}]}]},{packageName:"pf1",sheetClasses:[{name:"ItemSheetPF",fieldConfigs:[{selector:'input.formula[type="text"]',showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA},{selector:"textarea.context-text",showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA}]},{name:"ActorSheetPF",fieldConfigs:[{selector:'input.formula[type="text"]',showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA},{selector:"textarea.context-text",showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA}]},{name:"ItemActionSheet",fieldConfigs:[{selector:'input.formula[type="text"]',showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA}]}]},{packageName:"sw5e",sheetClasses:[{name:"ActorSheetFlags",fieldConfigs:["system","data"].flatMap((t=>[{selector:`input[type="text"][name^="${t}.bonuses"]`,showButton:!0,allowHotkey:!0,dataMode:e.ROLL_DATA}]))},{name:"ItemSheet5e",fieldConfigs:["system","data"].flatMap((t=>[{selector:`.tab.details input[type="text"][name="${t}.attackBonus"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??_getFallbackActorRollData(t.object),inlinePrefix:"@"},{selector:`.tab.details input[type="text"][name^="${t}.damage"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??_getFallbackActorRollData(t.object),inlinePrefix:"@"},{selector:`.tab.details input[type="text"][name="${t}.formula"]`,showButton:!0,allowHotkey:!0,dataMode:e.CUSTOM,customDataGetter:t=>t.object.getRollData()??_getFallbackActorRollData(t.object),inlinePrefix:"@"}]))},{name:"ActiveEffectConfig",fieldConfigs:[{selector:'.tab[data-tab="effects"] .key input[type="text"]',defaultPath:"data",showButton:!0,allowHotkey:!0,dataMode:e.OWNING_ACTOR_DATA}]}]},{packageName:"ds4",sheetClasses:[{name:"ActiveEffectConfig",fieldConfigs:[{selector:'.tab[data-tab="effects"] .key input[type="text"]',defaultPath:"data",showButton:!0,allowHotkey:!0,dataMode:e.OWNING_ACTOR_DATA},{selector:'.tab[data-tab="effects"] .value input[type="text"]',defaultPath:"data",showButton:!0,allowHotkey:!0,dataMode:e.OWNING_ACTOR_DATA,inlinePrefix:"@"}]}]}];function getLoggingFunction(e="info"){const a=console[e];return"debug"===e?(...e)=>{game.settings.get(t,"debug")&&a("AIP","|",...e)}:(...t)=>a("AIP","|",...t)}const r=Object.freeze({debug:getLoggingFunction("debug"),info:getLoggingFunction("info"),warn:getLoggingFunction("warn"),error:getLoggingFunction("error"),getLoggingFunction});class Autocompleter extends Application{constructor(t,a,o,n,i,s){let l;switch(super(s),this.targetData=t,this.target=a,this.targetKey=o,this.filteredKeys=n.filteredKeys??null,this.mode=n.dataMode,void 0!==n.customInlinePrefix&&(r.warn("You are using customInlinePrefix which has been deprecated in favor of inlinePrefix and will be removed in a future version."),l=n.customInlinePrefix),l=n.inlinePrefix??l,this.mode){case e.ROLL_DATA:case e.OWNING_ACTOR_ROLL_DATA:this.keyPrefix=l??"@";break;default:this.keyPrefix=l??""}this.rawPath=n.defaultPath?.length?this._keyWithTrailingDot(n.defaultPath):"",this.onClose=i,this.selectedCandidateIndex=null,this.targetSelectionStart=null,this.targetSelectionEnd=null}static getData(t,{dataMode:o,customDataGetter:n=null}){o===e.ENTITY_DATA&&r.warn("You are using DATA_MODE.ENTITY_DATA which has been deprecated in favor of DATA_MODE.DOCUMENT_DATA and will be removed in a future version.");const i=a[o];if(!i)throw new Error(`Unrecognized data mode "${o}"`);return i(t,n)}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["autocompleter"],template:"./modules/autocomplete-inline-properties/templates/autocompleter.hbs",minWidth:300,height:"auto"})}get popOut(){return!0}_keyWithTrailingDot(t){const e=getProperty(this.targetData,t);return t+(e&&"object"==typeof e?".":"")}get inputElement(){return this.element?.[0]?.querySelector("input.aip-input")}get splitPath(){return this.rawPath.split(".")}get pathWithoutPartial(){return this.splitPath.slice(0,-1).join(".")}get _dataAtPath(){const t=this.pathWithoutPartial,e=t?.length?getProperty(this.targetData,t):this.targetData;return null==e?[]:Object.entries(e).map((([e,a])=>({key:t+(t.length?".":"")+e,value:a}))).filter((({key:t})=>!this.filteredKeys||!this.filteredKeys.some((e=>t.startsWith(e)))))}static _formatData({key:t,value:e}){let a;switch(typeof e){case"undefined":a=typeof e;break;case"object":a=e?"{}":"null";break;case"string":a=`"${e}"`;break;default:a=e.toString()}return{key:t,value:a}}get sortedDataAtPath(){return this._dataAtPath.sort(((t,e)=>"object"!=typeof t.value&&"object"!=typeof e.value?t.key.localeCompare(e.key):"object"!=typeof t.value?-1:"object"!=typeof e.value?1:t.key.localeCompare(e.key)))}get sortedDataAtPathFormatted(){return this.sortedDataAtPath.map(Autocompleter._formatData)}get currentBestMatch(){return this.sortedDataAtPath.find((({key:t})=>t.startsWith(this.rawPath)))}get indexOfCurrentBestMatch(){return this.sortedDataAtPath.map((({key:t})=>t)).indexOf(this.currentBestMatch?.key)}get selectedOrBestMatch(){return null!==this.selectedCandidateIndex?this.sortedDataAtPath[this.selectedCandidateIndex]:this.currentBestMatch}retarget(t){this.target=t,this.selectedCandidateIndex=null,this.render(!1),this.bringToTop()}getData(){const t="^"+this.rawPath.replace(/\./,"\\.");let e=this.selectedCandidateIndex;const a=this.sortedDataAtPathFormatted.map((({key:a,value:o},n)=>{const i=a.match(t)?.[0];if(!i)return{key:a,value:o};const s=a.slice(0,i.length),r=a.slice(i.length);return null===e&&(e=n),{key:`<span class="match">${s}</span>${r}`,value:o}}));return e=e??0,{keyPrefix:this.keyPrefix,path:this.rawPath,dataEntries:a,highlightedEntry:e}}activateListeners(t){super.activateListeners(t);const e=t[0],a=e.querySelector("input.aip-input");a.focus(),a.setSelectionRange(a.value.length,a.value.length),a.addEventListener("focusout",(()=>{this.close()})),a.addEventListener("input",this._onInputChanged.bind(this)),a.addEventListener("keydown",this._onInputKeydown.bind(this));e.querySelector("form.aip-form").addEventListener("submit",this._onSubmit.bind(this))}async _render(t=!1,e={}){const a=this.target.getBoundingClientRect();return mergeObject(this.position,{width:a.width,left:a.left}),super._render(t,e).then((t=>(this.setPosition({top:a.top-this.element[0].getBoundingClientRect().height-5}),this.bringToTop(),t)))}async _renderOuter(t){const e=await super._renderOuter(t);return e[0].querySelector("header.window-header").remove(),e}_replaceHTML(t,e){t.length&&t.find(".window-content").html(e)}async close(t={}){return this.onClose(),super.close(t)}_onInputChanged(){const t=this.inputElement;this.rawPath=t.value,this.selectedCandidateIndex=null,this.render(!1)}_onInputKeydown(t){switch(t.key){case"Escape":return void this.close();case"ArrowUp":return t.preventDefault(),t.stopPropagation(),this.selectedCandidateIndex=this.sortedDataAtPath.length>0?((this.selectedCandidateIndex??this.indexOfCurrentBestMatch)+1)%this.sortedDataAtPath.length:null,void this.render(!1);case"ArrowDown":return t.preventDefault(),t.stopPropagation(),this.selectedCandidateIndex=this.sortedDataAtPath.length>0?((this.selectedCandidateIndex??this.indexOfCurrentBestMatch)-1+this.sortedDataAtPath.length)%this.sortedDataAtPath.length:null,void this.render(!1);case"Tab":{t.preventDefault(),t.stopPropagation();const e=this.selectedOrBestMatch;return e?this.rawPath=this._keyWithTrailingDot(e.key):(ui.notifications.warn(`The key "${this.rawPath}" does not match any known keys.`),this.rawPath=""),this.selectedCandidateIndex=null,void this.render(!1)}}}async _onSubmit(t){t.preventDefault();const e=this.target.value;let a=e.length,o=e.length;Number.isNumeric(this.targetSelectionStart)&&Number.isNumeric(this.targetSelectionEnd)&&(a=Math.min(this.targetSelectionStart,this.targetSelectionEnd),o=Math.max(this.targetSelectionStart,this.targetSelectionEnd));const n=e.slice(0,a),i=n.length&&" "!==n[n.length-1]?" ":"",s=e.slice(o),r=s.length&&" "!==s[s.length-1]?" ":"",l=this.selectedOrBestMatch?.key??this.inputElement.value,c=`${i}${this.keyPrefix}${l}${r}`;this.target.focus(),await this.close();const u=new InputEvent("input",{bubbles:!0,data:c,inputType:"insertText",cancelable:!0});this.target.dispatchEvent(u)&&(this.target.value=`${n}${c}${s}`)}}function registerFieldConfigs(t,e){for(const a of e)registerFieldConfig(t,a)}let l=null,c=null;function registerFieldConfig(t,e){const a=t._element?.[0];a||r.debug("Application does not have an HTML element, skipping registering field.",t,e);try{if(!Autocompleter.getData(t,e))return void r.debug("Specified data for field not found",t,e)}catch(a){return void r.error("Error registering AIP field",a,t,e)}const o=Array.from(a.querySelectorAll(e.selector)).filter((t=>"TEXTAREA"===t.tagName||"INPUT"===t.tagName&&"text"===t.type));for(const n of o){const o=t.appId+n.name;_removeOldEventListeners(n),e.showButton&&!n.disabled&&(n.addEventListener("mouseenter",n.aipOnMouseEnter=function onMouseEnter(){c||(c=document.createElement("button"),c.classList.add("autocompleter-summon"),c.innerHTML='<i class="fas fa-at autocompleter-summon-icon"></i>',document.body.appendChild(c));const a=n.getBoundingClientRect();c.style.width=a.height-4+"px",c.style.height=a.height-4+"px",c.style.top=a.top+2+"px";const i=c.getBoundingClientRect();c.style.left=a.right-i.height-4+"px",c.firstElementChild.style.fontSize=i.height-8+"px",c.addEventListener("click",(function(a){a.preventDefault(),_activateAutocompleter(n,o,e,t)})),c.addEventListener("mouseout",(t=>{t.relatedTarget?.closest("i.autocompleter-summon-icon")||t.relatedTarget?.closest(e.selector)||t.relatedTarget?.closest("button.autocompleter-summon")||_removeSummonerButton()}))},!1),n.addEventListener("mouseout",n.aipOnMouseOut=function onMouseOut(t){n.clearAIPOnMouseOut=function(){n.removeEventListener("mouseout",onMouseOut)},t.relatedTarget?.closest("button.autocompleter-summon")||_removeSummonerButton()},!1),n.addEventListener("input",_removeSummonerButton),a.addEventListener("wheel",_removeSummonerButton,{passive:!0})),e.allowHotkey&&n.addEventListener("keydown",n.aipOnKeyDown=function onKeyDown(a){"@"===a.key&&(a.preventDefault(),_activateAutocompleter(n,o,e,t))},!1),l?.targetKey===o&&l.retarget(n)}}function _removeOldEventListeners(t){void 0!==t.aipOnMouseEnter&&(t.removeEventListener("mouseenter",t.aipOnMouseEnter,!1),delete t.aipOnMouseEnter),void 0!==t.aipOnMouseOut&&(t.removeEventListener("mouseout",t.aipOnMouseOut,!1),delete t.aipOnMouseOut),void 0!==t.aipOnKeyDown&&(t.removeEventListener("keydown",t.aipOnKeyDown,!1),delete t.aipOnKeyDown)}function _removeSummonerButton(){c?.remove(),c=null}function _activateAutocompleter(t,e,a,o){l?.close();const n=Autocompleter.getData(o,a);l=new Autocompleter(n,t,e,a,(()=>{l=null})).render(!0)}const u={CONST:{DATA_MODE:e,DATA_GETTERS:a},PACKAGE_CONFIG:s,refreshPackageConfig:function refreshPackageConfig(t,e){const a=s.filter((t=>(t.packageName===game.system.id||game.modules.get(t.packageName)?.active)&&(void 0===e||e===t.packageName))),o=t.constructor._getInheritanceChain().map((t=>t.name));registerFieldConfigs(t,a.flatMap((t=>t.sheetClasses)).filter((t=>o.includes(t.name))).flatMap((t=>t.fieldConfigs)))}};function init(){!function defineAPI(){game.modules.get(t).API=u}(),function registerSettings(){game.settings.register(t,"debug",{name:"AIP.DebugName",hint:"AIP.DebugHint",scope:"client",config:!0,type:Boolean,default:!1})}()}function setup(){CONFIG.debug.aip=!1,r.info("Setting up Autocomplete Inline Properties"),Hooks.callAll("aipSetup",s),function registerFields(t){t.find((t=>t.packageName===game.system.id))||ui.notifications.warn(game.i18n.localize("AIP.SystemNotSupported"));for(const e of t)if(e.packageName===game.system.id||game.modules.get(e.packageName)?.active)for(const t of e.sheetClasses)r.debug(`Registering for "render${t.name}" hook event`),Hooks.on(`render${t.name}`,(e=>{registerFieldConfigs(e,t.fieldConfigs)}))}(s),Hooks.callAll("aipReady")}!function registerForHooks(){!function registerForInitHook(){Hooks.on("init",init)}(),function registerForSetupHook(){Hooks.on("setup",setup)}()}();
//# sourceMappingURL=aip.js.map
