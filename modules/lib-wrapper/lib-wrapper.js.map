{"version":3,"file":"lib-wrapper.js","sources":["../src/errors/libWrapper-errors.js","../src/libWrapper-consts.js","../src/shared/libWrapper-enums.js","../src/shared/libWrapper-i18n.js","../src/shared/libWrapper-polyfill.js","../src/shared/libWrapper-package_info.js","../src/utils/libWrapper-misc.js","../src/errors/libWrapper-error-utils.js","../src/errors/libWrapper-base_errors.js","../src/ui/libWrapper-notifications.js","../src/ui/libWrapper-stats.js","../src/ui/libWrapper-conflicts.js","../src/errors/libWrapper-api_errors.js","../src/errors/listeners.js","../src/shared/libWrapper-version.js","../src/lib/libWrapper-enums.js","../src/lib/libWrapper-wrapper.js","../src/ui/libWrapper-settings.js","../src/lib/libWrapper-api.js"],"sourcesContent":["// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\n// Object that contains the error classes that libWrapper should use.\n// This is used to avoid cyclic dependencies, and is what should be imported by files outside the 'errors' folder.\nexport const ERRORS = {\n    base              : Error,\n    internal          : Error,\n    package           : Error,\n    already_overridden: Error,\n    invalid_chain     : Error\n};\nObject.seal(ERRORS);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\n\n//*********************\n// Package information\nexport const PACKAGE_ID    = 'lib-wrapper';\nexport const PACKAGE_TITLE = 'libWrapper';\nexport const HOOKS_SCOPE   = 'libWrapper';\n\n\n//*********************\n// Miscellaneous definitions\n\n// This allows rollup to strip out all unit-test code from the release artifact\n/*#if _ROLLUP\nexport const IS_UNITTEST = false;\n//#else */\nexport const IS_UNITTEST = (typeof Game === 'undefined');\n//#endif\n\nexport const PROPERTIES_CONFIGURABLE = IS_UNITTEST ? true : false;\n\n\n//*********************\n// Debug\nexport let DEBUG = false;\nexport function setDebug(new_debug) { DEBUG = new_debug; }","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-shared-library Rui Pinheiro\n\n'use strict';\n\n\nimport {PACKAGE_TITLE} from '../consts.js';\n\n\n// Enumeration Value factory\nexport const EnumValue = function(enum_cls, name, value, sort=true) {\n\t// Sanity check for a frozen object\n\tif(Object.isFrozen(enum_cls))\n\t\tthrow new Error(`${PACKAGE_TITLE}: Enum '${enum_cls.name}' is frozen.`);\n\n\t// Validate name\n\tif(name !== name.toUpperCase())\n\t\tthrow new Error(`${PACKAGE_TITLE}: Enum keys must be all uppercase.`);\n\n\t// We use an eval here to coerce the browser to display more readable console output\n\tconst value_cls = Function(\"x\", `return class ${name} extends x {}`)(enum_cls.value_cls);\n\tconst value_obj = new value_cls();\n\n\tif(value_obj.name != name)\n\t\tthrow new Error(`${PACKAGE_TITLE}: Incorrect value_obj name ${value_obj.name}. Expected ${name}.`);\n\n\t// If we were provided a value, add it\n\tif(value !== undefined)\n\t\tvalue_obj.value = value;\n\n\t// We always freeze the temporary value class we just created\n\tObject.freeze(value_obj);\n\tObject.freeze(value_obj.prototype);\n\tObject.freeze(value_obj.constructor);\n\tObject.freeze(value_obj.constructor.prototype);\n\n\t// Store instance into enum\n\tif(name in enum_cls)\n\t\tthrow new Error(`${PACKAGE_TITLE}: Name '${name}' is already present in ${enum_cls.name}.`);\n\tenum_cls[name] = value_obj;\n\n\t// Store value->object mapping too, if a value was provided\n\tif(value !== undefined) {\n\t\tif(enum_cls.reverse.has(value))\n\t\t\tthrow new Error(`${PACKAGE_TITLE}: Value '${value}' is already present in ${enum_cls.name}.`);\n\t\tenum_cls.reverse.set(value, value_obj);\n\t}\n\n\t// Store key into list of keys - no need to check for duplicates\n\tenum_cls.list.push(value_obj);\n\tif(sort)\n\t\tenum_cls.sort_list_by_value();\n\n\t// Done\n\treturn value_obj;\n}\n\n\n\n// Enumeration factory\nexport const Enum = function(name, collection, freeze=true) {\n\tlet value_cls;\n\n\t// Validate name\n\tif(typeof name !== \"string\")\n\t\tthrow new Error(`${PACKAGE_TITLE}: Enum name must be a string`);\n\n\t// Validate collection\n\tif(typeof collection !== \"object\")\n\t\tthrow new Error(`${PACKAGE_TITLE}: Enum collection must be a dictionary or an array`);\n\n\tconst has_value = !(collection instanceof Array);\n\n\t// Enum class\n\tconst enum_name = `${name}Enum`;\n\tconst enum_cls = {\n\t\t[enum_name]: class {\n\t\t\tconstructor(value, dflt=undefined) {\n\t\t\t\treturn this.constructor.get(value, dflt);\n\t\t\t}\n\n\t\t\tstatic get(value, dflt=undefined) {\n\t\t\t\t// If passing an enum value object directly, just return it\n\t\t\t\tif(value instanceof value_cls)\n\t\t\t\t\treturn value;\n\n\t\t\t\t// If passing a key, return the corresponding object\n\t\t\t\tif(typeof value === \"string\") {\n\t\t\t\t\tconst res = this[value.toUpperCase()];\n\t\t\t\t\tif(res)\n\t\t\t\t\t\treturn res;\n\t\t\t\t}\n\n\t\t\t\t// If we got something else, this might be the actual enum \"value\" field, so try using the 'reverse' Map\n\t\t\t\t{\n\t\t\t\t\tconst reverse = this.reverse.get(value);\n\t\t\t\t\tif(reverse !== undefined)\n\t\t\t\t\t\treturn reverse;\n\t\t\t\t}\n\n\t\t\t\t// Fail or return default value\n\t\t\t\tif(dflt === undefined)\n\t\t\t\t\tthrow new Error(`${PACKAGE_TITLE}: '${value}' is not a valid key or value for the enum ${name}.`);\n\n\t\t\t\treturn dflt;\n\t\t\t}\n\n\t\t\tstatic has(value) {\n\t\t\t\treturn (value instanceof value_cls);\n\t\t\t}\n\n\t\t\tstatic toString() {\n\t\t\t\treturn this.name;\n\t\t\t}\n\n\t\t\tstatic get value_cls() {\n\t\t\t\treturn value_cls;\n\t\t\t}\n\n\t\t\tstatic sort_list_by_value() {\n\t\t\t\treturn this.list.sort(function(a,b){\n\t\t\t\t\treturn (a.value ?? 0) - (b.value ?? 0);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}[enum_name];\n\n\t// Value Class\n\t// Note: We need to use an eval here in order to coerce the browser to have the correct class name... Other tricks don't work.\n\tconst value_cls_name = `${name}Value`;\n\tvalue_cls = {\n\t\t[value_cls_name]: class {\n\t\t\tstatic toString() {\n\t\t\t\treturn value_cls_name;\n\t\t\t}\n\n\t\t\tget name() {\n\t\t\t\treturn this.constructor.name;\n\t\t\t}\n\n\t\t\tget enum() {\n\t\t\t\treturn enum_cls;\n\t\t\t}\n\n\t\t\ttoString() {\n\t\t\t\treturn this.name;\n\t\t\t}\n\n\t\t\tget lower() {\n\t\t\t\treturn this.name.toLowerCase();\n\t\t\t}\n\t\t}\n\t}[value_cls_name];\n\n\t// We always freeze the value class\n\tObject.freeze(value_cls);\n\tObject.freeze(value_cls.prototype);\n\n\t// Extra Enum Class members\n\tenum_cls.list    = [];\n\n\tif(has_value)\n\t\tenum_cls.reverse = new Map();\n\n\t// Construct enum values\n\tif(collection instanceof Array) {\n\t\tfor(const key of collection) {\n\t\t\tEnumValue(enum_cls, key, undefined, /*sort=*/false);\n\t\t}\n\t}\n\telse {\n\t\tfor(const key in collection) {\n\t\t\tEnumValue(enum_cls, key, collection[key], /*sort=*/false);\n\t\t}\n\t}\n\n\tenum_cls.sort_list_by_value();\n\n\t// Freeze everything\n\tif(freeze) {\n\t\tObject.freeze(enum_cls);\n\t\tObject.freeze(enum_cls.prototype);\n\t\tObject.freeze(enum_cls.list);\n\n\t\tif(has_value)\n\t\t\tObject.freeze(enum_cls.reverse);\n\t}\n\n\t// Done\n\treturn enum_cls;\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-shared-library Rui Pinheiro\n\n'use strict';\n\nimport { IS_UNITTEST, PACKAGE_ID, PACKAGE_TITLE } from \"../consts.js\";\n\n\n// We want to load the EN language by default, in order to use it for polyfill while i18n hasn't loaded yet\n// The import/fetch below will allow Rollup, with rollup-plugin-json and rollup-plugin-jscc, to directly include the JSON contents into the build artifact\n// but also still allow libWrapper to work fine without the rollup step.\n\n/*#if _ROLLUP\nimport en_json from '../../lang/en.json';\nconst i18nLangs = $_I18N_LANGS;\nconst langBaseUrl = (!import.meta?.url?.endsWith(`dist/${PACKAGE_ID}.js`)) ? './lang' : '../lang';\n//#else */\nconst langBaseUrl = '../../lang';\nlet en_json;\nif(IS_UNITTEST) {\n\t// Use readFileSync, supported by node\n\tconst fs = await import('fs');\n\tconst en_file = fs.readFileSync('lang/en.json'); // readFileSync does not use a relative path\n\ten_json = JSON.parse(en_file);\n}\nelse {\n\t// Use fetch - supported by browsers\n\tconst request = await fetch(new URL(`${langBaseUrl}/en.json`, import.meta.url));\n\ten_json = await request.json();\n}\n//#endif\n\n\n// Polyfill game.i18n until libWrapper initialises\nexport class i18n {\n\tstatic async _fetch(lang) {\n\t\t/*#if _ROLLUP\n\t\t// Avoid unnecessary requests if we know they're just going to 404\n\t\tif(Array.isArray(i18nLangs) && !i18nLangs.includes(lang))\n\t\t\treturn null;\n\t\t//#endif */\n\n\t\t// Fetch language JSONs, if any\n\t\ttry {\n\t\t\tconst url = new URL(`${langBaseUrl}/${lang}.json`, import.meta.url);\n\n\t\t\tconst request = await fetch(url);\n\t\t\tif(request.status !== 200 || !request.ok)\n\t\t\t\treturn null;\n\n\t\t\treturn request.json();\n\t\t}\n\t\tcatch(e) {\n\t\t\tconsole.warn(`${PACKAGE_TITLE}: Failed to load or parse ${url.href}.`, e);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tstatic async init() {\n\t\t// Default members\n\t\tthis.jsons = [];\n\n\t\t// Load languages\n\t\tconst langs = [];\n\n\t\ttry {\n\t\t\t// client-scoped setting, but we do this before game.settings has initialised so have to grab it manually\n\t\t\tconst clientLanguageSetting = localStorage?.['core.language'];\n\t\t\tif(clientLanguageSetting) {\n\t\t\t\tconst clientLanguage = JSON.parse(clientLanguageSetting);\n\t\t\t\tif(clientLanguage && clientLanguage !== 'en')\n\t\t\t\t\tlangs.push(clientLanguage);\n\t\t\t}\n\t\t}\n\t\tcatch(e) {\n\t\t\tconsole.debug(`${PACKAGE_TITLE}: Could not find or parse client language settings.`);\n\t\t}\n\n\t\tconst serverLanguage = game?.i18n?.lang;\n\t\tif(serverLanguage && serverLanguage !== 'en')\n\t\t\tlangs.push(serverLanguage);\n\n\t\t// Fetch language JSONs\n\t\tif(langs.length > 0) {\n\t\t\t// Await all fetches\n\t\t\tconst results = await Promise.all(langs.map((x)=>this._fetch(x)));\n\n\t\t\t// Store the valid results in this.jsons\n\t\t\tfor(const json of results) {\n\t\t\t\tif(json)\n\t\t\t\t\tthis.jsons.push(json);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic localize(key) {\n\t\t// Try real i18n library\n\t\tif(game?.i18n) {\n\t\t\tconst res = game.i18n.localize(key);\n\t\t\tif(res !== key)\n\t\t\t\treturn res;\n\t\t}\n\n\t\t// Fallback to polyfill\n\t\ttry {\n\t\t\tconst split = key.split('.');\n\n\t\t\t// Try main language first\n\t\t\tif(this.jsons) {\n\t\t\t\tfor(const json of this.jsons) {\n\t\t\t\t\tconst res = split.reduce((x,y) => x?.[y], json);\n\t\t\t\t\tif(res)\n\t\t\t\t\t\treturn res;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Default to just returning the key\n\t\t\treturn split.reduce((x,y) => x?.[y], en_json) ?? key;\n\t\t}\n\t\tcatch(e) {\n\t\t\tconsole.error(e);\n\t\t\treturn key;\n\t\t}\n\t}\n\n\tstatic format(key, args) {\n\t\t// Try real i18n library\n\t\tif(game?.i18n) {\n\t\t\tconst res = game.i18n.format(key, args);\n\t\t\tif(res !== key)\n\t\t\t\treturn res;\n\t\t}\n\n\t\t// Fallback to polyfill\n\t\tconst localize = this.localize(key);\n\t\tif(localize === key)\n\t\t\treturn localize;\n\n\t\ttry {\n\t\t\treturn localize.replace(/\\{(.*?)\\}/g, (_,y) => args?.[y]);\n\t\t}\n\t\tcatch(e) {\n\t\t\tconsole.error(e);\n\t\t\treturn key;\n\t\t}\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-shared-library Rui Pinheiro\n\n'use strict';\n\nimport { ERRORS } from '../errors/errors.js';\n\n\n// game.user.data polyfill, so it can be used before 'ready'\nexport const game_user_data = function(return_null=false) {\n\t// Try game.user.data first\n\tconst orig_game_user_data = game?.user?.data;\n\tif(orig_game_user_data)\n\t\treturn orig_game_user_data;\n\n\t// Grab the user ID\n\tconst userid = game.userId ?? game.data.userId;\n\tif(!userid) {\n\t\tif(return_null)\n\t\t\treturn null;\n\t\tthrow new ERRORS.internal(\"Unable to obtain the current user ID\");\n\t}\n\n\t// Find user in game.data.users\n\tconst user_data = game.data.users.find((x) => { return x._id == userid });\n\tif(!user_data) {\n\t\tif(return_null)\n\t\t\treturn null;\n\t\tthrow new ERRORS.internal(\"Unable to obtain the current user data object\");\n\t}\n\n\t// Done\n\treturn user_data;\n}\n\n// game.user.can polyfill, so it can be used before 'ready'\nexport const game_user_can = function(action, return_null=false) {\n\t// Try game.user.can first\n\tconst orig_game_user_can = game?.user?.can;\n\tif(orig_game_user_can)\n\t\treturn orig_game_user_can(action);\n\n\t// Obtain game.user.data\n\tconst user_data = game_user_data(return_null);\n\tif(!user_data)\n\t\treturn null;\n\n\t// Check if user is GM\n\tif(user_data.role === 4)\n\t\treturn true;\n\n\t// Check if the action is in the per-user permissions\n\tif(action in user_data.permissions) return user_data.permissions[action];\n\n\t// Otherwise, check the role's permissions\n\tconst game_permissions_str = game.data.settings.find((x) => { return x.key === 'core.permissions'});\n\tif(game_permissions_str?.value) {\n\t\tconst game_permissions = JSON.parse(game_permissions_str.value);\n\n\t\tconst rolePerms = game_permissions[action];\n\t\tif(rolePerms && rolePerms.includes(user_data.role))\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// game.user.isGM polyfill, so it can be used before 'ready'\nexport const game_user_isGM = function(return_null=false) {\n\t// Try game.user.isGM first\n\tconst orig_game_user_isGM = game?.user?.isGM;\n\tif(orig_game_user_isGM !== undefined)\n\t\treturn orig_game_user_isGM;\n\n\t// Obtain game.user.data\n\tconst user_data = game_user_data(return_null);\n\tif(!user_data)\n\t\treturn null;\n\n\t// Done\n\treturn user_data.role === 4;\n}\n\n// Polyfill to get the Foundry version\nexport const game_release_display = function(return_null=true) {\n\tconst display =\n\t\tgame?.release?.display ??\n\t\tgame?.version          ??\n\t\tgame?.data?.version    ??\n\t\tnull\n\t;\n\n\tif(!return_null && display === null)\n\t\tthrow new ERRORS.internal(\"Unable to obtain the Foundry display version\");\n\n\treturn display;\n}\n\nexport const game_version = function(return_null=true) {\n\tconst version =\n\t\tgame?.version          ??\n\t\tgame?.release?.version ??\n\t\tgame?.data?.version    ??\n\t\tnull\n\t;\n\n\tif(!return_null && version === null)\n\t\tthrow new ERRORS.internal(\"Unable to obtain the Foundry version\");\n\n\treturn version;\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-shared-library Rui Pinheiro\n\n'use strict';\n\nimport {PACKAGE_ID, PACKAGE_TITLE} from '../consts.js';\nimport {Enum} from './enums.js';\nimport {i18n} from './i18n.js';\nimport {game_version} from './polyfill.js';\n\n\n//*********************\n// ID types\nexport const PACKAGE_TYPES = Enum('PackageType', [\n\t\"UNKNOWN\",\n\t\"MODULE\",\n\t\"SYSTEM\",\n\t\"WORLD\"\n]);\n\n\n//*********************\n// Constants\nconst MAIN_KEY_SEPARATOR = ':';\nconst KEY_SEPARATORS = [':','~'];\nconst UNKNOWN_ID = '\\u00ABunknown\\u00BB';\nconst PACKAGE_ID_REGEX = new RegExp(\"^[a-z0-9_-]+$\", \"i\");\nconst STACK_TRACE_REGEX = /^.*?\\/(worlds|systems|modules)\\/(.+?)(?=\\/).*?$/igm;\n\n// A package ID string, or an array of package ID strings, that should be ignored when automatically detecting the package ID based on a stack trace.\n// Not set as a constant, so that a default value can be set by the user\nexport let IGNORE_PACKAGE_IDS = PACKAGE_ID;\n\n\n//*********************\n// Utility methods\nconst foreach_package_in_stack_trace = function(matchFn, stack_trace, ignore_ids) {\n\t// Collect stack trace if none passed\n\tif(stack_trace === undefined) {\n\t\tconst old_stack_limit = Error.stackTraceLimit;\n\n\t\ttry {\n\t\t\tError.stackTraceLimit = Infinity;\n\t\t\tstack_trace = Error().stack;\n\t\t}\n\t\tfinally {\n\t\t\tError.stackTraceLimit = old_stack_limit;\n\t\t}\n\t}\n\n\tif(!stack_trace || typeof stack_trace !== 'string')\n\t\tthrow new Error(`${PACKAGE_TITLE}: Could not collect stack trace.`);\n\n\t// Apply regex onto stack trace\n\tconst matches = stack_trace.matchAll(STACK_TRACE_REGEX);\n\tif(!matches)\n\t\treturn;\n\n\t// Find matches\n\tfor(const match of matches) {\n\t\tconst type = match[1];\n\t\tconst name = match[2];\n\n\t\tif(!type || !name)\n\t\t\tcontinue;\n\n\t\t// Check for match\n\t\tlet match_id, match_type;\n\n\t\tif(type === 'worlds') {\n\t\t\tconst game_world_id = game?.data?.world?.id;\n\t\t\tif(game_world_id && name != game_world_id)\n\t\t\t\tcontinue;\n\n\t\t\tmatch_id   = name;\n\t\t\tmatch_type = PACKAGE_TYPES.WORLD;\n\t\t}\n\t\telse if(type === 'systems') {\n\t\t\tconst game_system_id = game?.data?.system?.id;\n\t\t\tif(game_system_id && name != game_system_id)\n\t\t\t\tcontinue;\n\n\t\t\tmatch_id   = name;\n\t\t\tmatch_type = PACKAGE_TYPES.SYSTEM;\n\t\t}\n\t\telse if(type === 'modules') {\n\t\t\tif(game?.modules && !game.modules.has(name))\n\t\t\t\tcontinue;\n\n\t\t\tif(ignore_ids && (name === ignore_ids || ignore_ids?.includes?.(name)))\n\t\t\t\tcontinue;\n\n\t\t\tmatch_id   = name;\n\t\t\tmatch_type = PACKAGE_TYPES.MODULE;\n\t\t}\n\t\telse {\n\t\t\tthrow new Error(`${PACKAGE_TITLE}: Invalid script type: ${type}`);\n\t\t}\n\n\t\t// On match, call matchFn, and return if it returns 'false'\n\t\tconst matchRes = matchFn(match_id, match_type, match[0]);\n\t\tif(matchRes === false)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n\n//*********************\n// Package info class\n// Stores package information. Able to auto-detect the package ID that is calling libWrapper.\nexport class PackageInfo {\n\t/*\n\t * Static methods\n\t */\n\tstatic get UNKNOWN() {\n\t\treturn new PackageInfo(UNKNOWN_ID, PACKAGE_TYPES.UNKNOWN);\n\t};\n\n\tstatic collect_all(stack_trace=undefined, include_fn=undefined, ignore_ids=undefined) {\n\t\t// Collect a set of all packages in the stack trace\n\t\tconst set = new Set();\n\n\t\tforeach_package_in_stack_trace((id, type, match) => {\n\t\t\tconst key = `${type.lower}${MAIN_KEY_SEPARATOR}${id}`; // see 'get key' below\n\n\t\t\tif(set.has(key))\n\t\t\t\treturn true;\n\n\t\t\tif(include_fn !== undefined && !include_fn(id, type, match))\n\t\t\t\t\treturn true;\n\n\t\t\tset.add(key);\n\t\t\treturn true;\n\t\t}, stack_trace, ignore_ids);\n\n\t\t// Convert the set into an array of PackageInfo objects\n\t\tconst modules = [];\n\n\t\tfor(const key of set)\n\t\t\tmodules.push(new PackageInfo(key));\n\n\t\t// Done\n\t\treturn modules;\n\t}\n\n\tstatic is_valid_id(id) {\n\t\tif(!id || typeof id !== 'string')\n\t\t\treturn false;\n\n\t\tif(!PACKAGE_ID_REGEX.test(id))\n\t\t\treturn false;\n\n\t\treturn true;\n\t}\n\n\n\t/*\n\t * Constructor\n\t */\n\tconstructor(id=null, type=null) {\n\t\tthis.set(id, type);\n\t}\n\n\n\t/*\n\t * Member methods\n\t */\n\tset(id=null, type=null, freeze=true) {\n\t\t// Auto-detect the ID\n\t\tif(!id)\n\t\t\treturn this.detect_id();\n\n\t\t// Sanity check the ID\n\t\tif(typeof id !== 'string')\n\t\t\tthrow new Error(`${PACKAGE_TITLE}: PackageInfo IDs must be strings`);\n\n\t\t// Handle unknown package\n\t\tif(id === UNKNOWN_ID) {\n\t\t\tthis.set_unknown();\n\t\t\treturn;\n\t\t}\n\n\t\t// If we need to auto-detect the type, and find a key separator, we should parse the ID as a key instead\n\t\tif(type === null) {\n\t\t\tif(this.from_key(id, /*fail=*/false))\n\t\t\t\treturn; // from_key returning 'true' means that it succeeded and has called set(id, type) successfuly\n\t\t}\n\n\t\t// Validate ID\n\t\tif(!this.constructor.is_valid_id(id))\n\t\t\tthrow new Error(`${PACKAGE_TITLE}: Invalid package ID '${id}'`);\n\n\t\t// Validate type\n\t\tif(type !== null && !PACKAGE_TYPES.has(type))\n\t\t\tthrow new Error(`${PACKAGE_TITLE}: Package type for '${id}' must belong to the PACKAGE_TYPES enum, but got '${type}'.`);\n\n\t\t// Store in instance\n\t\tthis.id = id;\n\t\tthis.type = type;\n\n\t\t// Detect type automatically, if necessary\n\t\tif(!type)\n\t\t\tthis.detect_type();\n\n\t\t// Freeze if requested\n\t\tif(freeze)\n\t\t\tObject.freeze(this);\n\t}\n\n\tset_unknown() {\n\t\tthis.id = UNKNOWN_ID;\n\t\tthis.type = PACKAGE_TYPES.UNKNOWN;\n\t}\n\n\tequals(obj) {\n\t\treturn obj && (obj.constructor === this.constructor) && (obj.id === this.id) && (obj.type === this.type);\n\t}\n\n\tdetect_id(stack_trace=undefined) {\n\t\tthis.set_unknown();\n\n\t\tforeach_package_in_stack_trace((id, type) => {\n\t\t\tthis.set(id, type);\n\t\t\treturn false; // stop on first match\n\t\t}, stack_trace, IGNORE_PACKAGE_IDS);\n\t}\n\n\tdetect_type() {\n\t\t// We need to support this even when 'game.modules' hasn't been initialised yet\n\t\tif(!game?.modules) {\n\t\t\tif(this.id === PACKAGE_ID)\n\t\t\t\tthis.type = PACKAGE_TYPES.MODULE;\n\t\t\telse\n\t\t\t\tthis.type = PACKAGE_TYPES.UNKNOWN;\n\n\t\t\treturn;\n\t\t}\n\n\t\tif(game.modules?.get(this.id)?.active)\n\t\t\tthis.type = PACKAGE_TYPES.MODULE;\n\t\telse if(this.id === game.data?.system?.id)\n\t\t\tthis.type = PACKAGE_TYPES.SYSTEM;\n\t\telse if(this.id === game.data?.world?.id)\n\t\t\tthis.type = PACKAGE_TYPES.WORLD;\n\t\telse\n\t\t\tthis.type = PACKAGE_TYPES.UNKNOWN;\n\t}\n\n\n\t// Conversion to/from key\n\tfrom_key(key, fail=true) {\n\t\tlet split;\n\t\tfor(const sep of KEY_SEPARATORS) {\n\t\t\tsplit = key.split(sep);\n\t\t\tif(split.length === 2)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif(split.length !== 2) {\n\t\t\tif(fail)\n\t\t\t\tthrow new Error(`${PACKAGE_TITLE}: Invalid key '${key}'`);\n\t\t\treturn false;\n\t\t}\n\n\t\tconst id   = split[1];\n\t\tconst type = PACKAGE_TYPES[split[0]];\n\n\t\tthis.set(id, type);\n\n\t\treturn true;\n\t}\n\n\t// Cast to string\n\ttoString() {\n\t\treturn this.key;\n\t}\n\n\n\t/*\n\t * Attributes\n\t */\n\tget known() {\n\t\treturn this.type != PACKAGE_TYPES.UNKNOWN;\n\t}\n\n\tget exists() {\n\t\tswitch(this.type) {\n\t\t\tcase PACKAGE_TYPES.MODULE:\n\t\t\t\treturn game.modules.get(this.id)?.active;\n\t\t\tcase PACKAGE_TYPES.SYSTEM:\n\t\t\t\treturn game.data.system.id === this.id;\n\t\t\tcase PACKAGE_TYPES.WORLD:\n\t\t\t\treturn game.data.world.id === this.id;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t}\n\n\tget data() {\n\t\tif(!this.exists)\n\t\t\treturn null;\n\n\t\tswitch(this.type) {\n\t\t\tcase PACKAGE_TYPES.MODULE:\n\t\t\t\treturn game.modules.get(this.id)?.data;\n\t\t\tcase PACKAGE_TYPES.SYSTEM:\n\t\t\t\treturn game.data.system.data;\n\t\t\tcase PACKAGE_TYPES.WORLD:\n\t\t\t\treturn game.data.world;\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}\n\n\tstatic get unknown_title() {\n\t\treturn i18n.localize(`${PACKAGE_ID}.packages.unknown-title`)\n\t}\n\n\tget title() {\n\t\tif(!this.exists)\n\t\t\treturn this.constructor.unknown_title;\n\n\t\tswitch(this.type) {\n\t\t\tcase PACKAGE_TYPES.MODULE:\n\t\t\tcase PACKAGE_TYPES.SYSTEM:\n\t\t\tcase PACKAGE_TYPES.WORLD :\n\t\t\t\treturn this.data.title;\n\t\t\tdefault:\n\t\t\t\treturn this.constructor.unknown_title;\n\t\t}\n\t}\n\n\tget key() {\n\t\treturn `${this.type.lower}${MAIN_KEY_SEPARATOR}${this.id}`;\n\t}\n\n\tget type_i18n() {\n\t\treturn i18n.localize(`${PACKAGE_ID}.packages.types.${this.type.lower}`);\n\t}\n\n\tget type_plus_id() {\n\t\treturn `${this.type.lower} ${this.id}`;\n\t}\n\n\tget type_plus_id_capitalized() {\n\t\tlet str = this.type_plus_id;\n\t\treturn str.charAt(0).toUpperCase() + str.slice(1);\n\t}\n\n\tget type_plus_id_i18n() {\n\t\treturn i18n.format(`${PACKAGE_ID}.packages.type-plus-id`, {type: this.type_i18n, id: this.id});\n\t}\n\n\tget type_plus_title() {\n\t\treturn `${this.type.lower} ${this.title}`;\n\t}\n\n\tget type_plus_title_i18n() {\n\t\treturn i18n.format(`${PACKAGE_ID}.packages.type-plus-title`, {type: this.type_i18n, title: this.title});\n\t}\n\n\tget logId() {\n\t\treturn (this.type == PACKAGE_TYPES.MODULE) ? this.id : this.key;\n\t}\n\n\tget settingsName() {\n\t\tswitch(this.type) {\n\t\t\tcase PACKAGE_TYPES.MODULE:\n\t\t\t\treturn this.id;\n\t\t\tcase PACKAGE_TYPES.SYSTEM:\n\t\t\t\treturn `${this.id} [System]`;\n\t\t\tcase PACKAGE_TYPES.WORLD:\n\t\t\t\treturn `${this.id} [World]`;\n\t\t\tdefault:\n\t\t\t\treturn this.id;\n\t\t}\n\t}\n\n\tget url() {\n\t\treturn this.data?.url;\n\t}\n\n\tget bugs() {\n\t\treturn this.data?.bugs;\n\t}\n\n\tget version() {\n\t\treturn this.data?.version;\n\t}\n\n\tget core_version_range() {\n\t\tconst data = this.data;\n\t\tif(!data)\n\t\t\treturn null;\n\n\t\treturn [data.minimumCoreVersion, data.compatibleCoreVersion];\n\t}\n\n\tget compatible_with_core() {\n\t\tconst versions = this.core_version_range;\n\t\tconst fvtt_version = game_version(/*return_null=*/ true);\n\t\tif(!versions || !fvtt_version)\n\t\t\treturn true; // assume it is compatible if we aren't sure\n\n\t\t// Check if the core version is between the minimum and maximum version\n\t\tconst [min, max] = versions;\n\n\t\t// Minimum version\n\t\tif(min && min !== fvtt_version && !isNewerVersion(fvtt_version, min))\n\t\t\treturn false;\n\n\t\t// Maximum version\n\t\tif(max && isNewerVersion(fvtt_version, max))\n\t\t\treturn false;\n\n\t\t// Done\n\t\treturn true;\n\t}\n}\nObject.freeze(PackageInfo);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {IS_UNITTEST} from '../consts.js';\n\n\n// HACK: The browser doesn't expose all global variables (e.g. 'Game') inside globalThis, but it does to an eval\n// We declare this helper here so that the eval does not have access to the anonymous function scope\nexport const global_eval = eval;\n\nexport function get_global_variable(varname) {\n\ttry {\n\t\treturn globalThis[varname] ?? global_eval(varname);\n\t}\n\tcatch (e) {\n\t\treturn undefined;\n\t}\n}\n\n\n// Change the name of a function object\n// Note: This is extremely hacky, and only works in some browsers, and only sometimes (usually when a function is anonymous)\nexport function set_function_name(fn, name) {\n\ttry {\n\t\t// Only supported by Firefox: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/displayName\n\t\tfn.displayName = name;\n\n\t\t// Hack: Try and over-ride the 'name' property\n\t\tObject.defineProperty(fn, 'name', {\n\t\t\tvalue: name,\n\t\t\twritable: false,\n\t\t\tenumerable: false,\n\t\t\tconfigurable: true\n\t\t});\n\t}\n\tcatch (e) {\n\t\t// disregard unless this is a unit test - probably unsupported by browser\n\t\tif(IS_UNITTEST)\n\t\t\tthrow e;\n\t}\n}\n\n// Decorate name\nexport function decorate_name(name, suffix='') {\n\tif(suffix !== '')\n\t\treturn `🎁${name}#${suffix}`;\n\telse\n\t\treturn `🎁${name}`;\n}\n\n// Decorate the name of all functions of a given class\n// Note: This is extremely hacky, and only works in some browsers, and only sometimes (usually when a function is anonymous)\nexport function decorate_class_function_names(klass) {\n\tconst props = Object.getOwnPropertyNames(klass);\n\tprops.push(...Object.getOwnPropertySymbols(klass))\n\n\tfor(const prop of props) {\n\t\tconst descriptor = Object.getOwnPropertyDescriptor(klass, prop);\n\n\t\tif(typeof descriptor.value === 'function')\n\t\t\tset_function_name(descriptor.value, decorate_name(prop));\n\t\tif(typeof descriptor.get === 'function')\n\t\t\tset_function_name(descriptor.get, decorate_name(prop, 'getter'));\n\t\tif(typeof descriptor.set === 'function')\n\t\t\tset_function_name(descriptor.set, decorate_name(prop, 'setter'));\n\t}\n\n\tif(klass.prototype)\n\t\tdecorate_class_function_names(klass.prototype);\n}\n\n\n// Shared list of active wrappers\nexport const WRAPPERS = new Set();","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport { PACKAGE_ID } from '../consts.js';\nimport { PackageInfo, PACKAGE_TYPES } from '../shared/package_info.js';\nimport { decorate_name } from '../utils/misc.js';\n\n\n/*\n * Utility methods for exceptions\n */\nexport function is_error_object(obj) {\n\t// We ignore anything that is not an object\n\tif(obj === null || obj === undefined || typeof obj !== 'object')\n\t\treturn false;\n\n\t// We figure out if this cause has a message and a stack frame - i.e. duck typing of an error object\n\tif(!('message' in obj) || !('stack' in obj))\n\t\treturn false;\n\n\t// This is (probably) an error\n\treturn true;\n}\n\n\nconst LIBWRAPPER_IGNORE_MATCHES = [\n\t'/listeners.js', // ignore anything in the listeners.js file\n\tdecorate_name('call_wrapped'), // shows up every time libWrapper is in the callstack\n\tdecorate_name('Application.prototype._render'), // has a libWrapper patch for unhandled error detection\n];\nfunction get_involved_packages(stack, ignore_ids=undefined) {\n\treturn PackageInfo.collect_all(stack, /* include_fn= */ (id, type, match) => {\n\t\t// Include any module that isn't libWrapper\n\t\tif(id !== PACKAGE_ID || type !== PACKAGE_TYPES.MODULE)\n\t\t\treturn true;\n\n\t\t// We don't include some libWrapper matches - specifically those that are in every single exception, or caused by a different module\n\t\tfor(const needle of LIBWRAPPER_IGNORE_MATCHES) {\n\t\t\tif(match.includes(needle))\n\t\t\t\treturn false;\n\t\t}\n\n\t\t// Otherwise it is included\n\t\treturn true;\n\t}, ignore_ids);\n}\n\n\nfunction get_involved_packages_message(stack, ignore_ids=undefined) {\n\tconst packages = get_involved_packages(stack, ignore_ids);\n\tconst length = packages.length;\n\n\t// Zero packages\n\tif(length <= 0)\n\t\treturn \"[No packages detected]\";\n\n\t// 1 package\n\tif(length == 1)\n\t\treturn `[Detected 1 package: ${packages[0].logId}]`;\n\n\t// 2+ packages\n\treturn`[Detected ${length} packages: ${packages.map((p)=>p.logId).join(', ')}]`;\n}\n\n\nfunction has_property_string_writable(obj, prop) {\n\tif(!(prop in obj))\n\t\treturn false\n\n\t// Get the property's descriptor if available\n\tconst desc = Object.getOwnPropertyDescriptor(obj, prop);\n\tif(desc) {\n\t\t// Check if the descriptor is not a getter/setter\n\t\tif(!('value' in desc))\n\t\t\treturn false;\n\n\t\t// Check if the value is a string\n\t\tif(typeof desc.value !== 'string')\n\t\t\treturn false;\n\n\t\t// Check if it is writable\n\t\tif(!desc.writable)\n\t\t\treturn false;\n\t}\n\t// We assume that if the property descriptor doesn't exist, then it is writable by default\n\t// But we still need to validate that it is a string\n\telse {\n\t\tconst value = obj[prop];\n\n\t\tif(typeof value !== 'string')\n\t\t\treturn false;\n\t}\n\n\t// Done\n\treturn true;\n}\n\n\nfunction can_inject_message(error) {\n\t// Can't modify a frozen object\n\tif(Object.isFrozen(error))\n\t\treturn false;\n\n\t// We need both 'message' and 'stack' to be writable strings\n\tif(!has_property_string_writable(error, 'message') || !has_property_string_writable(error, 'stack'))\n\t\treturn false;\n\n\t// Done\n\treturn true;\n}\n\n\nexport function inject_packages_into_error(error, ignore_ids=undefined) {\n\t// Sanity check\n\tif(!is_error_object(error))\n\t\treturn;\n\n\t// Skip package detection is already marked\n\tif(error.skip_package_detection)\n\t\treturn;\n\n\t// Test whether error object allows injection\n\tif(!can_inject_message(error))\n\t\treturn;\n\n\t// Generate involved packages string\n\tconst packages_str = get_involved_packages_message(error.stack, ignore_ids);\n\n\t// Not necessary to inject a second time, if already present\n\tif(error.message.endsWith(packages_str)) {\n\t\terror.skip_package_detection = true;\n\t\treturn;\n\t}\n\n\t// Append to error message\n\tconst orig_msg = error.message;\n\terror.message += `\\n${packages_str}`;\n\n\t// If the stack contains the error message, replace that as well\n\terror.stack = error.stack.replace(orig_msg, error.message);\n\n\t// Done - signal this error doesn't need package detection any more\n\terror.skip_package_detection = true;\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport { PACKAGE_ID } from '../consts.js';\nimport { ERRORS } from './errors.js';\nimport { PackageInfo } from '../shared/package_info.js';\nimport { inject_packages_into_error } from './error-utils.js';\nimport { i18n } from '../shared/i18n.js';\nimport { game_release_display } from '../shared/polyfill.js';\n\n\n// Custom libWrapper Error\nexport class LibWrapperError extends Error {\n\tget notification_fn() { return 'error' };\n\n\tconstructor(ui_msg, console_msg, ...args) {\n\t\t// Create actual error object\n\t\tsuper(console_msg, ...args);\n\n\t\t// Maintains proper stack trace for where our error was thrown (only available on V8)\n\t\tif (Error.captureStackTrace)\n\t\t\tError.captureStackTrace(this, this.constructor);\n\t\tthis.name = this.constructor.name;\n\n\t\t// Store arguments\n\t\tthis.ui_msg = ui_msg;\n\t\tthis.console_msg = console_msg;\n\n\t\t// Detect packages, inject them into error message\n\t\t// Note: We hide 'lib-wrapper' from the list of detected packages, except when this was a libWrapper-internal error\n\t\tinject_packages_into_error(this, this instanceof LibWrapperInternalError ? null : PACKAGE_ID);\n\t}\n\n\t/**\n\t * Called if this error is unhandled\n\t */\n\tonUnhandled() {\n\t}\n}\nObject.freeze(LibWrapperError);\nERRORS.base = LibWrapperError;\n\n\n\n// Internal error\nexport class LibWrapperInternalError extends LibWrapperError {\n\tstatic construct_message(technical_msg, package_info) {\n\t\tconst key_prefix = 'lib-wrapper.error';\n\t\tconst type_prefix = `${key_prefix}.internal`;\n\n\t\t// User message\n\t\tconst user_msg = (!package_info.known ?\n\t\t\ti18n.localize(`${type_prefix}.message`) :\n\t\t\ti18n.format(`${type.prefix}.message-with-package`, {type: package_info.type_i18n, title: package_info.title})\n\t\t);\n\n\t\t// Console message\n\t\tconst info_msg = i18n.format(`${type_prefix}.info`, {url: 'https://github.com/ruipin/fvtt-lib-wrapper'});\n\t\tconst report_msg = i18n.format(`${type_prefix}.report`, {url: 'https://github.com/ruipin/fvtt-lib-wrapper/issues'});\n\t\tconst tech_details = i18n.localize(`${key_prefix}.tech-details`);\n\n\t\tconst related_pkg_msg = (!package_info.known ? '' : `Related Package ID= ${package_info.logId}\\n`);\n\n\t\t// Done\n\t\treturn [\n\t\t\t`libWrapper: ${user_msg}`,\n\t\t\t`${user_msg}\\n\\n${info_msg}\\n${report_msg}\\n\\n${tech_details}\\nInternal libWrapper error.\\n${related_pkg_msg}Error= ${technical_msg}\\n`\n\t\t];\n\t}\n\n\tconstructor(technical_msg, ...args) {\n\t\tconst package_info = new PackageInfo();\n\t\tconst [ui_msg, console_msg] = LibWrapperInternalError.construct_message(technical_msg, package_info);\n\n\t\tsuper(\n\t\t\tui_msg,\n\t\t\tconsole_msg,\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.package_info = package_info;\n\t}\n\n\t/**\n\t * Returns the package ID\n\t */\n\tget package_id() { return this.package_info?.id; }\n}\nObject.freeze(LibWrapperInternalError);\nERRORS.internal = LibWrapperInternalError;\n\n\n\n// Error caused by a package\nexport class LibWrapperPackageError extends LibWrapperError {\n\tstatic get_community_support_message() {\n\t\tconst support_list = [];\n\n\t\tconst key = `${PACKAGE_ID}.support-channels`;\n\t\tconst list = i18n.localize(key);\n\t\tif(Array.isArray(list)) {\n\t\t\tfor(const entry of list) {\n\t\t\t\tif(!('title' in entry) || !('url' in entry))\n\t\t\t\t\tcontinue;\n\n\t\t\t\tsupport_list.push(`- ${entry.title}: ${entry.url}`);\n\t\t\t}\n\t\t}\n\n\t\treturn support_list.length > 0 ? support_list.join('\\n') : null;\n\t}\n\n\tstatic construct_message(technical_msg, package_info) {\n\t\tconst key_prefix = 'lib-wrapper.error';\n\t\tconst type_prefix = `${key_prefix}.external`;\n\n\t\tconst pkg_title = package_info.title;\n\t\tconst pkg_type_i18n = package_info.type_i18n;\n\n\t\t// UI Message\n\t\tlet ui_msg = i18n.format(`${type_prefix}.notification`, {title: pkg_title, type: pkg_type_i18n});\n\t\tlet console_ui_msg = i18n.format(`${type_prefix}.message`, {title: pkg_title, type: pkg_type_i18n});\n\n\t\tif(!package_info.compatible_with_core) {\n\t\t\tconst display_version = game_release_display(/*return_null=*/true);\n\t\t\tif(display_version) {\n\t\t\t\tconst notupd_msg = ` ${i18n.format(`${type_prefix}.likely-not-updated`, {type: pkg_type_i18n, version: display_version})}`;\n\n\t\t\t\tui_msg += notupd_msg;\n\t\t\t\tconsole_ui_msg += notupd_msg;\n\t\t\t}\n\t\t}\n\n\t\t// Console Message\n\t\tlet console_msg = `${console_ui_msg}\\n\\n${i18n.localize(`${key_prefix}.not-lw`)}\\n\\n`;\n\n\t\tconst info_url = package_info.url;\n\t\tif(typeof info_url === 'string') {\n\t\t\tconsole_msg += i18n.format(`${type_prefix}.info`, {type: pkg_type_i18n, url: info_url});\n\t\t}\n\n\t\tconst report_url = package_info.bugs;\n\t\tif(typeof report_url === 'string') {\n\t\t\tconsole_msg += '\\n';\n\t\t\tconsole_msg += i18n.format(`${type_prefix}.report`, {url: report_url});\n\t\t}\n\t\telse {\n\t\t\tconst community_support_msg = this.get_community_support_message();\n\t\t\tif(community_support_msg) {\n\t\t\t\tconsole_msg += '\\n\\n';\n\t\t\t\tconsole_msg += i18n.localize(`${key_prefix}.community-support`);\n\t\t\t\tconsole_msg += '\\n';\n\t\t\t\tconsole_msg += community_support_msg;\n\t\t\t}\n\t\t}\n\t\tconsole_msg += \"\\n\\n\";\n\n\t\tconsole_msg += i18n.localize(`${key_prefix}.tech-details`);\n\t\tconsole_msg += `\\nDetected by libWrapper.\\nPackage ID= ${package_info.logId}\\nError= ${technical_msg}\\n`\n\n\n\t\t// Done\n\t\treturn [\n\t\t\tui_msg,\n\t\t\tconsole_msg\n\t\t];\n\t}\n\n\tconstructor(technical_msg, package_info, ...args) {\n\t\tif(!package_info)\n\t\t\tpackage_info = new PackageInfo();\n\t\telse if(package_info?.constructor !== PackageInfo)\n\t\t\tpackage_info = new PackageInfo(package_info);\n\n\t\tconst [ui_msg, console_msg] = LibWrapperPackageError.construct_message(technical_msg, package_info);\n\n\t\tsuper(\n\t\t\tui_msg,\n\t\t\tconsole_msg,\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.package_info = package_info;\n\t}\n\n\t/**\n\t * Returns the package ID\n\t */\n\tget package_id() { return this.package_info?.id; }\n}\nObject.freeze(LibWrapperPackageError);\nERRORS.package = LibWrapperPackageError;","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {PACKAGE_ID} from '../consts.js';\nimport {decorate_class_function_names} from '../utils/misc.js';\nimport {game_user_isGM} from '../shared/polyfill.js'\nimport { i18n } from '../shared/i18n.js';\n\n\n// Notify user\nexport class LibWrapperNotifications {\n\tstatic init() {\n\t\tthis.NOTIFICATION_SET = new Set();\n\n\t\t// Seal to prevent accidental modification\n\t\tObject.seal(this);\n\t}\n\n\tstatic get ui_notifications_enabled() {\n\t\t// Make sure we don't accidentally throw a second time, while handling what might be another exception\n\t\ttry {\n\t\t\tif(game_user_isGM()) {\n\t\t\t\tif(!game?.settings?.get(PACKAGE_ID, 'notify-issues-gm'))\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(!game?.settings?.get(PACKAGE_ID, 'notify-issues-player'))\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tcatch(e) {\n\t\t\t// We swallow the new error, and assume we want to display errors\n\t\t\tconsole.error(\"libWrapper: Could not decide whether to show notifications or not. Defaulting to 'yes'.\\n\", e);\n\t\t\treturn true;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tstatic _ui(msg, fn, add_title) {\n\t\tif(!this.ui_notifications_enabled)\n\t\t\treturn;\n\n\t\t// Check if we've already notified the user of this\n\t\tif(this.NOTIFICATION_SET.has(msg))\n\t\t\treturn;\n\n\t\tthis.NOTIFICATION_SET.add(msg);\n\n\t\t// Notify - ensure that ui.notifications exists as if an error occurs too early it might not be defined yet\n\t\tlet notify = globalThis?.ui?.notifications;\n\t\tif(notify)\n\t\t\tnotify[fn].call(notify, add_title ? `libWrapper: ${msg}` : msg, {permanent: fn == 'error'});\n\t}\n\n\tstatic ui(msg, fn='error', add_title=true) {\n\t\t// Wait until 'ready' if the error occurs early during load\n\t\tif(!globalThis.game?.ready)\n\t\t\tHooks.once('ready', this._ui.bind(this, msg, fn));\n\t\telse\n\t\t\tthis._ui(msg, fn, add_title);\n\t}\n\n\n\tstatic console_ui(ui_msg, console_msg, fn='error', ...vargs) {\n\t\tconsole[fn].call(console, `libWrapper: ${ui_msg}\\n${console_msg}`, ...vargs);\n\n\t\tthis.ui(`${ui_msg} ${i18n.localize('lib-wrapper.error.see-js-console')}`, fn);\n\t}\n\n\n\tstatic conflict(package_info, other_info, potential, console_msg) {\n\t\tlet other;\n\t\tif(Array.isArray(other_info)) {\n\t\t\tother = (other_info.length > 1) ?\n\t\t\t\t`[${other_info.map((x) => x.type_plus_title_i18n).join(', ')}]` :\n\t\t\t\tother_info[0].type_plus_title_i18n\n\t\t\t;\n\t\t}\n\t\telse {\n\t\t\tother = other_info.type_plus_title_i18n;\n\t\t}\n\n\t\tconst format_obj = {\n\t\t\tmain: package_info.type_plus_title_i18n,\n\t\t\tother: other\n\t\t};\n\n\t\tthis.console_ui(\n\t\t\tpotential ? i18n.format('lib-wrapper.error.conflict.potential', format_obj) :\n\t\t\t            i18n.format('lib-wrapper.error.conflict.confirmed', format_obj) ,\n\t\t\tconsole_msg,\n\t\t\tpotential ? 'warn' : 'error'\n\t\t);\n\t}\n}\ndecorate_class_function_names(LibWrapperNotifications);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {PACKAGE_ID, IS_UNITTEST} from '../consts.js';\nimport {LibWrapperNotifications} from './notifications.js';\nimport {game_user_can} from '../shared/polyfill.js'\n\nexport class LibWrapperStats {\n\tstatic _collect_stats() {\n\t\t// We do this in a try-catch in case future Foundry versions break this code, it won't completely break libWrapper\n\t\ttry {\n\t\t\treturn game_user_can('SETTINGS_MODIFY');\n\t\t}\n\t\tcatch(e) {\n\t\t\tif(IS_UNITTEST)\n\t\t\t\tthrow e;\n\n\t\t\tLibWrapperNotifications.console_ui(\n\t\t\t\t\"A non-critical error occurred while initializing libWrapper.\",\n\t\t\t\t\"Could not read user permissions during initialization.\\n\",\n\t\t\t\t'warn',\n\t\t\t\te\n\t\t\t);\n\n\t\t\t// Default to 'true' on error\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tstatic init() {\n\t\tthis.collect_stats = this._collect_stats();\n\n\t\t// If we got this far, we're going to be collecting statistics, so initialize the containers\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\tthis.PACKAGES  = new Set();\n\t\tthis.CONFLICTS = new Map();\n\n\t\t// Seal to prevent accidental modification\n\t\tObject.seal(this);\n\t}\n\n\tstatic register_package(package_info) {\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\tif(package_info.id == PACKAGE_ID)\n\t\t\treturn;\n\n\t\tthis.PACKAGES.add(package_info.key);\n\t}\n\n\tstatic register_conflict(package_info, other_info, wrapper, ignored) {\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\t// Grab conflict data from storage, or create it if this is a new conflict\n\t\tconst key = `${package_info.key}/${other_info.key}`;\n\n\t\tlet data = this.CONFLICTS.get(key);\n\t\tif(!data) {\n\t\t\tdata = {\n\t\t\t\tcount: 0,\n\t\t\t\tignored: 0,\n\t\t\t\tpackage_info: package_info,\n\t\t\t\tother_info: other_info,\n\t\t\t\ttargets: new Map()\n\t\t\t};\n\t\t\tthis.CONFLICTS.set(key, data);\n\t\t}\n\n\t\tconst target = wrapper.name;\n\t\tlet target_data = data.targets.get(target);\n\t\tif(!target_data) {\n\t\t\ttarget_data = {\n\t\t\t\tcount: 0,\n\t\t\t\tignored: 0\n\t\t\t}\n\t\t\tdata.targets.set(target, target_data);\n\t\t}\n\n\t\t// Increment the conflict counter\n\t\tif(!ignored) {\n\t\t\tdata.count++;\n\t\t\ttarget_data.count++;\n\t\t}\n\t\telse {\n\t\t\tdata.ignored++;\n\t\t\ttarget_data.ignored++;\n\t\t}\n\t}\n\n\tstatic get conflicts() {\n\t\treturn this.CONFLICTS;\n\t}\n\n\tstatic get packages() {\n\t\treturn this.PACKAGES;\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {DEBUG, HOOKS_SCOPE} from '../consts.js';\nimport {ERRORS} from '../errors/errors.js';\nimport {LibWrapperStats} from './stats.js';\nimport {PackageInfo} from '../shared/package_info.js';\n\n\nclass IgnoredConflictEntry {\n\tconstructor(ignore_infos, targets, ignore_errors) {\n\t\t// Packages to ignore\n\t\tthis.ignore_infos = new Set(ignore_infos.map((x) => x.key));\n\n\t\t// Targets to ignore\n\t\tthis.targets = new Set(targets);\n\n\t\t// Whether this ignore also should match errors, and not just warnings\n\t\tthis.ignore_errors = ignore_errors;\n\n\t\t// Done\n\t\tObject.seal(this);\n\t}\n\n\tis_ignored(package_info, wrapper, is_warning) {\n\t\t// Skip if this is an error and we aren't set to ignore errors\n\t\tif(!is_warning && !this.ignore_errors)\n\t\t\treturn false;\n\n\t\t// Search for a matching package\n\t\tconst found_package = this.ignore_infos.has(package_info.key);\n\t\tif(!found_package)\n\t\t\treturn false;\n\n\t\t// Find matching target\n\t\tconst found_target = wrapper.names.find((name) => this.targets.has(name));\n\t\treturn (found_target !== undefined);\n\t}\n}\n\nexport class LibWrapperConflicts {\n\tstatic init() {\n\t\tthis.IGNORED = new Map();\n\n\t\t// Seal to prevent accidental modification\n\t\tObject.seal(this);\n\t}\n\n\tstatic register_ignore(package_info, ignore_infos, targets, is_warning) {\n\t\t// Create IgnoredConflictEntry\n\t\tconst entry = new IgnoredConflictEntry(ignore_infos, targets, is_warning);\n\n\t\t// Get the existing list of ignore entries for this package, or create a new one and add it to the map\n\t\tconst key = package_info.key;\n\t\tlet ignore_entries = this.IGNORED.get(key);\n\t\tif(!ignore_entries) {\n\t\t\tignore_entries = [];\n\t\t\tthis.IGNORED.set(key, ignore_entries);\n\t\t}\n\n\t\t// Add new entry to list\n\t\tignore_entries.push(entry);\n\t}\n\n\tstatic clear_ignores() {\n\t\tthis.IGNORED.clear();\n\t}\n\n\tstatic _is_ignored_oneway(package_info, other_info, wrapper, is_warning) {\n\t\t// Get the existing list of ignore entries for this package\n\t\tconst key = package_info.key;\n\t\tconst ignore_entries = this.IGNORED.get(key);\n\t\tif(!ignore_entries)\n\t\t\treturn false;\n\n\t\t// Check if any of the entries causes this conflict to be ignored\n\t\tfor(const entry of ignore_entries) {\n\t\t\tif(entry.is_ignored(other_info, wrapper, is_warning))\n\t\t\t\treturn true;\n\t\t}\n\n\t\t// Otherwise, it's not ignored\n\t\treturn false;\n\t}\n\n\tstatic _is_ignored(package_info, other_info, wrapper, is_warning) {\n\t\treturn this._is_ignored_oneway(package_info, other_info, wrapper, is_warning) ||\n\t\t       this._is_ignored_oneway(other_info, package_info, wrapper, is_warning);\n\t}\n\n\tstatic register_conflict(package_info, other_info, wrapper, target, is_warning) {\n\t\t// Ignore an empty conflict\n\t\tif(!other_info)\n\t\t\treturn false;\n\n\t\t// Convert from array if necessary\n\t\tif(Array.isArray(other_info)) {\n\t\t\tlet notify = false;\n\t\t\tother_info.forEach((other) => {\n\t\t\t\tnotify |= this.register_conflict(package_info, other, wrapper, target, is_warning);\n\t\t\t});\n\t\t\treturn notify;\n\t\t}\n\n\t\t// Sanity checks #2\n\t\tif(package_info.constructor !== PackageInfo)\n\t\t\tthrow new ERRORS.internal(`LibWrapperConflicts.register_conflict: 'package_info' must be a PackageInfo object, but got '${package_info}'.`);\n\n\t\tif(other_info.constructor !== PackageInfo)\n\t\t\tthrow new ERRORS.internal(`LibWrapperConflicts.register_conflict: 'other_info' must be a PackageInfo object, but got '${other_info}'.`);\n\n\t\t// Note: Not checked because of cyclic dependency\n\t\t//if(wrapper.constructor != Wrapper)\n\t\t//\tthrow new ERRORS.internal(`LibWrapperConflicts.register_conflict: 'wrapper' must be a Wrapper object, but got '${wrapper}'.`);\n\n\t\tif(target != null && typeof target !== 'string')\n\t\t\tthrow new ERRORS.internal(`LibWrapperConflicts.register_conflict: 'target' must be a string, or null, but got '${target}'.`);\n\n\t\tif(typeof is_warning !== 'boolean')\n\t\t\tthrow new ERRORS.internal(`LibWrapperConflicts.register_conflict: 'is_warning' must be a boolean, but got '${is_warning}'.`);\n\n\n\t\t// We first check if this conflict is ignored\n\t\tlet ignored = false;\n\n\t\tif(!ignored && this._is_ignored(package_info, other_info, wrapper, is_warning)) {\n\t\t\tignored = true;\n\t\t\tif(DEBUG)\n\t\t\t\tconsole.debug(`Conflict between ${package_info.type_plus_id} and ${other_info.type_plus_id} over '${wrapper.name}' ignored through 'ignore_conflicts' API.`);\n\t\t}\n\n\t\t// We then notify everyone that a conflict was just detected. This hook being handled will prevent us from registering the package conflict\n\t\tif(!ignored && Hooks.call(`${HOOKS_SCOPE}.ConflictDetected`, package_info.id, other_info.id, target, wrapper.frozen_names) === false) {\n\t\t\tignored = true;\n\t\t\tif(DEBUG)\n\t\t\t\tconsole.debug(`Conflict between ${package_info.type_plus_id} and ${other_info.type_plus_id} over '${wrapper.name}' ignored, as 'libWrapper.ConflictDetected' hook returned false.`);\n\t\t}\n\n\t\t// We now register the conflict with LibWrapperStats\n\t\tLibWrapperStats.register_conflict(package_info, other_info, wrapper, ignored);\n\n\t\t// Done\n\t\treturn !ignored;\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport { LibWrapperError, LibWrapperPackageError } from './base_errors.js';\nimport { ERRORS } from './errors.js';\nimport { PackageInfo } from '../shared/package_info.js';\nimport { LibWrapperConflicts } from '../ui/conflicts.js';\nimport { i18n } from '../shared/i18n.js';\n\n\n// Already Overridden Error\nexport class LibWrapperAlreadyOverriddenError extends LibWrapperError {\n\tstatic construct_message(package_info, conflicting_info, technical_msg) {\n\t\tconst key_prefix = 'lib-wrapper.error';\n\t\tconst type_prefix = `${key_prefix}.conflict`;\n\n\t\tconst pkg_i18n = package_info.type_plus_title_i18n;\n\t\tconst pkg_i18n_capitalized = pkg_i18n.charAt(0).toUpperCase() + pkg_i18n.slice(1);\n\t\tconst confl_i18n = conflicting_info.type_plus_title_i18n;\n\t\tconst confl_i18n_capitalized = confl_i18n.charAt(0).toUpperCase() + confl_i18n.slice(1);\n\n\t\tconst conflict_msg = i18n.format(`${type_prefix}.confirmed`, {main: pkg_i18n, other: confl_i18n});\n\n\t\t// UI Message\n\t\tlet ui_msg = `libWrapper: ${conflict_msg}`;\n\n\n\t\t// Console Message\n\t\tlet console_msg = `${conflict_msg}\\n\\n${i18n.localize(`${key_prefix}.not-lw`)}\\n\\n`;\n\n\t\t// Info links\n\t\tlet info_msg = '';\n\n\t\tconst info1_url = package_info.url;\n\t\tif(typeof info1_url === 'string')\n\t\t\tinfo_msg += `\\n- ${pkg_i18n_capitalized}: ${info1_url}`;\n\n\t\tconst info2_url = conflicting_info.url;\n\t\tif(typeof info2_url === 'string')\n\t\t\tinfo_msg += `\\n- ${confl_i18n_capitalized}: ${info2_url}`;\n\n\t\tif(info_msg)\n\t\t\tconsole_msg += `${i18n.localize(`${type_prefix}.info`)}${info_msg}\\n\\n`;\n\n\t\t// Report links\n\t\tlet bugs_msg = '';\n\n\t\tconst bugs1_url = package_info.bugs;\n\t\tif(typeof bugs1_url === 'string')\n\t\t\tbugs_msg += `\\n- ${pkg_i18n_capitalized}: ${bugs1_url}`;\n\n\t\tconst bugs2_url = conflicting_info.bugs;\n\t\tif(typeof bugs2_url === 'string')\n\t\t\tbugs_msg += `\\n- ${confl_i18n_capitalized}: ${bugs2_url}`;\n\n\t\tif(bugs_msg)\n\t\t\tconsole_msg += `${i18n.localize(`${type_prefix}.report`)}${bugs_msg}\\n\\n`;\n\n\t\t// Support links\n\t\tconst community_support_msg = LibWrapperPackageError.get_community_support_message();\n\t\tif(community_support_msg) {\n\t\t\tconsole_msg += i18n.localize(`${key_prefix}.community-support`);\n\t\t\tconsole_msg += '\\n';\n\t\t\tconsole_msg += community_support_msg;\n\t\t\tconsole_msg += \"\\n\\n\";\n\t\t}\n\n\t\t// Tech details\n\t\tconsole_msg += i18n.localize(`${key_prefix}.tech-details`);\n\t\tconsole_msg += `\\nDetected by libWrapper.\\nPackage IDs= ${package_info.logId}, ${conflicting_info.logId}\\nError= ${technical_msg}\\n`\n\n\n\t\t// Done\n\t\treturn [\n\t\t\tui_msg,\n\t\t\tconsole_msg\n\t\t];\n\t}\n\n\tconstructor(package_info, conflicting_info, wrapper, target, ...args) {\n\t\tif(package_info?.constructor !== PackageInfo)\n\t\t\tpackage_info = new PackageInfo(package_info);\n\n\t\tif(conflicting_info?.constructor !== PackageInfo)\n\t\t\tconflicting_info = new PackageInfo(conflicting_info);\n\n\t\tconst [ui_msg, console_msg] = LibWrapperAlreadyOverriddenError.construct_message(package_info, conflicting_info,\n\t\t\t`Failed to wrap '${target}' for ${package_info.type_plus_id} with type OVERRIDE. An OVERRIDE wrapper for the same method has already been registered by ${conflicting_info.type_plus_id}.`\n\t\t);\n\n\t\tsuper(\n\t\t\tui_msg,\n\t\t\tconsole_msg,\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.package_info = package_info;\n\t\tthis.conflicting_info = conflicting_info;\n\t\tthis.target = target;\n\t\tthis._wrapper = wrapper;\n\t}\n\n\t/**\n\t * Returns the package ID\n\t */\n\tget package_id() { return this.package_info?.id; }\n\n\t/**\n\t * Deprecated since v1.6.0.0\n\t * Returns the package ID\n\t */\n\tget module() { return this.package_id; }\n\n\t/**\n\t * Returns the conflicting package ID\n\t */\n\tget conflicting_id() { return this.conflicting_info?.id; }\n\n\t/**\n\t * Deprecated since v1.6.0.0\n\t * Returns the conflicting package ID\n\t */\n\tget conflicting_module() { return this.conflicting_id; }\n\n\t/**\n\t * Called if this error is unhandled\n\t */\n\tonUnhandled() {\n\t\tsuper.onUnhandled();\n\n\t\tLibWrapperConflicts.register_conflict(this.package_info, this.conflicting_info, this._wrapper, this.target, false);\n\t}\n}\nObject.freeze(LibWrapperAlreadyOverriddenError);\nERRORS.already_overridden = LibWrapperAlreadyOverriddenError;\n\n\n\n// Invalid Wrapper Chain Error\nexport class LibWrapperInvalidWrapperChainError extends LibWrapperPackageError {\n\tconstructor(wrapper, package_info, technical_msg, ...args) {\n\t\tif(package_info?.constructor !== PackageInfo)\n\t\t\tpackage_info = new PackageInfo(package_info);\n\n\t\tsuper(\n\t\t\ttechnical_msg,\n\t\t\tpackage_info,\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis._wrapper = wrapper;\n\t}\n}\nObject.freeze(LibWrapperInvalidWrapperChainError);\nERRORS.invalid_chain = LibWrapperInvalidWrapperChainError;","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport { IS_UNITTEST, DEBUG } from '../consts.js';\nimport { global_eval } from '../utils/misc.js';\nimport { LibWrapperError } from './base_errors.js';\nimport { is_error_object, inject_packages_into_error } from './error-utils.js';\nimport { LibWrapperNotifications } from '../ui/notifications.js';\nimport { i18n } from '../shared/i18n.js';\n\n\n/*\n * Make sure browser is allowed to collect full stack traces, for easier debugging of issues\n */\nError.stackTraceLimit = Infinity;\n\n\n/*\n * Utility Methods\n */\nfunction on_libwrapper_error(error) {\n\t// Notify user of the issue\n\tif(error.ui_msg && error.notification_fn)\n\t\tLibWrapperNotifications.ui(`${error.ui_msg} ${i18n.localize('lib-wrapper.error.see-js-console')}`, error.notification_fn, false);\n\n\t// Trigger 'onUnhandled'\n\tif(error.onUnhandled)\n\t\terror.onUnhandled.apply(error);\n}\n\nfunction on_any_error(error) {\n\t// Detect packages and inject a list into the error object\n\tinject_packages_into_error(error);\n}\n\n\n/*\n * Error Listeners\n */\nexport const onUnhandledError = function(error) {\n\ttry {\n\t\t// Sanity check\n\t\tif(!is_error_object(error))\n\t\t\treturn;\n\n\t\t// If we have an instance of LibWrapperError, we trigger the libWrapper-specific behaviour\n\t\tif(error instanceof LibWrapperError)\n\t\t\ton_libwrapper_error(error);\n\n\t\t// Trigger the error handling code for all errors\n\t\ton_any_error(error);\n\t}\n\tcatch (e) {\n\t\tconsole.warn('libWrapper: Exception thrown while processing an unhandled error.', e);\n\t}\n}\n\nconst onUnhandledErrorEvent = function(event) {\n\ttry {\n\t\t// The cause of the event is what we're interested in\n\t\tconst cause = event.reason ?? event.error ?? event;\n\n\t\t// We've got our error object, call onUnhandledError\n\t\treturn onUnhandledError(cause);\n\t}\n\tcatch (e) {\n\t\tconsole.warn('libWrapper: Exception thrown while processing an unhandled error event.', e);\n\t}\n}\n\n\n/*\n * Set up error listeners\n */\nfunction init_pre_v9p2_listeners() {\n\t// Wrap Hooks._call to intercept unhandled exceptions during hooks\n\t// We don't use libWrapper itself here as we can guarantee we come first (well, before any libWrapper wrapper) and we want to avoid polluting the callstack of every single hook.\n\t// Otherwise users might think libWrapper is causing failures, when they're actually the fault of another package.\n\t// We try to patch the existing method. If anything fails, we just alert the user and skip this section.\n\ttry {\n\t\t// Patch original method\n\t\tconst orig = '() => function ' + Hooks._call.toString();\n\t\tconst patched = orig.replace(/catch[\\s\\n]*\\((.*)\\)[\\s\\n]*{/img, '$& globalThis.libWrapper.onUnhandledError($1);');\n\t\tif(orig === patched)\n\t\t\tthrow new Error(`Could not patch 'Hooks._call' method:\\n${orig}`);\n\t\tif(DEBUG)\n\t\t\tconsole.log(`Patched Hooks._call: ${patched}`);\n\n\t\tconst patched_fn = global_eval(patched)?.();\n\t\tif(typeof patched_fn !== 'function')\n\t\t\tthrow new Error(`Evaluation of patched 'Hooks._call' method did not return a function:\\nPatched Method: ${patched}\\nReturned: ${patched_fn}`);\n\n\t\tHooks._call = patched_fn;\n\t}\n\tcatch(e) {\n\t\t// Handle a possible error gracefully\n\t\tLibWrapperNotifications.console_ui(\n\t\t\t\"A non-critical error occurred while initializing libWrapper.\",\n\t\t\t\"Could not setup 'Hooks._call' wrapper.\\n\",\n\t\t\t'warn',\n\t\t\te\n\t\t);\n\t}\n\n\t// Wrap Application.prototype._render to intercept unhandled exceptions when rendering Applications\n\ttry {\n\t\tlibWrapper.register('lib-wrapper', 'Application.prototype._render', function(wrapped, ...args) {\n\t\t\treturn wrapped(...args).catch(err => {\n\t\t\t\tonUnhandledError(err);\n\t\t\t\tthrow err;\n\t\t\t});\n\t\t}, 'WRAPPER', {perf_mode: 'FAST'});\n\t}\n\tcatch(e) {\n\t\t// Handle a possible error gracefully\n\t\tLibWrapperNotifications.console_ui(\n\t\t\t\"A non-critical error occurred while initializing libWrapper.\",\n\t\t\t\"Could not setup 'Application.prototype._render' wrapper.\\n\",\n\t\t\t'warn',\n\t\t\te\n\t\t);\n\t}\n}\n\nfunction init_hooksOnError_listener() {\n\t// Wrap Hooks._onError to intercept unhandled exceptions\n\t// We could use the 'error' hook instead, but then we wouldn't be able to see an exception before it gets logged to the console\n\ttry {\n\t\tlibWrapper.register('lib-wrapper', 'Hooks.onError', function(wrapped, ...args) {\n\t\t\t// Handle error ourselves first\n\t\t\tconst err = args[1];\n\t\t\tonUnhandledError(err);\n\n\t\t\t// Let Foundry do its thing after\n\t\t\treturn wrapped(...args);\n\t\t}, 'WRAPPER', {perf_mode: 'FAST'});\n\t}\n\tcatch(e) {\n\t\t// Handle a possible error gracefully\n\t\tLibWrapperNotifications.console_ui(\n\t\t\t\"A non-critical error occurred while initializing libWrapper.\",\n\t\t\t\"Could not setup 'Hooks.onError' wrapper.\\n\",\n\t\t\t'warn',\n\t\t\te\n\t\t);\n\t}\n}\n\n// Called during libWrapper initialisation\nexport const init_error_listeners = function() {\n\t// Do nothing inside unit tests\n\tif(IS_UNITTEST)\n\t\treturn;\n\n\t// Javascript native unhandled exception listeners\n\tglobalThis.addEventListener('error', onUnhandledErrorEvent);\n\tglobalThis.addEventListener('unhandledrejection', onUnhandledErrorEvent);\n\n\t// v9p2 or newer triggers 'Hooks.onError' any time there is an unhandled error\n\tif(Hooks.onError) {\n\t\tinit_hooksOnError_listener();\n\t}\n\t// v9p1 or older needs individual patching\n\telse {\n\t\tinit_pre_v9p2_listeners();\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-shared-library Rui Pinheiro\n\n'use strict';\n\nimport {PACKAGE_TITLE, PACKAGE_ID} from '../consts.js';\n\n\n//*********************\n// Versioning\nconst throw_error = (msg) => { throw new Error(`${PACKAGE_TITLE}: ${msg}.\\nFoundry might not have initialized properly, please try refreshing.`) };\n\n// This allows rollup to optimise the version-related code\n/*#if _ROLLUP\nexport const VERSION = $_PACKAGE_VERSION;\n\n//#else */\n// This method will be used by Rollup to feed the JSCC pre-processor\nexport const _parse_manifest_version = function(version, git_hash) {\n\t// Default to a sane value\n\tconst known = (typeof version === 'string');\n\tif(!known)\n\t\tversion = '1.99.99.99';\n\n\t// Parse version string\n\tconst match = version.match(/^([0-9]+)\\.([0-9]+)\\.([0-9]+).([0-9]+)(.*)$/i);\n\tif(!match)\n\t\tthrow_error(`Unable to parse version string '${version_str}'`);\n\n\tconst result = {\n\t\tknown  : known,\n\t\tfull   : version,\n\t\tmajor  : parseInt(match[1]),\n\t\tminor  : parseInt(match[2]),\n\t\tpatch  : parseInt(match[3]),\n\t\tsuffix : parseInt(match[4]),\n\t\tmeta   : match[5],\n\t};\n\n\t// Process git hash\n\tresult.git       = git_hash ?? 'unknown';\n\tresult.git_short = (result.git.length >= 40) ? result.git.slice(0,7) : result.git;\n\tresult.full_git  = `${result.full} (${result.git_short})`\n\n\t// Done\n\treturn result;\n}\n\n// This method is fallback, and only used when running libWrapper directly from the source code without going through the Rollup build step first\n// e.g. during unit tests\nexport const parse_manifest_version = function() {\n\tif(VERSION.known)\n\t\treturn;\n\n\ttry {\n\t\t// Get package manifest\n\t\tif(!game.modules)\n\t\t\tthrow_error(\"Could not find 'game.modules'\");\n\n\t\tif(!game.modules.size)\n\t\t\tthrow_error(\"Map 'game.modules' is empty\");\n\n\t\tconst mdl = game.modules.get(PACKAGE_ID);\n\t\tif(!mdl)\n\t\t\tthrow_error(`Could not find 'game.modules.get(\"${PACKAGE_ID}\")'`);\n\n\t\tconst manifest = mdl.data;\n\t\tif(!manifest)\n\t\t\tthrow_error(`Could not find 'game.modules.get(\"${PACKAGE_ID}\").data'`);\n\n\t\t// Grab git version (no need to validate)\n\t\tconst git_hash = manifest.flags?.git_version;\n\n\t\t// Grab version string\n\t\tconst version_str = manifest.version;\n\t\tif(!version_str)\n\t\t\tthrow_error(\"Unable to find version string inside package manifest\");\n\n\t\t// Done\n\t\tVERSION = _parse_manifest_version(version_str, git_hash);\n\t}\n\tcatch(e) {\n\t\tconsole.error(e);\n\t\tHooks?.once('ready', () => globalThis?.ui?.notifications?.error?.(e));\n\t}\n}\n\nexport let VERSION = _parse_manifest_version(null, null);\n//#endif\n\n\n//*********************\n// Test for a minimum version\nexport const version_at_least = function(major, minor=0, patch=0, suffix=0) {\n\tif(VERSION.major == major) {\n\t\tif(VERSION.minor == minor) {\n\t\t\tif(VERSION.patch == patch) {\n\t\t\t\treturn VERSION.suffix == suffix;\n\t\t\t}\n\n\t\t\treturn VERSION.patch >= patch;\n\t\t}\n\n\t\treturn VERSION.minor > minor;\n\t}\n\treturn VERSION.major > major;\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-event-viewer Rui Pinheiro\n\n'use strict';\n\n\nimport {Enum} from '../shared/enums.js';\n\n\n//*********************\n// WRAPPER TYPES\nexport const WRAPPER_TYPES = Enum('WrapperType', {\n\t'WRAPPER' : 1,\n\t'MIXED'   : 2,\n\t'OVERRIDE': 3\n});\n\n\n//*********************\n// PERFORMANCE MODES\nexport const PERF_MODES = Enum('PerformanceMode', {\n\t'NORMAL': 1,\n\t'AUTO'  : 2,\n\t'FAST'  : 3\n});","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {PACKAGE_ID, PROPERTIES_CONFIGURABLE, DEBUG} from '../consts.js';\nimport {WRAPPER_TYPES, PERF_MODES} from './enums.js';\nimport {decorate_name, set_function_name, decorate_class_function_names} from '../utils/misc.js';\nimport {PackageInfo} from '../shared/package_info.js';\n\nimport {ERRORS} from '../errors/errors.js';\n\nimport {LibWrapperNotifications} from '../ui/notifications.js';\nimport {LibWrapperStats} from '../ui/stats.js';\nimport {LibWrapperConflicts} from '../ui/conflicts.js';\nimport {onUnhandledError} from '../errors/listeners.js';\n\n\n\n// Wrapper class - this class is responsible for the actual wrapping\nexport class Wrapper {\n\t// Names\n\tget name() {\n\t\treturn this.names[0];\n\t}\n\n\tget frozen_names() {\n\t\tObject.freeze(this.names);\n\t\treturn this.names;\n\t}\n\n\t_add_name(name) {\n\t\tif(!this.names.includes(name)) {\n\t\t\t// Note: 'this._names' might be frozen, assuming the 'this.frozen_names' getter has ever been used, in which case we need to clone it.\n\t\t\tif(Object.isFrozen(this.names))\n\t\t\t\tthis.names = this.names.slice();\n\n\t\t\tthis.names.push(name);\n\t\t}\n\t}\n\n\n\t// Callstack\n\t_callstack_name(nm, arg1=this.name) {\n\t\treturn decorate_name(arg1, nm);\n\t}\n\n\n\t// Constructor\n\tconstructor (obj, fn_name, name=undefined, package_info=undefined) {\n\t\t// Basic instance variables\n\t\tthis.fn_name = fn_name;\n\t\tthis.object  = obj;\n\n\t\t// Validate whether we can wrap this object\n\t\tlet descriptor = Object.getOwnPropertyDescriptor(obj, fn_name);\n\n\t\tif(descriptor) {\n\t\t\tif(descriptor.get?._lib_wrapper) {\n\t\t\t\tconst wrapper = descriptor.get?._lib_wrapper;\n\n\t\t\t\tif(!(wrapper instanceof this.constructor))\n\t\t\t\t\tthrow new ERRORS.internal(`libWrapper: '${name}' cannot be wrapped, the descriptor already has a wrapper, but of an unexpected class ('${wrapper.constructor.name}' vs '${this.constructor.name}').`);\n\n\t\t\t\twrapper._add_name(name);\n\n\t\t\t\treturn wrapper;\n\t\t\t}\n\n\t\t\tif(descriptor.configurable === false) {\n\t\t\t\tthrow new ERRORS.package(`libWrapper: '${name}' cannot be wrapped, the corresponding descriptor has 'configurable=false'.`, package_info);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(descriptor.get) {\n\t\t\t\t\tthis.is_property = true;\n\t\t\t\t\tthis._wrapped_getter = descriptor.get;\n\t\t\t\t\tthis._wrapped_setter = descriptor.set;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.is_property = false;\n\t\t\t\t\tthis._wrapped = descriptor.value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tdescriptor = this._get_inherited_descriptor();\n\n\t\t\tif(!descriptor)\n\t\t\t\tthrow new ERRORS.package(`libWrapper: Can't wrap '${name}', target does not exist or could not be found.`, package_info);\n\n\t\t\tconst wrapper = descriptor.get?._lib_wrapper;\n\n\t\t\tif(wrapper) {\n\t\t\t\tthis.is_property = wrapper.is_property;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(descriptor.get ?? descriptor.set)\n\t\t\t\t\tthis.is_property = true;\n\t\t\t\telse\n\t\t\t\t\tthis.is_property = false;\n\t\t\t}\n\t\t}\n\n\t\t// Setup instance variables\n\t\tthis.names = [];\n\n\t\tthis.getter_data = [];\n\t\tthis._getter_data_id = 0;\n\t\tif(this.is_property) {\n\t\t\tthis.setter_data = [];\n\t\t\tthis._setter_data_id = 0;\n\t\t}\n\n\t\tthis.active  = false;\n\n\t\tthis._outstanding_wrappers = 0;\n\t\tthis._current_handler_id = 0;\n\n\t\tif(!this.is_property) {\n\t\t\tthis._pending_wrapped_calls = [];\n\t\t\tthis._pending_wrapped_calls_cnt = 0;\n\t\t}\n\n\t\tthis.update_use_static_dispatch();\n\n\t\t// Add name\n\t\tif(!name)\n\t\t\tname = fn_name;\n\t\tthis._add_name(name);\n\n\t\t// Do actual wrapping\n\t\tthis._wrap();\n\t}\n\n\n\t// Handler\n\t_get_handler() {\n\t\t// Return the cached handler, if it is still valid\n\t\tconst handler_id = this._current_handler_id;\n\t\tif(handler_id === this._cached_handler_id)\n\t\t\treturn this._cached_handler;\n\n\t\t// Create a handler function\n\t\tconst _this = this;\n\t\tconst handler_nm = this._callstack_name(handler_id);\n\t\tconst wrapped = this._wrapped ?? null; // we explicitly convert undefined to null here, to force a inheritance chain search when calling get_wrapped\n\n\t\t// We use a trick here to be able to convince the browser to name the method the way we want it\n\t\tconst obj = {\n\t\t\t[handler_nm]: function(...args) {\n\t\t\t\tconst is_static_dispatch = _this.use_static_dispatch;\n\n\t\t\t\t// Check if we should skip wrappers\n\t\t\t\tif(_this.should_skip_wrappers(this, handler_id, is_static_dispatch)) {\n\t\t\t\t\treturn _this.get_wrapped(this, false, wrapped).apply(this, args);\n\t\t\t\t}\n\t\t\t\t// Otherwise, trigger the wrapper dispatch chain\n\t\t\t\telse {\n\t\t\t\t\t// Trigger the desired dispatch chain - dynamic or static\n\t\t\t\t\tif(is_static_dispatch)\n\t\t\t\t\t\treturn _this.get_static_dispatch_chain(this).apply(this, args);\n\t\t\t\t\telse\n\t\t\t\t\t\treturn _this.call_wrapper(null, this, ...args);\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttoString: function () {\n\t\t\t\treturn \"/* WARNING: libWrapper wrappers present! */\\n\" + _this.get_wrapped(this).toString();\n\t\t\t}\n\t\t};\n\t\tconst handler = obj[handler_nm];\n\t\thandler.toString = obj['toString'];\n\n\t\t// Cache handler\n\t\tthis._cached_handler = handler;\n\t\tthis._cached_handler_id = handler_id;\n\n\t\t// Done\n\t\treturn handler;\n\t}\n\n\tget_static_dispatch_chain(obj) {\n\t\tconst fn_data_id = this._getter_data_id;\n\t\tlet dispatch_chain = null;\n\n\t\t// Use the cached dispatch chain, if still valid\n\t\tif(fn_data_id === this._cached_static_dispatch_chain_id && obj === this._cached_static_dispatch_chain_obj) {\n\t\t\tdispatch_chain = this._cached_static_dispatch_chain;\n\t\t}\n\t\t// Otherwise, generate a new static dispatch chain\n\t\telse {\n\t\t\tconst _init_dispatch_chain = () => {\n\t\t\t\tdispatch_chain = this.call_wrapped.bind(this, /*state=*/ null, obj);\n\t\t\t};\n\n\t\t\t// Walk wrappers in reverse order\n\t\t\tconst fn_data = this.get_fn_data(false);\n\t\t\tfor(let i = fn_data.length-1; i >= 0; i--) {\n\t\t\t\tconst data = fn_data[i];\n\t\t\t\tconst fn = data.fn;\n\n\t\t\t\t// OVERRIDE type will usually not continue the chain\n\t\t\t\tif(!data.chain)\n\t\t\t\t\tdispatch_chain = fn.bind(obj);\n\t\t\t\t// Else, bind the wrapper\n\t\t\t\telse {\n\t\t\t\t\tif(!dispatch_chain)\n\t\t\t\t\t\t_init_dispatch_chain();\n\n\t\t\t\t\tdispatch_chain = fn.bind(obj, dispatch_chain);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(!dispatch_chain)\n\t\t\t\t_init_dispatch_chain();\n\n\t\t\t// Cache static dispatch chain\n\t\t\tthis._cached_static_dispatch_chain_obj = obj;\n\t\t\tthis._cached_static_dispatch_chain_id  = fn_data_id;\n\t\t\tthis._cached_static_dispatch_chain     = dispatch_chain;\n\t\t}\n\n\t\t// Done\n\t\treturn dispatch_chain;\n\t}\n\n\tshould_skip_wrappers(obj, handler_id, is_static_dispatch) {\n\t\t// We don't need to skip wrappers if the handler is still valid\n\t\tif(handler_id == this._current_handler_id)\n\t\t\treturn false;\n\n\t\t// Sanity check\n\t\tif(handler_id > this._current_handler_id)\n\t\t\tthrow new ERRORS.internal(`Unreachable: handler_id=${handler_id} > this._current_handler_id=${this._current_handler_id}`);\n\n\t\t// Find pending calls that match this object - if any is found, skip wrappers\n\t\tif(!this.is_property) {\n\t\t\t// Check if there's any pending wrapped calls\n\t\t\tif(this._pending_wrapped_calls_cnt <= 0)\n\t\t\t\treturn false;\n\n\t\t\t// Check if our object exists in the pending wrapped calls\n\t\t\tif(!is_static_dispatch) {\n\t\t\t\tconst pend_i = this._pending_wrapped_calls.indexOf(obj);\n\t\t\t\tif(pend_i < 0)\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tskip_existing_handlers() {\n\t\tthis._current_handler_id++;\n\t}\n\n\t_calc_use_static_dispatch() {\n\t\t// Do all the wrappers in fn_data specify the same, explicit, performance mode wish?\n\t\tconst fn_data = this.get_fn_data(false);\n\n\t\tlet perf_mode = undefined;\n\t\tfor(const data of fn_data) {\n\t\t\tif(!data.perf_mode)\n\t\t\t\tcontinue;\n\n\t\t\tif(perf_mode === undefined) {\n\t\t\t\tperf_mode = data.perf_mode;\n\t\t\t}\n\t\t\telse if(perf_mode !== data.perf_mode) {\n\t\t\t\tperf_mode = PERF_MODES.AUTO;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif(perf_mode === PERF_MODES.FAST)\n\t\t\treturn true;\n\t\telse if(perf_mode === PERF_MODES.SAFE)\n\t\t\treturn false;\n\t\telse /* PERF_MODES.AUTO */ {\n\t\t\t// Default to static dispatch in user-enabled high performance mode\n\t\t\tif(game?.settings?.get(PACKAGE_ID, 'high-performance-mode'))\n\t\t\t\treturn true;\n\n\t\t\t// Finally, default to false\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tupdate_use_static_dispatch() {\n\t\tthis.use_static_dispatch = this._calc_use_static_dispatch();\n\t}\n\n\n\t// Wrap/unwrap logic\n\t_wrap() {\n\t\tif(this.active)\n\t\t\treturn;\n\n\t\t// Setup setter/getter\n\t\t// We use a trick here to be able to convince the browser to name the method the way we want it\n\t\tconst getter_nm = this._callstack_name('getter');\n\t\tconst setter_nm = this._callstack_name('setter');\n\t\tlet obj;\n\n\t\tif(!this.is_property) {\n\t\t\tconst _this = this;\n\n\t\t\t// Setup setter / getter\n\t\t\tobj = {\n\t\t\t\t[getter_nm]: () => _this._get_handler(),\n\n\t\t\t\t[setter_nm]: function(value) {\n\t\t\t\t\treturn _this.set_nonproperty(value, this);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\t// Setup setter / getter\n\t\t\tconst _this = this;\n\n\t\t\tobj = {\n\t\t\t\t[getter_nm]: function(...args) {\n\t\t\t\t\treturn _this.call_wrapper(null, this, ...args);\n\t\t\t\t},\n\n\t\t\t\t[setter_nm]: function(...args) {\n\t\t\t\t\treturn _this.call_wrapper({setter: true}, this, ...args);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst getter = obj[getter_nm];\n\t\tconst setter = obj[setter_nm];\n\n\t\t// Store a reference to this in the getter so that we can support 'singleton'-like functionality\n\t\tgetter._lib_wrapper = this;\n\n\t\t// Define a property with a getter/setter\n\t\tObject.defineProperty(this.object, this.fn_name, {\n\t\t\tget: getter,\n\t\t\tset: setter,\n\t\t\tconfigurable: PROPERTIES_CONFIGURABLE\n\t\t});\n\n\t\tthis.active = true;\n\n\t\tconsole.debug(`libWrapper: Wrapped '${this.name}'.`);\n\t}\n\n\tunwrap() {\n\t\tif(!this.active)\n\t\t\treturn;\n\n\t\tif(!PROPERTIES_CONFIGURABLE)\n\t\t\tthrow new ERRORS.internal('libWrapper: Cannot unwrap when PROPERTIES_CONFIGURABLE==false');\n\n\n\t\t// Remove the property\n\t\tdelete this.object[this.fn_name];\n\n\t\tif(this.is_property) {\n\t\t\tObject.defineProperty(this.object, this.fn_name, {\n\t\t\t\tget: this._wrapped_getter,\n\t\t\t\tset: this._wrapped_setter,\n\t\t\t\tconfigurable: true\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tthis.object[this.fn_name] = this._wrapped;\n\t\t}\n\n\n\t\t// Done\n\t\tthis.active = false;\n\n\t\tconsole.debug(`libWrapper: Unwrapped '${this.name}'.`);\n\t}\n\n\n\n\t// Utilities related to getting the wrapped value\n\t_get_inherited_descriptor() {\n\t\tlet iObj = Object.getPrototypeOf(this.object);\n\n\t\twhile(iObj) {\n\t\t\tconst descriptor = Object.getOwnPropertyDescriptor(iObj, this.fn_name);\n\t\t\tif(descriptor)\n\t\t\t\treturn descriptor;\n\n\t\t\tiObj = Object.getPrototypeOf(iObj);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tget_wrapped(obj, setter=false, wrapped=undefined) {\n\t\tlet result;\n\n\t\t// A non-undefined \"wrapped\" parameter is taken as-is\n\t\tif(wrapped !== undefined)\n\t\t\tresult = wrapped;\n\t\t// Otherwise we grab what is currently wrapped\n\t\telse if(this.is_property)\n\t\t\tresult = setter ? this._wrapped_setter : this._wrapped_getter;\n\t\telse\n\t\t\tresult = this._wrapped;\n\n\t\t// We convert 'null' to undefined. This means passing parameter 'wrapped==null' forces an inheritance chain search\n\t\tif(result === null)\n\t\t\tresult = undefined;\n\n\t\t// If this wrapper is 'empty', we need to search up the inheritance hierarchy for the return value\n\t\tif(result === undefined) {\n\t\t\tconst descriptor = this._get_inherited_descriptor();\n\n\t\t\tif(descriptor) {\n\t\t\t\tif(this.is_property) {\n\t\t\t\t\tif(!descriptor.get && !descriptor.set)\n\t\t\t\t\t\tthrow new ERRORS.internal(`This wrapper is set up to wrap a property, but the inherited descriptor is a method.`);\n\n\t\t\t\t\tif(setter)\n\t\t\t\t\t\tresult = descriptor.set;\n\t\t\t\t\telse\n\t\t\t\t\t\tresult = descriptor.get;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresult = descriptor.value ?? descriptor.get.apply(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Done\n\t\tif(result === undefined)\n\t\t\tconsole.warn(`libWrapper: There is no wrapped method for '${this.name}', returning 'undefined'.`);\n\n\t\treturn result;\n\t}\n\n\n\n\t// Calling the wrapped method\n\tcall_wrapped(state, obj, ...args) {\n\t\t// Keep track of call state\n\t\tif(state)\n\t\t\tthis._call_wrapper_update_state(state);\n\n\t\t// Load necessary state\n\t\tconst is_setter = state?.setter ?? false;\n\t\tconst is_dynamic_dispatch = (!!state);\n\n\t\t// If necessary, set this wrapped call as pending\n\t\tlet pend = undefined;\n\t\tif(!this.is_property) {\n\t\t\tthis._pending_wrapped_calls_cnt++;\n\n\t\t\tif(is_dynamic_dispatch) {\n\t\t\t\tpend = obj;\n\t\t\t\tthis._pending_wrapped_calls.push(pend);\n\t\t\t}\n\t\t}\n\n\t\t// Try-catch block to handle normal exception flow\n\t\tlet result = undefined;\n\t\ttry {\n\t\t\tconst wrapped = this.get_wrapped(this.object, is_setter);\n\t\t\tresult = wrapped?.apply(obj, args);\n\t\t}\n\t\tcatch(e) {\n\t\t\tif(!this.is_property)\n\t\t\t\tthis._cleanup_call_wrapped(pend, is_dynamic_dispatch);\n\n\t\t\tthrow e;\n\t\t}\n\n\t\t// We only need to keep track of pending calls when we're not wrapping a property\n\t\tif(this.is_property)\n\t\t\treturn result;\n\n\t\t// If the result is a Promise, then we must wait until it fulfills before cleaning up.\n\t\t// Per the JS spec, the only way to detect a Promise (since Promises can be polyfilled, extended, wrapped, etc) is to look for the 'then' method.\n\t\t// Anything with a 'then' function is technically a Promise. This leaves a path for false-positives, but I don't see a way to avoid this.\n\t\tif(typeof result?.then === 'function') {\n\t\t\tresult = result.then(\n\t\t\t\t// onResolved\n\t\t\t\tv => {\n\t\t\t\t\tthis._cleanup_call_wrapped(pend, is_dynamic_dispatch);\n\t\t\t\t\treturn v;\n\t\t\t\t},\n\t\t\t\t// onRejected\n\t\t\t\te => {\n\t\t\t\t\tthis._cleanup_call_wrapped(pend, is_dynamic_dispatch);\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t\t// Otherwise, we can immediately cleanup.\n\t\telse {\n\t\t\tthis._cleanup_call_wrapped(pend, is_dynamic_dispatch);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\t_cleanup_call_wrapped(pend, is_dynamic_dispatch) {\n\t\tif(!this._pending_wrapped_calls_cnt)\n\t\t\tthrow new ERRORS.internal(`this._pending_wrapped_calls_cnt=${this._pending_wrapped_calls_cnt} should be unreachable at this point.`);\n\t\tthis._pending_wrapped_calls_cnt--;\n\n\t\tif(is_dynamic_dispatch) {\n\t\t\tconst pend_i = this._pending_wrapped_calls.indexOf(pend);\n\t\t\tif(pend_i < 0)\n\t\t\t\tthrow new ERRORS.internal(`Could not find 'pend' inside 'this._pending_wrapped_calls'.`);\n\n\t\t\tthis._pending_wrapped_calls.splice(pend_i, 1);\n\t\t}\n\t}\n\n\n\n\t// Main call wrapper logic\n\tcall_wrapper(state, obj, ...args) {\n\t\t// Keep track of call state\n\t\tif(state)\n\t\t\tthis._call_wrapper_update_state(state);\n\n\t\t// Set up basic information about this wrapper\n\t\tconst index = state?.index ?? 0;\n\t\tconst is_setter = state?.setter ?? false;\n\t\tconst fn_data = state?.fn_data ?? this.get_fn_data(is_setter);\n\n\t\t// Grab the next function data from the function data array\n\t\tconst data = fn_data[index];\n\n\t\t// If no methods exist, then finish the chain\n\t\tif(!data) {\n\t\t\tif(fn_data.length > 0)\n\t\t\t\tthrow new ERRORS.internal(`Must not have 'data===${data}' when 'fn_data.length==${fn_data.length}'.`);\n\n\t\t\t// There are no wrappers, return the wrapped value.\n\t\t\treturn this.call_wrapped(null, obj, ...args);\n\t\t}\n\n\t\t// Grab wrapper function from function data object\n\t\tconst fn = data.fn;\n\n\t\t// OVERRIDE type will usually not continue the chain\n\t\tif(!data.chain) {\n\t\t\t// Call next method in the chain\n\t\t\treturn fn.apply(obj, args);\n\t\t}\n\n\t\t// Get next index\n\t\tconst next_index = index + 1;\n\t\tconst is_last = (next_index >= fn_data.length);\n\n\t\t// Prepare the continuation of the chain\n\t\tconst next_state = {\n\t\t\tindex    : next_index,\n\t\t\tcalled   : false,\n\t\t\tvalid    : true,\n\t\t\tsetter   : is_setter,\n\t\t\tprev_data: data,\n\t\t\tfn_data  : fn_data\n\t\t};\n\n\t\t// Create the next wrapper function\n\t\tconst next_fn = is_last ? this.call_wrapped.bind(this, next_state, obj) : this.call_wrapper.bind(this, next_state, obj);\n\t\tthis._outstanding_wrappers++;\n\n\t\t// Try-catch block to handle normal exception flow\n\t\tlet result = undefined;\n\t\ttry {\n\t\t\t// Call next method in the chain\n\t\t\tresult = fn.call(obj, next_fn, ...args);\n\t\t}\n\t\tcatch(e) {\n\t\t\treturn this._cleanup_call_wrapper_thrown(next_state, e);\n\t\t}\n\n\t\t// If the result is a Promise, then we must wait until it fulfills before cleaning up.\n\t\t// Per the JS spec, the only way to detect a Promise (since Promises can be polyfilled, extended, wrapped, etc) is to look for the 'then' method.\n\t\t// Anything with a 'then' function is technically a Promise. This leaves a path for false-positives, but I don't see a way to avoid this.\n\t\tif(typeof result?.then === 'function') {\n\t\t\tresult = result.then(\n\t\t\t\t// onResolved\n\t\t\t\tv => this._cleanup_call_wrapper(v, next_state, data, fn_data, next_fn, obj, args),\n\t\t\t\t// onRejected\n\t\t\t\te => this._cleanup_call_wrapper_thrown(next_state, e)\n\t\t\t);\n\t\t}\n\t\t// Otherwise, we can immediately cleanup.\n\t\telse {\n\t\t\tresult = this._cleanup_call_wrapper(result, next_state, data, fn_data, next_fn, obj, args);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\t_call_wrapper_update_state(state) {\n\t\t// Keep track of call state\n\t\tif('valid' in state && !state.valid) {\n\t\t\tthrow new ERRORS.invalid_chain(\n\t\t\t\tthis,\n\t\t\t\tstate.prev_data?.package_info,\n\t\t\t\t`This wrapper function for '${this.name}' is no longer valid, and must not be called.`\n\t\t\t);\n\t\t}\n\n\t\t// Mark this state object as called\n\t\tstate.called = true;\n\t}\n\n\t_invalidate_state(state) {\n\t\tstate.valid = false;\n\n\t\tthis._outstanding_wrappers--;\n\t\tif(this._outstanding_wrappers < 0)\n\t\t\tthrow new ERRORS.internal(`Outstanding wrappers = ${this._outstanding_wrappers}, should never fall below 0.`);\n\t}\n\n\t_cleanup_call_wrapper_thrown(next_state, e) {\n\t\t// An exception/rejection causes invalidation of next_state\n\t\tthis._invalidate_state(next_state);\n\n\t\t// Re-throw\n\t\tthrow e;\n\t}\n\n\t_cleanup_call_wrapper(result, next_state, data, fn_data, next_fn, obj, args) {\n\t\t// Try-finally to ensure we invalidate the wrapper even if this logic fails\n\t\ttry {\n\t\t\t// Check that next_fn was called\n\t\t\tif(!next_state.called) {\n\t\t\t\t// We need to collect affected package information if we're collecting statistics, or we haven't warned the user of this conflict yet.\n\t\t\t\tlet collect_affected = (!data.warned_conflict || LibWrapperStats.collect_stats);\n\t\t\t\tlet affectedPackages = null;\n\t\t\t\tlet is_last_wrapper = false;\n\t\t\t\tlet notify_user = false;\n\n\t\t\t\tif(collect_affected) {\n\t\t\t\t\taffectedPackages = fn_data.slice(next_state.index).filter((x) => {\n\t\t\t\t\t\treturn !x.package_info.equals(data.package_info);\n\t\t\t\t\t}).map((x) => {\n\t\t\t\t\t\treturn x.package_info;\n\t\t\t\t\t});\n\n\t\t\t\t\tis_last_wrapper = (affectedPackages.length == 0);\n\n\t\t\t\t\tif(!is_last_wrapper)\n\t\t\t\t\t\tnotify_user = LibWrapperConflicts.register_conflict(data.package_info, affectedPackages, this, null, true);\n\t\t\t\t}\n\n\t\t\t\t// WRAPPER-type functions that do this are breaking an API requirement, as such we need to be loud about this.\n\t\t\t\t// As a \"punishment\" of sorts, we forcefully unregister them and ignore whatever they did.\n\t\t\t\tif(data.type === WRAPPER_TYPES.WRAPPER) {\n\t\t\t\t\t// We automatically trigger an unhandled error since we don't want to throw\n\t\t\t\t\tconst error = new ERRORS.package(\n\t\t\t\t\t\t`The wrapper for '${data.target}' registered by ${data.package_info.type_plus_id} with type WRAPPER did not chain the call to the next wrapper, which breaks a libWrapper API requirement. This wrapper will be unregistered.`,\n\t\t\t\t\t\tdata.package_info\n\t\t\t\t\t);\n\t\t\t\t\tonUnhandledError(error);\n\t\t\t\t\tconsole.error(error);\n\n\t\t\t\t\t// Unregister this module\n\t\t\t\t\tglobalThis.libWrapper.unregister(data.package_info.id, data.target);\n\n\t\t\t\t\t// Manually chain to the next wrapper if there are more in the chain\n\t\t\t\t\tif(!is_last_wrapper)\n\t\t\t\t\t\tresult = next_fn.apply(obj, args);\n\t\t\t\t}\n\n\t\t\t\t// Other WRAPPER_TYPES get a generic 'conflict' message\n\t\t\t\telse if(notify_user && !data.warned_conflict) {\n\t\t\t\t\tLibWrapperNotifications.conflict(data.package_info, affectedPackages, true, `${data.package_info.type_plus_id_capitalized} did not chain the wrapper for '${data.target}'.`);\n\t\t\t\t\tdata.warned_conflict = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfinally {\n\t\t\t// Invalidate state to avoid asynchronous calls\n\t\t\tthis._invalidate_state(next_state);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\n\n\t// Non-property setter\n\tset_nonproperty(value, obj=null) {\n\t\tif(this.is_property)\n\t\t\tthrow new ERRORS.internal('Must not call \\'set_nonproperty\\' for a property wrapper.');\n\n\t\tconst inherited = (obj !== this.object);\n\n\t\t// If assigning to an instance directly, assign directly to instance\n\t\tif(inherited) {\n\t\t\tObject.defineProperty(obj, this.fn_name, {\n\t\t\t\tvalue: value,\n\t\t\t\tconfigurable: true,\n\t\t\t\tenumerable: true,\n\t\t\t\twritable: true\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Wrap the new value\n\t\tthis._wrapped = value;\n\t\tthis.skip_existing_handlers();\n\n\t\t// Warn user and/or log conflict\n\t\tthis.warn_classic_wrapper();\n\t}\n\n\n\n\t// Conflict logging utilities\n\tget_affected_packages() {\n\t\tconst affectedPackages = this.getter_data.map((x) => {\n\t\t\treturn x.package_info;\n\t\t});\n\n\t\treturn affectedPackages;\n\t}\n\n\twarn_classic_wrapper() {\n\t\tconst package_info = new PackageInfo();\n\t\tconst affectedPackages = this.get_affected_packages();\n\n\t\tif(affectedPackages.length > 0) {\n\t\t\tconst notify_user = LibWrapperConflicts.register_conflict(package_info, affectedPackages, this, null, true);\n\n\t\t\tif(notify_user) {\n\t\t\t\tLibWrapperNotifications.conflict(package_info, affectedPackages, true, `Detected non-libWrapper wrapping of '${this.name}' by ${package_info.type_plus_id}. This will potentially lead to conflicts.`);\n\n\t\t\t\tif(DEBUG && console.trace)\n\t\t\t\t\tconsole.trace();\n\t\t\t}\n\t\t}\n\n\t\tif(!this.detected_classic_wrapper)\n\t\t\tthis.detected_classic_wrapper = []\n\t\tthis.detected_classic_wrapper.push(package_info.key);\n\t}\n\n\n\n\t// Wraper array methods\n\t// NOTE: These should only ever be called from libWrapper, they do not clean up after themselves\n\tget_fn_data(setter, to_modify=false) {\n\t\t// to_modify=true must be used any time the fn_data array will be modified.\n\t\t// If there are any outstanding wrapper calls, this will force the creation of a copy of the array, to avoid affecting said outstanding wrapper calls.\n\n\t\t// Sanity check\n\t\tif(setter && !this.is_property)\n\t\t\tthrow new ERRORS.internal(`libWrapper: '${this.name}' does not wrap a property, thus setter=true is illegal.`);\n\n\t\t// Get current fn_data\n\t\tconst prop_nm = setter ? 'setter_data' : 'getter_data';\n\t\tlet result = this[prop_nm];\n\n\t\t// If we are going to modify the return result...\n\t\tif(to_modify) {\n\t\t\t// Duplicate fn_data if we are modifying it and there are outstanding wrappers\n\t\t\tif(this._outstanding_wrappers > 0) {\n\t\t\t\tresult = this[prop_nm].slice(0);\n\t\t\t\tthis[prop_nm] = result;\n\t\t\t}\n\n\t\t\t// Increment unique ID\n\t\t\tthis[`_${prop_nm}_id`]++;\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\t_post_update_fn_data() {\n\t\tthis.update_use_static_dispatch();\n\t}\n\n\tsort() {\n\t\tfor(let setter of [false, true]) {\n\t\t\tif(setter && !this.is_property)\n\t\t\t\tcontinue;\n\n\t\t\tlet fn_data = this.get_fn_data(setter);\n\t\t\tfn_data.sort((a,b) => { return a.type.value - b.type.value || b.priority - a.priority });\n\t\t}\n\t}\n\n\tadd(data) {\n\t\t// Try to set a function name if there is none already\n\t\tconst fn = data.fn;\n\t\tif(!fn.name || fn.name === 'anonymous')\n\t\t\tset_function_name(fn, this._callstack_name(data.package_info.id ?? '<unknown>'));\n\n\t\t// Add to fn_data\n\t\tconst fn_data = this.get_fn_data(data.setter, true);\n\n\t\tfn_data.splice(0, 0, data);\n\t\tthis.sort(data.setter);\n\n\t\tthis._post_update_fn_data();\n\t}\n\n\tremove(data) {\n\t\tconst fn_data = this.get_fn_data(data.setter, true);\n\n\t\tconst index = fn_data.indexOf(data);\n\t\tfn_data.splice(index, 1);\n\n\t\tthis._post_update_fn_data();\n\t}\n\n\tclear() {\n\t\tthis.getter_data = [];\n\n\t\tif(this.is_property)\n\t\t\tthis.setter_data = [];\n\n\t\tthis._post_update_fn_data();\n\t}\n\n\tis_empty() {\n\t\treturn !this.getter_data.length && !this.setter_data?.length;\n\t}\n};\ndecorate_class_function_names(Wrapper);\n\n// Prevent modifications\nObject.freeze(Wrapper);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport { VERSION } from '../shared/version.js';\nimport { PACKAGE_ID, PACKAGE_TITLE } from '../consts.js';\nimport { WRAPPER_TYPES, PERF_MODES } from '../lib/enums.js';\nimport { LibWrapperStats } from './stats.js';\nimport { WRAPPERS } from '../utils/misc.js';\nimport { PackageInfo, PACKAGE_TYPES } from '../shared/package_info.js';\nimport { i18n } from '../shared/i18n.js';\n\n// Map of currently loaded priorities\nexport const PRIORITIES = new Map();\n\nexport const load_priorities = function(value=null) {\n\t// Create existing priorities\n\tPRIORITIES.clear();\n\n\t// Parse config\n\tconst priority_cfg = value ?? game?.settings?.get(PACKAGE_ID, 'module-priorities');\n\tif(!priority_cfg)\n\t\treturn;\n\n\tfor(let type of ['prioritized', 'deprioritized']) {\n\t\tconst current = priority_cfg[type];\n\t\tif(!current)\n\t\t\tcontinue;\n\n\t\tconst base_priority = (type == 'prioritized') ? 10000 : -10000;\n\n\t\tlet new_current = null;\n\t\tObject.entries(current).forEach(entry => {\n\t\t\tlet [key, data] = entry;\n\n\t\t\t// Handle legacy format, if found\n\t\t\tif(!data.id) {\n\t\t\t\tdata = new PackageInfo(key, PACKAGE_TYPES.MODULE);\n\t\t\t\tkey = data.key;\n\t\t\t}\n\n\t\t\t// Add to priorities dictionary\n\t\t\tif(PRIORITIES.has(key))\n\t\t\t\treturn;\n\n\t\t\tPRIORITIES.set(key, base_priority - data.index);\n\t\t});\n\t}\n}\n\n\n\n// Main settings class\nexport class LibWrapperSettings extends FormApplication {\n\tstatic init() {\n\t\tgame.settings.register(PACKAGE_ID, 'notify-issues-gm', {\n\t\t\tname: `${PACKAGE_ID}.settings.notify-issues-gm.name`,\n\t\t\thint: `${PACKAGE_ID}.settings.notify-issues-gm.hint`,\n\t\t\tdefault: true,\n\t\t\ttype: Boolean,\n\t\t\tscope: 'world',\n\t\t\tconfig: true,\n\t\t});\n\n\t\tgame.settings.register(PACKAGE_ID, 'notify-issues-player', {\n\t\t\tname: `${PACKAGE_ID}.settings.notify-issues-player.name`,\n\t\t\thint: `${PACKAGE_ID}.settings.notify-issues-player.hint`,\n\t\t\tdefault: false,\n\t\t\ttype: Boolean,\n\t\t\tscope: 'world',\n\t\t\tconfig: true,\n\t\t});\n\n\t\tgame.settings.register(PACKAGE_ID, 'high-performance-mode', {\n\t\t\tname: `${PACKAGE_ID}.settings.high-performance-mode.name`,\n\t\t\thint: `${PACKAGE_ID}.settings.high-performance-mode.hint`,\n\t\t\tdefault: false,\n\t\t\ttype: Boolean,\n\t\t\tscope: 'world',\n\t\t\tconfig: true,\n\t\t});\n\n\t\tgame.settings.registerMenu(PACKAGE_ID, 'menu', {\n\t\t\tname: '',\n\t\t\tlabel: `${PACKAGE_ID}.settings.menu.title`,\n\t\t\ticon: \"fas fa-cog\",\n\t\t\ttype: LibWrapperSettings,\n\t\t\trestricted: true\n\t\t});\n\n\t\tgame.settings.register(PACKAGE_ID, 'module-priorities', {\n\t\t\tname: '',\n\t\t\tdefault: {},\n\t\t\ttype: Object,\n\t\t\tscope: 'world',\n\t\t\tconfig: false,\n\t\t\tonChange: value => load_priorities()\n\t\t});\n\n\t\t// Variables\n\t\tthis.show_ignored_conflicts = false;\n\n\t\t// When done, load the priorities\n\t\tload_priorities();\n\n\t\t// Seal to prevent accidental modification\n\t\tObject.seal(this);\n\t}\n\n\n\t// Settings UI\n\tstatic get defaultOptions() {\n\t\treturn {\n\t\t\t...super.defaultOptions,\n\t\t\ttemplate: `modules/${PACKAGE_ID}/templates/settings.html`,\n\t\t\theight: 700,\n\t\t\ttitle: i18n.localize(`${PACKAGE_ID}.settings.menu.title`),\n\t\t\twidth: 600,\n\t\t\tclasses: [PACKAGE_ID, \"settings\"],\n\t\t\ttabs: [\n\t\t\t\t{\n\t\t\t\t\tnavSelector: '.tabs',\n\t\t\t\t\tcontentSelector: 'form',\n\t\t\t\t\tinitial: 'name'\n\t\t\t\t}\n\t\t\t],\n\t\t\tsubmitOnClose: false,\n\t\t\tcloseOnSubmit: false\n\t\t}\n\t}\n\n\tconstructor(object = {}, options) {\n\t\tsuper(object, options);\n\t}\n\n\tstatic showYesNoDialog(msg, yes_callback) {\n\t\tnew Dialog({\n\t\t\tcontent: msg,\n\t\t\tbuttons: {\n\t\t\t\tyes: {\n\t\t\t\t\ticon: '<i class=\"fas fa-check\"></i>',\n\t\t\t\t\tlabel: i18n.localize(`${PACKAGE_ID}.settings.yes`),\n\t\t\t\t\tcallback: yes_callback\n\t\t\t\t},\n\t\t\t\tno: {\n\t\t\t\t\ticon: '<i class=\"fas fa-times\"></i>',\n\t\t\t\t\tlabel: i18n.localize(`${PACKAGE_ID}.settings.no`)\n\t\t\t\t}\n\t\t\t}\n\t\t}).render(true);\n\t}\n\n\tgetActiveWrappers() {\n\t\tlet data = [];\n\n\t\tWRAPPERS.forEach((wrapper) => {\n\t\t\tfor(let is_setter of [false, true]) {\n\t\t\t\tif(is_setter && !wrapper.is_property)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tlet name = wrapper.name;\n\t\t\t\tif(is_setter)\n\t\t\t\t\tname = `${name}#set`;\n\n\t\t\t\tlet _d = {\n\t\t\t\t\tname  : name,\n\t\t\t\t\tpackages: []\n\t\t\t\t};\n\n\t\t\t\twrapper.get_fn_data(is_setter).forEach((fn_data) => {\n\t\t\t\t\tif(fn_data.package_info.id == PACKAGE_ID)\n\t\t\t\t\t\treturn;\n\n\t\t\t\t\tconst d = {\n\t\t\t\t\t\tname     : fn_data.package_info.settingsName,\n\t\t\t\t\t\ttype     : fn_data.type.name,\n\t\t\t\t\t\tperf_mode: fn_data.perf_mode.name\n\t\t\t\t\t};\n\n\t\t\t\t\tif(d.perf_mode == 'AUTO')\n\t\t\t\t\t\td.perf_mode = null;\n\t\t\t\t\telse\n\t\t\t\t\t\td.perf_mode = `, ${d.perf_mode}`;\n\n\t\t\t\t\t_d.packages.push(d);\n\t\t\t\t});\n\n\t\t\t\tif(wrapper.detected_classic_wrapper) {\n\t\t\t\t\twrapper.detected_classic_wrapper.forEach((key) => {\n\t\t\t\t\t\t_d.packages.push({\n\t\t\t\t\t\t\tname     : new PackageInfo(key).settingsName,\n\t\t\t\t\t\t\ttype     : 'MANUAL',\n\t\t\t\t\t\t\tperf_mode: null\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif(_d.packages.length > 0)\n\t\t\t\t\tdata.push(_d);\n\t\t\t}\n\t\t});\n\n\t\tdata.sort((a,b) => b.packages.length - a.packages.length);\n\n\t\treturn data;\n\t}\n\n\tgetConflicts() {\n\t\tif(!LibWrapperStats.collect_stats)\n\t\t\treturn null;\n\n\t\tlet data = [];\n\n\t\tLibWrapperStats.conflicts.forEach((conflict) => {\n\t\t\tlet total = conflict.count;\n\t\t\tif(this.show_ignored_conflicts)\n\t\t\t\ttotal += conflict.ignored;\n\n\t\t\tif(total == 0)\n\t\t\t\treturn;\n\n\t\t\tconst targets = [];\n\n\t\t\tdata.push({\n\t\t\t\tcount: conflict.count,\n\t\t\t\tignored: this.show_ignored_conflicts ? conflict.ignored : 0,\n\t\t\t\ttotal: total,\n\t\t\t\tpackage_id: conflict.package_info.settingsName,\n\t\t\t\tother_id: conflict.other_info.settingsName,\n\t\t\t\ttargets: targets\n\t\t\t});\n\n\t\t\tconflict.targets.forEach((obj, target) => {\n\t\t\t\tlet obj_total = obj.count;\n\t\t\t\tif(this.show_ignored_conflicts)\n\t\t\t\t\tobj_total += obj.ignored;\n\n\t\t\t\tif(obj_total > 0)\n\t\t\t\t\ttargets.push({\n\t\t\t\t\t\ttarget: target,\n\t\t\t\t\t\tcount: obj.count,\n\t\t\t\t\t\ttotal: obj_total,\n\t\t\t\t\t\tignored: this.show_ignored_conflicts ? obj.ignored : 0\n\t\t\t\t\t});\n\t\t\t});\n\n\t\t\ttargets.sort((a,b) => a.total - b.total);\n\t\t});\n\n\t\tdata.sort((a,b) => a.total - b.total);\n\n\t\treturn data;\n\t}\n\n\tgetPackages() {\n\t\tlet ret = {\n\t\t\tprioritized: [],\n\t\t\tnormal: [],\n\t\t\tdeprioritized: []\n\t\t};\n\n\t\tconst priorities = game.settings.get(PACKAGE_ID, 'module-priorities');\n\t\tconst cfg_prioritized   = priorities.prioritized   ?? {};\n\t\tconst cfg_deprioritized = priorities.deprioritized ?? {};\n\n\t\tconst inactive = i18n.localize(`${PACKAGE_ID}.settings.menu.priorities.package-inactive`);\n\n\t\t// Normal packages\n\t\tif(LibWrapperStats.collect_stats) {\n\t\t\tLibWrapperStats.packages.forEach((key) => {\n\t\t\t\tconst info = new PackageInfo(key);\n\n\t\t\t\tif(info.key in cfg_prioritized || info.key in cfg_deprioritized)\n\t\t\t\t\treturn;\n\n\t\t\t\tret.normal.push(info);\n\t\t\t});\n\t\t\tret.normal.sort((a,b) => a.id.localeCompare(b.id));\n\t\t}\n\n\t\t// Prioritized packages\n\t\tObject.entries(cfg_prioritized).forEach((entry) => {\n\t\t\tlet [key, data] = entry;\n\n\t\t\t// Handle legacy format, if found\n\t\t\tif(!data.id) {\n\t\t\t\tdata = new PackageInfo(key, PACKAGE_TYPES.MODULE);\n\t\t\t\tkey = data.key;\n\t\t\t}\n\n\t\t\t// Push data\n\t\t\tret.prioritized.push({\n\t\t\t\tkey  : key,\n\t\t\t\tid   : data.id,\n\t\t\t\ttitle: data.title ?? `${data.title} <${inactive}>`,\n\t\t\t\tindex: data.index\n\t\t\t});\n\t\t});\n\t\tret.prioritized.sort((a,b) => { return a.index - b.index });\n\n\t\t// Deprioritized packages\n\t\tObject.entries(cfg_deprioritized).forEach((entry) => {\n\t\t\tlet [key, data] = entry;\n\n\t\t\t// In case something went wrong and we have a duplicate package\n\t\t\tif(key in cfg_prioritized)\n\t\t\t\treturn;\n\n\t\t\t// Handle legacy format, if found\n\t\t\tif(!data.id) {\n\t\t\t\tdata = new PackageInfo(key, PACKAGE_TYPES.MODULE);\n\t\t\t\tkey = data.key;\n\t\t\t}\n\n\t\t\t// Push data\n\t\t\tret.deprioritized.push({\n\t\t\t\tkey  : key,\n\t\t\t\tid   : data.id,\n\t\t\t\ttitle: data.title ?? `${data.title} <${inactive}>`,\n\t\t\t\tindex: data.index\n\t\t\t});\n\t\t});\n\t\tret.deprioritized.sort((a,b) => { return a.index - b.index });\n\n\t\t// Done\n\t\treturn ret;\n\t}\n\n\tgetData() {\n\t\t// Prepare the list of help links\n\t\tconst support_list = [];\n\t\t{\n\t\t\tconst key = `${PACKAGE_ID}.support-channels`;\n\t\t\tconst list = i18n.localize(key);\n\t\t\tif(Array.isArray(list)) {\n\t\t\t\tfor(const entry of list) {\n\t\t\t\t\tif(!('title' in entry) || !('url' in entry))\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tsupport_list.push(entry);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Create data object\n\t\tlet data = {\n\t\t\tabout: {\n\t\t\t\tname: PACKAGE_TITLE,\n\t\t\t\tversion: VERSION.full_git,\n\t\t\t\tcollect_stats: LibWrapperStats.collect_stats,\n\t\t\t\ttranslation_credits: i18n.localize(`${PACKAGE_ID}.settings.menu.about.credits-translation`),\n\t\t\t\tsupport: support_list\n\t\t\t},\n\n\t\t\twrappers: this.getActiveWrappers(),\n\t\t\tconflicts: this.getConflicts(),\n\t\t\tpackages: this.getPackages(),\n\t\t\tshow_ignored_conflicts: this.show_ignored_conflicts\n\t\t};\n\n\t\treturn data;\n\t}\n\n\tactivateListeners(html) {\n\t\tsuper.activateListeners(html);\n\n\t\tlet _this = this;\n\n\t\t// Tree view\n\t\thtml.find('.caret.has-nested').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\t$this.parent().find('.nested').toggleClass('active');\n\t\t\t$this.toggleClass('caret-down');\n\t\t});\n\n\t\t// Reload button\n\t\thtml.find('button.reload').on('click', function(event) {\n\t\t\t_this.render(true);\n\t\t});\n\n\t\t// Show ignored conflicts checkbox\n\t\thtml.find('.lw-show-ignored-conflicts').on('change', function(event) {\n\t\t\tconst $this = $(this);\n\t\t\tconst checkbox = $this.find('input[type=checkbox]');\n\t\t\tconst checked = checkbox.prop('checked');\n\n\t\t\t_this.show_ignored_conflicts = checked;\n\t\t\t_this.render(true);\n\t\t});\n\n\t\t// Easily focus the priority groups\n\t\thtml.find('.package-priority-group').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst select = $this.find('select');\n\n\t\t\tif(!select.is(':focus'))\n\t\t\t\tselect.focus();\n\t\t});\n\n\t\t// Change priority buttons\n\t\thtml.find('button.change-priority').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst which = $this.data('which');\n\t\t\tconst direction = $this.data('direction');\n\t\t\tconst up = (direction === 'up');\n\n\t\t\tconst list = html.find(`.${which}`);\n\t\t\tconst selected = list.find('option:selected');\n\n\t\t\tconst insertPos = up ? selected.prev() : selected.next();\n\n\t\t\tif(!insertPos.length)\n\t\t\t\treturn;\n\n\t\t\tif(up)\n\t\t\t\tinsertPos.before(selected);\n\t\t\telse\n\t\t\t\tinsertPos.after(selected);\n\t\t});\n\n\t\t// Change category buttons\n\t\thtml.find('button.change-category').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst _from = $this.data('from');\n\t\t\tconst _to = $this.data('to');\n\n\t\t\tconst from = html.find(`.${_from}`);\n\t\t\tconst to = html.find(`.${_to}`);\n\n\t\t\tconst element = from.find('option:selected');\n\n\t\t\t// Search for the element to focus next\n\t\t\tlet next_focus = element.next();\n\t\t\tif(next_focus.length == 0)\n\t\t\t\tnext_focus = element.prev();\n\n\t\t\t// Move to the destination list\n\t\t\tto.append(element);\n\n\t\t\t// If the destination was the 'normal', we need to sort it alphabetically\n\t\t\tif(_to == 'packages-normal') {\n\t\t\t\tconst options = to.find('option');\n\t\t\t\toptions.sort((a,b) => { return $(a).val() > $(b).val() ? 1 : -1 });\n\t\t\t\tto.empty().append(options);\n\t\t\t}\n\n\t\t\t// Focus the previous list again\n\t\t\tif(next_focus.length)\n\t\t\t\tfrom.val(next_focus.val());\n\n\t\t\tfrom.focus();\n\t\t});\n\n\t\t// Submit 'Priorities'\n\t\thtml.find('.submit').on('click', function(event) {\n\t\t\t// Collect prioritization order into hidden fields that will be submitted\n\t\t\tfor(let type of ['packages-prioritized', 'packages-deprioritized']) {\n\t\t\t\tconst select = html.find(`.${type}`);\n\n\t\t\t\tconst options = select.find('option');\n\n\t\t\t\tlet arr = [];\n\t\t\t\toptions.each((i, option) => {\n\t\t\t\t\tarr.push($(option).val());\n\t\t\t\t});\n\n\t\t\t\t$('<input>').attr('type', 'hidden').attr('name', `${type}-hidden`).attr('value', arr.join(',')).appendTo(html);\n\t\t\t}\n\n\t\t\thtml.submit();\n\t\t});\n\n\t\t// Reset button\n\t\thtml.find('.reset').on('click', function(event) {\n\t\t\t$('input[type=hidden]').remove();\n\n\t\t\tLibWrapperSettings.showYesNoDialog(`<p>${i18n.localize(`${PACKAGE_ID}.settings.menu.warning-reset-priorities`)}</p>`, () => {\n\t\t\t\tfor(let type of ['packages-prioritized', 'packages-deprioritized']) {\n\t\t\t\t\t$('<input>').attr('type', 'hidden').attr('name', `${type}-hidden`).attr('value', '').appendTo(html);\n\t\t\t\t}\n\n\t\t\t\thtml.submit();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync _updateObject(ev, formData) {\n\t\t// Parse priorities\n\t\tconst priorities = game.settings.get(PACKAGE_ID, 'module-priorities');\n\n\t\tfor(let type of ['prioritized', 'deprioritized']) {\n\t\t\tconst fld = `packages-${type}-hidden`;\n\n\t\t\tif(!(fld in formData))\n\t\t\t\tcontinue;\n\n\t\t\tconst value = formData[fld];\n\t\t\tconst split = (value === '') ? [] : value.split(',');\n\n\t\t\tlet old_prio = priorities[type] ?? {};\n\t\t\tlet new_prio = {};\n\t\t\tlet counter = 0;\n\n\t\t\tsplit.forEach((key) => {\n\t\t\t\tif(!key)\n\t\t\t\t\treturn;\n\n\t\t\t\tconst old_data = old_prio[key];\n\t\t\t\tconst new_data = new PackageInfo(key);\n\n\t\t\t\tnew_prio[key] = {\n\t\t\t\t\tid   : new_data.id,\n\t\t\t\t\ttitle: new_data.exists ? new_data.title : old_data.title,\n\t\t\t\t\tindex: counter++\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tpriorities[type] = new_prio;\n\t\t}\n\n\t\t// Sanity check for duplicates\n\t\tObject.keys(priorities.deprioritized).forEach((key) => {\n\t\t\tif(key in priorities.prioritized)\n\t\t\t\tdelete priorities.deprioritized[key];\n\t\t});\n\n\t\t// Save\n\t\tawait game.settings.set(PACKAGE_ID, 'module-priorities', priorities);\n\n\t\t// Re-render\n\t\tthis.render(true);\n\n\t\t// Ask user to refresh page\n\t\tLibWrapperSettings.showYesNoDialog(`<p>${i18n.localize(`${PACKAGE_ID}.settings.menu.warning-save`)}</p>`, () => location.reload());\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {\n//#if !_ROLLUP\n\tparse_manifest_version,\n//#endif\n\tVERSION, version_at_least\n} from '../shared/version.js';\n\nimport {\n\tPACKAGE_ID, HOOKS_SCOPE, IS_UNITTEST, PROPERTIES_CONFIGURABLE, DEBUG, setDebug,\n} from '../consts.js';\n\nimport { WRAPPER_TYPES, PERF_MODES } from './enums.js';\nimport { Wrapper } from './wrapper.js';\nimport { get_global_variable, WRAPPERS, decorate_name, decorate_class_function_names } from '../utils/misc.js';\nimport { PackageInfo, PACKAGE_TYPES } from '../shared/package_info.js';\n\nimport { init_error_listeners, onUnhandledError } from '../errors/listeners.js';\nimport { ERRORS } from '../errors/errors.js';\n\nimport { LibWrapperNotifications } from '../ui/notifications.js'\nimport { LibWrapperStats } from '../ui/stats.js';\nimport { LibWrapperConflicts } from '../ui/conflicts.js';\nimport { LibWrapperSettings, PRIORITIES } from '../ui/settings.js';\nimport { i18n } from '../shared/i18n.js';\n\n\n\n// Internal variables\nlet libwrapper_ready = false;\nlet allow_libwrapper_registrations = true;\n\n\n// Regexes used in _get_target_object\nconst TGT_SPLIT_RE = new RegExp([\n\t'(',                     // {\n\t\t'[^.[]+',            //   Match anything not containing a . or [\n\t'|',                     // |\n\t\t'\\\\[',               //   Match anything starting with [\n\t\t'(',                 //   {\n\t\t\t\"'\",             //     Followed by a '\n\t\t\t'(',             //     {\n\t\t\t\t'[^\\'\\\\\\\\]', //       That does not contain ' or \\\n\t\t\t'|',             //     |\n\t\t\t\t'\\\\\\\\.',     //       Ignore any character that is escaped by \\\n\t\t\t')+?',           //     } (Non-greedy)\n\t\t\t\"'\",             //     Ending in a '\n\t\t'|',                 //   |\n\t\t\t'\"',             //     Followed by a \"\n\t\t\t'(',             //     {\n\t\t\t\t'[^\"\\\\\\\\]',  //       That does not contain \" or \\\n\t\t\t'|',             //     |\n\t\t\t\t'\\\\\\\\.',     //       Ignore any character that is escaped by \\\n\t\t\t')+?',           //     } (Non-greedy)\n\t\t\t'\"',             //     Ending in a \"\n\t\t')',                 //   }\n\t\t'\\\\]',               //   And ending with ]\n\t')'                      // }\n].join(''), 'g');\n\nconst TGT_CLEANUP_RE = new RegExp([\n\t'(',          // {\n\t\t'^\\\\[\\'', //   Anything starting with ['\n\t'|',          // |\n\t\t'\\'\\\\]$', //   Anything ending with ']\n\t'|',          // |\n\t\t'^\\\\[\"',  //   Anything starting with [\"\n\t'|',          // |\n\t\t'\"\\\\]$',  //   Anything ending with \"]\n\t')'           // }\n].join(''), 'g');\n\n\n// Internal Methods\nexport function _create_wrapper_from_object(obj, fn_name, name=undefined, package_info=undefined) {\n\tconst wrapper = new Wrapper(obj, fn_name, name, package_info);\n\tWRAPPERS.add(wrapper);\n\treturn wrapper;\n}\n\nfunction _split_target_and_setter(target) {\n\tlet is_setter = target.endsWith('#set');\n\tlet _target = !is_setter ? target : target.slice(0, -4);\n\n\treturn [_target, is_setter];\n}\n\nfunction _valid_root_scope_string(str) {\n\treturn /^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(str);\n}\n\nfunction _valid_target_string(str) {\n\treturn /^[a-zA-Z_$][0-9a-zA-Z_$]*?([.[]|$)/.test(str);\n}\n\nfunction _get_target_object(_target, package_info=undefined) {\n\t// Parse the target\n\tconst target = _split_target_and_setter(_target)[0];\n\tif(!_valid_target_string(target))\n\t\tthrow new ERRORS.package(`Invalid target '${target}'.`, package_info);\n\n\t// Split the target\n\tconst split = target.match(TGT_SPLIT_RE).map((x)=>x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE,''));\n\n\t// Get root object\n\tconst root_nm = split.splice(0,1)[0]; // equivalent to 'split.pop_front()' which JS doesn't have\n\tif(!_valid_root_scope_string(root_nm))\n\t\tthrow new ERRORS.package(`Invalid target '${target}': Invalid root scope '${root_nm}'.`, package_info);\n\tif(root_nm == 'libWrapper')\n\t\tthrow new ERRORS.package(`Not allowed to wrap libWrapper internals.`, package_info);\n\n\t// Figure out the object and function name we want to wrap\n\tlet obj, fn_name;\n\tif(split.length == 0) {\n\t\t// In order to wrap something in global scope, it must be accessible from 'globalThis'\n\t\tif(!(root_nm in globalThis))\n\t\t\tthrow new ERRORS.package(`Could not find target '${target}': Could not find scope 'globalThis.${root_nm}'.`, package_info);\n\n\t\tfn_name = root_nm;\n\t\tobj = globalThis;\n\t}\n\telse {\n\t\t// Get function name\n\t\tfn_name = split.pop();\n\n\t\t// Get root variable\n\t\tconst root = get_global_variable(root_nm);\n\t\tif(!root)\n\t\t\tthrow new ERRORS.package(`Could not find target '${target}': Could not find root scope '${root_nm}'.`, package_info);\n\n\t\t// Get target object\n\t\tobj = root;\n\t\tfor(const scope of split) {\n\t\t\tobj = obj[scope];\n\t\t\tif(!obj)\n\t\t\t\tthrow new ERRORS.package(`Could not find target '${target}': Could not find scope '${scope}'.`, package_info);\n\t\t}\n\t}\n\n\t// Done\n\treturn [obj, fn_name, target];\n}\n\nfunction _create_wrapper(target, package_info=null) {\n\t// Get target information\n\tconst tgt_info = _get_target_object(target, package_info);\n\n\t// Create wrapper\n\treturn _create_wrapper_from_object(...tgt_info, package_info);\n}\n\nfunction _find_wrapper_by_name(_name) {\n\tconst name = _split_target_and_setter(_name)[0];\n\n\tfor(let wrapper of WRAPPERS) {\n\t\tif(wrapper.names.includes(name))\n\t\t\treturn wrapper;\n\t}\n\n\treturn null;\n}\n\nfunction _find_package_data_in_wrapper(package_info, wrapper, is_setter) {\n\treturn wrapper.get_fn_data(is_setter).find((x) => x.package_info?.equals(package_info));\n}\n\nfunction _find_package_data_with_target(package_info, _target) {\n\tconst target_and_setter = _split_target_and_setter(_target);\n\tconst target    = target_and_setter[0];\n\tconst is_setter = target_and_setter[1];\n\n\tconst wrapper = _find_wrapper_by_name(target);\n\tif(!wrapper)\n\t\treturn null;\n\n\treturn _find_package_data_in_wrapper(package_info, wrapper, is_setter);\n}\n\nfunction _get_default_priority(package_info, target) {\n\tif(package_info.id === PACKAGE_ID)\n\t\treturn Number.MAX_VALUE;\n\n\tconst priority_cfg = PRIORITIES.get(package_info.key);\n\tif(priority_cfg !== undefined)\n\t\treturn priority_cfg;\n\n\treturn 0;\n}\n\nfunction _unwrap_if_possible(wrapper) {\n\tif(wrapper.is_empty() && PROPERTIES_CONFIGURABLE) {\n\t\twrapper.unwrap();\n\t\tWRAPPERS.delete(wrapper);\n\t}\n}\n\nexport function _clear(target) {\n\tconst wrapper = _find_wrapper_by_name(target);\n\n\tif(wrapper) {\n\t\twrapper.clear();\n\t\t_unwrap_if_possible(wrapper);\n\n\t\tconsole.info(`libWrapper: Cleared all wrapper functions for '${target}'.`);\n\t}\n}\n\nfunction _unregister(package_info, target, fail) {\n\t// Find wrapper\n\tconst data = _find_package_data_with_target(package_info, target);\n\tif(!data) {\n\t\tif(fail)\n\t\t\tthrow new ERRORS.package(`Cannot unregister '${target}' by ${package_info.type_plus_id} as no such wrapper has been registered`, package_info);\n\t\treturn;\n\t}\n\n\tconst wrapper = data.wrapper;\n\n\t// Remove from fn_data\n\twrapper.remove(data);\n\t_unwrap_if_possible(wrapper);\n}\n\nexport function _unwrap_all() {\n\tfor(let wrapper of WRAPPERS) {\n\t\twrapper.clear();\n\t\twrapper.unwrap();\n\t}\n\n\tWRAPPERS.clear();\n}\n\n\nfunction _get_package_info(package_id) {\n\tlet package_info = new PackageInfo();\n\n\tif(!PackageInfo.is_valid_id(package_id))\n\t\tthrow new ERRORS.package('Parameter \\'package_id\\' is invalid.', package_info);\n\n\tif(package_info.exists) {\n\t\tif(package_id != package_info.id)\n\t\t\tthrow new ERRORS.package(`${package_info.type_plus_id_capitalized} is not allowed to call libWrapper with package_id='${package_id}'.`, package_info);\n\t}\n\telse {\n\t\tpackage_info = new PackageInfo(package_id);\n\t}\n\n\tif(package_id == PACKAGE_ID) {\n\t\tif(!allow_libwrapper_registrations)\n\t\t\tthrow new ERRORS.package(`Not allowed to call libWrapper with package_id='${package_id}'.`, package_info);\n\t}\n\telse {\n\t\tif(!package_info.exists && game.modules?.size)\n\t\t\tthrow new ERRORS.package(`Package '${package_id}' is not a valid package.`, package_info);\n\t}\n\n\treturn package_info;\n}\n\nlet FORCE_FAST_MODE = false;\nfunction _force_fast_mode(new_fast_mode) {\n\tFORCE_FAST_MODE = new_fast_mode;\n}\n\n\n\n// Publicly exposed class\nexport class libWrapper {\n\t// Properties\n\t/**\n\t * Get libWrapper version\n\t * @returns {string}  libWrapper version in string form, i.e. \"<MAJOR>.<MINOR>.<PATCH>.<SUFFIX><META>\"\n\t */\n\tstatic get version() { return VERSION.full; }\n\n\t/**\n\t * Get libWrapper version\n\t * @returns {[number,number,number,number,string]}  libWrapper version in array form, i.e. [<MAJOR>, <MINOR>, <PATCH>, <SUFFIX>, <META>]\n\t */\n\tstatic get versions() { return [VERSION.major, VERSION.minor, VERSION.patch, VERSION.suffix, VERSION.meta]; }\n\n\t/**\n\t * Get the Git version identifier.\n\t * @returns {string}  Git version identifier, usually 'HEAD' or the commit hash.\n\t */\n\tstatic get git_version() { return VERSION.git };\n\n\n\t/**\n\t * @returns {boolean}  The real libWrapper module will always return false. Fallback implementations (e.g. poly-fill / shim) should return true.\n\t */\n\tstatic get is_fallback() { return false; }\n\n\t/**\n\t * @returns {boolean}  Whether libWrapper is in debug mode.\n\t */\n\tstatic get debug() { return DEBUG; }\n\t/**\n\t * @param {boolean} value  Whether to enable or disable libWrapper debug mode.\n\t */\n\tstatic set debug(value) { setDebug(value) }\n\n\n\t// Errors\n\tstatic get LibWrapperError() { return ERRORS.base; };\n\tstatic get           Error() { return ERRORS.base; }\n\n\tstatic get LibWrapperInternalError() { return ERRORS.internal; };\n\tstatic get           InternalError() { return ERRORS.internal; };\n\n\tstatic get LibWrapperPackageError() { return ERRORS.package; };\n\tstatic get           PackageError() { return ERRORS.package; };\n\n\tstatic get LibWrapperAlreadyOverriddenError() { return ERRORS.already_overridden; };\n\tstatic get           AlreadyOverriddenError() { return ERRORS.already_overridden; };\n\n\tstatic get LibWrapperInvalidWrapperChainError() { return ERRORS.invalid_chain; };\n\tstatic get          InvalidWrapperChainError () { return ERRORS.invalid_chain; };\n\n\t/* Undocumented on purpose, do not use */\n\tstatic get onUnhandledError() { return onUnhandledError; };\n\n\n\t// Enums - First introduced in v1.9.0.0\n\tstatic get WRAPPER()  { return WRAPPER_TYPES.WRAPPER  };\n\tstatic get MIXED()    { return WRAPPER_TYPES.MIXED    };\n\tstatic get OVERRIDE() { return WRAPPER_TYPES.OVERRIDE };\n\n\tstatic get PERF_NORMAL() { return PERF_MODES.NORMAL };\n\tstatic get PERF_AUTO()   { return PERF_MODES.AUTO   };\n\tstatic get PERF_FAST()   { return PERF_MODES.FAST   };\n\n\n\t// Methods\n\t/**\n\t * Test for a minimum libWrapper version.\n\t * First introduced in v1.4.0.0.\n\t *\n\t * @param {number} major   Minimum major version\n\t * @param {number} minor   [Optional] Minimum minor version. Default is 0.\n\t * @param {number} patch   [Optional] Minimum patch version. Default is 0.\n\t * @param {number} suffix  [Optional] Minimum suffix version. Default is 0.\n\t * @returns {boolean}      Returns true if the libWrapper version is at least the queried version, otherwise false.\n\t */\n\tstatic get version_at_least() { return version_at_least };\n\n\t/**\n\t * Register a new wrapper.\n\t * Important: If called before the 'init' hook, this method will fail.\n\t *\n\t * In addition to wrapping class methods, there is also support for wrapping methods on specific object instances, as well as class methods inherited from parent classes.\n\t * However, it is recommended to wrap methods directly in the class that defines them whenever possible, as inheritance/instance wrapping is less thoroughly tested and will incur a performance penalty.\n\t *\n\t * Triggers FVTT hook 'libWrapper.Register' when successful.\n\t *\n\t * @param {string} package_id  The package identifier, i.e. the 'id' field in your module/system/world's manifest.\n\t *\n\t * @param {string} target      A string containing the path to the function you wish to add the wrapper to, starting at global scope, for example 'SightLayer.prototype.updateToken'.\n\t *\n\t *   Since v1.8.0.0, the path can contain string array indexing.\n\t *   For example, 'CONFIG.Actor.sheetClasses.character[\"dnd5e.ActorSheet5eCharacter\"].cls.prototype._onLongRest' is a valid path.\n\t *   It is important to note that indexing in libWrapper does not work exactly like in JavaScript:\n\t *     - The index must be a single string, quoted using the ' or \" characters. It does not support e.g. numbers or objects.\n\t *     - A backslash \\ can be used to escape another character so that it loses its special meaning, e.g. quotes i.e. ' and \" as well as the character \\ itself.\n\t *\n\t *   By default, libWrapper searches for normal methods or property getters only. To wrap a property's setter, append '#set' to the name, for example 'SightLayer.prototype.blurDistance#set'.\n\t *\n\t * @param {function} fn        Wrapper function. The first argument will be the next function in the chain, except for 'OVERRIDE' wrappers.\n\t *                             The remaining arguments will correspond to the parameters passed to the wrapped method.\n\t *\n\t * @param {string} type        [Optional] The type of the wrapper. Default is 'MIXED'.\n\t *\n\t *   The possible types are:\n\t *\n\t *   'WRAPPER' / libWrapper.WRAPPER:\n\t *     Use if your wrapper will *always* continue the chain.\n\t *     This type has priority over every other type. It should be used whenever possible as it massively reduces the likelihood of conflicts.\n\t *     Note that the library will auto-detect if you use this type but do not call the original function, and automatically unregister your wrapper.\n\t *\n\t *   'MIXED' / libWrapper.MIXED:\n\t *     Default type. Your wrapper will be allowed to decide whether it continue the chain or not.\n\t *     These will always come after 'WRAPPER'-type wrappers. Order is not guaranteed, but conflicts will be auto-detected.\n\t *\n\t *   'OVERRIDE' / libWrapper.OVERRIDE:\n\t *     Use if your wrapper will *never* continue the chain. This type has the lowest priority, and will always be called last.\n\t *     If another package already has an 'OVERRIDE' wrapper registered to the same method, using this type will throw a <libWrapper.ERRORS.package> exception.\n\t *     Catching this exception should allow you to fail gracefully, and for example warn the user of the conflict.\n\t *     Note that if the GM has explicitly given your package priority over the existing one, no exception will be thrown and your wrapper will take over.\n\t *\n\t * @param {Object} options [Optional] Additional options to libWrapper.\n\t *\n\t * @param {boolean} options.chain [Optional] If 'true', the first parameter to 'fn' will be a function object that can be called to continue the chain.\n\t *   Default is 'false' if type=='OVERRIDE', otherwise 'true'.\n\t *   First introduced in v1.3.6.0.\n\t *\n\t * @param {string} options.perf_mode [OPTIONAL] Selects the preferred performance mode for this wrapper. Default is 'AUTO'.\n\t *   It will be used if all other wrappers registered on the same target also prefer the same mode, otherwise the default will be used instead.\n\t *   This option should only be specified with good reason. In most cases, using 'AUTO' in order to allow the GM to choose is the best option.\n\t *   First introduced in v1.5.0.0.\n\t *\n\t *   The possible modes are:\n\t *\n\t *   'NORMAL' / libWrapper.PERF_NORMAL:\n\t *     Enables all conflict detection capabilities provided by libWrapper. Slower than 'FAST'.\n\t *     Useful if wrapping a method commonly modified by other packages, to ensure most issues are detected.\n\t *     In most other cases, this mode is not recommended and 'AUTO' should be used instead.\n\t *\n\t *   'FAST' / libWrapper.PERF_FAST:\n\t *     Disables some conflict detection capabilities provided by libWrapper, in exchange for performance. Faster than 'NORMAL'.\n\t *     Will guarantee wrapper call order and per-package prioritization, but fewer conflicts will be detectable.\n\t *     This performance mode will result in comparable performance to traditional non-libWrapper wrapping methods.\n\t *     Useful if wrapping a method called repeatedly in a tight loop, for example 'WallsLayer.testWall'.\n\t *     In most other cases, this mode is not recommended and 'AUTO' should be used instead.\n\t *\n\t *   'AUTO' / libWrapper.PERF_AUTO:\n\t *     Default performance mode. If unsure, choose this mode.\n\t *     Will allow the GM to choose which performance mode to use.\n\t *     Equivalent to 'FAST' when the libWrapper 'High-Performance Mode' setting is enabled by the GM, otherwise 'NORMAL'.\n\t */\n\tstatic register(package_id, target, fn, type='MIXED', options={}) {\n\t\t// Get package information\n\t\tconst package_info = _get_package_info(package_id);\n\n\t\t// Validate we're allowed to register wrappers at this moment\n\t\tif(package_id != PACKAGE_ID && !libwrapper_ready)\n\t\t\tthrow new ERRORS.package('Not allowed to register wrappers before the \\'libWrapperReady\\' hook fires', package_info);\n\n\t\t// Validate other arguments\n\t\tif(!target || typeof target !== 'string')\n\t\t\tthrow new ERRORS.package('Parameter \\'target\\' must be a string.', package_info);\n\n\t\tif(!fn || !(fn instanceof Function))\n\t\t\tthrow new ERRORS.package('Parameter \\'fn\\' must be a function.', package_info);\n\n\t\ttype = WRAPPER_TYPES.get(type, null);\n\t\tif(type === null)\n\t\t\tthrow new ERRORS.package(`Parameter 'type' must be one of [${WRAPPER_TYPES.list.join(', ')}].`, package_info);\n\n\t\tconst chain = options?.chain ?? (type.value < WRAPPER_TYPES.OVERRIDE.value);\n\t\tif(typeof chain !== 'boolean')\n\t\t\tthrow new ERRORS.package(`Parameter 'chain' must be a boolean.`, package_info);\n\n\t\tif(IS_UNITTEST && FORCE_FAST_MODE)\n\t\t\toptions.perf_mode = 'FAST';\n\t\tconst perf_mode = PERF_MODES.get(options?.perf_mode ?? 'AUTO', null);\n\t\tif(perf_mode === null)\n\t\t\tthrow new ERRORS.package(`Parameter 'perf_mode' must be one of [${PERF_MODE.list.join(', ')}].`, package_info);\n\n\n\t\t// Split '#set' from the target\n\t\tconst target_and_setter  = _split_target_and_setter(target);\n\t\tconst target_without_set = target_and_setter[0];\n\t\tconst is_setter          = target_and_setter[1];\n\n\t\t// Create wrapper\n\t\tlet wrapper = _create_wrapper(target, package_info);\n\n\t\t// Only allow '#set' when the wrapper is wrapping a property\n\t\tif(is_setter && !wrapper.is_property)\n\t\t\tthrow new ERRORS.package(`Cannot register a wrapper for '${target}' by ${package_info.type_plus_id}' because '${target_without_set}' is not a property, and therefore has no setter.`, package_info);\n\n\t\t// Check if this wrapper is already registered\n\t\tif(_find_package_data_in_wrapper(package_info, wrapper, is_setter))\n\t\t\tthrow new ERRORS.package(`A wrapper for '${target}' has already been registered by ${package_info.type_plus_id}.`, package_info);\n\n\t\t// Get priority\n\t\tconst priority = _get_default_priority(package_info, target);\n\n\t\t// Register this package as having wrapped something\n\t\t// We do this before checking for duplicate OVERRIDEs to ensure users can change this package's priorities regardless\n\t\tif(package_info.id != PACKAGE_ID)\n\t\t\tLibWrapperStats.register_package(package_info);\n\n\t\t// Only allow one 'OVERRIDE' type\n\t\tif(type.value >= WRAPPER_TYPES.OVERRIDE.value) {\n\t\t\tconst existing = wrapper.get_fn_data(is_setter).find((x) => { return x.type === WRAPPER_TYPES.OVERRIDE });\n\n\t\t\tif(existing) {\n\t\t\t\tif(priority <= existing.priority) {\n\t\t\t\t\tthrow new ERRORS.package(package_info, existing.package_info, wrapper, target);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// We trigger a hook first\n\t\t\t\t\tif(Hooks.call(`${HOOKS_SCOPE}.OverrideLost`, existing.package_info.id, package_info.id, wrapper.name, wrapper.frozen_names) !== false) {\n\t\t\t\t\t\tconst notify_user = LibWrapperConflicts.register_conflict(package_info, existing.package_info, wrapper, null, false);\n\n\t\t\t\t\t\tif(notify_user) {\n\t\t\t\t\t\t\tLibWrapperNotifications.conflict(existing.package_info, package_info, false,\n\t\t\t\t\t\t\t\t`${package_info.type_plus_id_capitalized} has higher priority, and is replacing the 'OVERRIDE' registered by ${package_info.type_plus_id} for '${wrapper.name}'.`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Wrap\n\t\tlet data = {\n\t\t\tpackage_info : package_info,\n\t\t\ttarget       : target,\n\t\t\tsetter       : is_setter,\n\t\t\tfn           : fn,\n\t\t\ttype         : type,\n\t\t\twrapper      : wrapper,\n\t\t\tpriority     : priority,\n\t\t\tchain        : chain,\n\t\t\tperf_mode    : perf_mode\n\t\t};\n\n\t\twrapper.add(data);\n\n\t\t// Done\n\t\tif(DEBUG || (!IS_UNITTEST && package_info.id != PACKAGE_ID)) {\n\t\t\tHooks.callAll(`${HOOKS_SCOPE}.Register`, package_info.id, target, type, options);\n\t\t\tconsole.info(`libWrapper: Registered a wrapper for '${target}' by ${package_info.type_plus_id} with type ${type}.`);\n\t\t}\n\t}\n\n\t/**\n\t * Unregister an existing wrapper.\n\t *\n\t * Triggers FVTT hook 'libWrapper.Unregister' when successful.\n\t *\n\t * @param {string} package_id  The package identifier, i.e. the 'id' field in your module/system/world's manifest.\n\t * @param {string} target      A string containing the path to the function you wish to remove the wrapper from, starting at global scope. For example: 'SightLayer.prototype.updateToken'\n\t * @param {function} fail      [Optional] If true, this method will throw an exception if it fails to find the method to unwrap. Default is 'true'.\n\t */\n\tstatic unregister(package_id, target, fail=true) {\n\t\t// Get package information\n\t\tconst package_info = _get_package_info(package_id);\n\n\t\t// Unregister wrapper\n\t\t_unregister(package_info, target, fail);\n\n\t\t// Done\n\t\tif(DEBUG || package_info.id != PACKAGE_ID) {\n\t\t\tHooks.callAll(`${HOOKS_SCOPE}.Unregister`, package_info.id, target);\n\t\t\tconsole.info(`libWrapper: Unregistered the wrapper for '${target}' by ${package_info.type_plus_id}.`);\n\t\t}\n\t}\n\n\t/**\n\t * Unregister all wrappers created by a given package.\n\t *\n\t * Triggers FVTT hook 'libWrapper.UnregisterAll' when successful.\n\t *\n\t * @param {string} package_id  The package identifier, i.e. the 'id' field in your module/system/world's manifest.\n\t */\n\tstatic unregister_all(package_id) {\n\t\t// Get package information\n\t\tconst package_info = _get_package_info(package_id);\n\n\t\t// Clear package wrappers\n\t\tfor(let wrapper of WRAPPERS) {\n\t\t\tthis.unregister(package_info.id, wrapper.name, false);\n\n\t\t\tif(wrapper.is_property)\n\t\t\t\tthis.unregister(package_info.id, `${wrapper.name}#set`, false);\n\t\t}\n\n\t\tif(DEBUG || package_info.id != PACKAGE_ID) {\n\t\t\tHooks.callAll(`${HOOKS_SCOPE}.UnregisterAll`, package_info.id);\n\t\t\tconsole.info(`libWrapper: Unregistered all wrapper functions by ${package_info.type_plus_id}.`);\n\t\t}\n\t}\n\n\t/**\n\t * Ignore conflicts matching specific filters when detected, instead of warning the user.\n\t *\n\t * This can be used when there are conflict warnings that are known not to cause any issues, but are unable to be resolved.\n\t * Conflicts will be ignored if they involve both 'package_id' and one of 'ignore_ids', and relate to one of 'targets'.\n\t *\n\t * Note that the user can still see which detected conflicts were ignored, by toggling \"Show ignored conflicts\" in the \"Conflicts\" tab in the libWrapper settings.\n\t *\n\t * First introduced in v1.7.0.0.\n\t *\n\t * @param {string}            package_id  The package identifier, i.e. the 'id' field in your module/system/world's manifest. This will be the module that owns this ignore entry.\n\t * @param {(string|string[])} ignore_ids  Other package ID(s) with which conflicts should be ignored.\n\t * @param {(string|string[])} targets     Target(s) for which conflicts should be ignored, corresponding to the 'target' parameter to 'libWrapper.register'.\n\t *\n\t * @param {Object} options [Optional] Additional options to libWrapper.\n\t *\n\t * @param {boolean} options.ignore_errors  [Optional] If 'true', will also ignore confirmed conflicts (i.e. errors), rather than only potential conflicts (i.e. warnings).\n\t *     Be careful when setting this to 'true', as confirmed conflicts are almost certainly something the user should be made aware of.\n\t *     Defaults to 'false'.\n\t */\n\tstatic ignore_conflicts(package_id, ignore_ids, targets, options={}) {\n\t\t// Get package information\n\t\tconst package_info = _get_package_info(package_id);\n\n\t\t// Validate we are allowed to call this method right now\n\t\tif(!libwrapper_ready)\n\t\t\tthrow new ERRORS.package('Not allowed to ignore conflicts before the \\'libWrapperReady\\' hook fires', package_info);\n\n\t\t// Convert parameters to arrays\n\t\tif(!Array.isArray(ignore_ids))\n\t\t\tignore_ids = [ignore_ids];\n\t\tif(!Array.isArray(targets))\n\t\t\ttargets = [targets];\n\n\t\t// Validate parameters #2\n\t\tconst is_string = (x) => (typeof x === 'string');\n\n\t\tif(!ignore_ids.every(is_string))\n\t\t\tthrow new ERRORS.package(`Parameter 'ignore_ids' must be a string, or an array of strings.`, package_info);\n\n\t\tif(!targets.every(is_string))\n\t\t\tthrow new ERRORS.package(`Parameter 'targets' must be a string, or an array of strings.`, package_info);\n\t\tif(!targets.every((x) => _valid_target_string(x)))\n\t\t\tthrow new ERRORS.package(`Parameter 'targets' must only contain valid targets.`, package_info);\n\n\t\tconst ignore_errors = options.ignore_errors ?? false;\n\t\tif(typeof ignore_errors !== 'boolean')\n\t\t\tthrow new ERRORS.package(`Parameter 'options.ignore_errors' must be a boolean.`, package_info);\n\n\n\t\t// Convert 'other_ids' to PackageInfo objects and filter out any that do not exist\n\t\tconst ignore_infos = ignore_ids.map((x) => new PackageInfo(x)).filter((x) => x.exists);\n\n\t\t// Ignore API call if no packages to be ignored\n\t\tif(ignore_infos.length == 0) {\n\t\t\tconsole.debug(`libWrapper: Ignoring 'ignore_conflict' call for ${package_info.type_plus_id} since none of the package IDs provided exist or are active.`)\n\t\t\treturn;\n\t\t}\n\n\t\t// Register ignores\n\t\tLibWrapperConflicts.register_ignore(package_info, ignore_infos, targets, ignore_errors);\n\n\t\tif(DEBUG || package_info.id != PACKAGE_ID)\n\t\t\tconsole.debug(`libWrapper: Ignoring conflicts involving ${package_info.type_plus_id} and [${ignore_infos.map((x) => x.type_plus_id).join(', ')}] for targets [${targets.join(', ')}].`);\n\t}\n};\ndecorate_class_function_names(libWrapper);\nif(IS_UNITTEST) {\n\t// Some methods should be exposed during unit tests\n\tlibWrapper._UT_unwrap_all                 = _unwrap_all;\n\tlibWrapper._UT_create_wrapper_from_object = _create_wrapper_from_object\n\tlibWrapper._UT_clear                      = _clear;\n\tlibWrapper._UT_force_fast_mode            = _force_fast_mode;\n\tlibWrapper._UT_get_force_fast_mode        = (() => FORCE_FAST_MODE);\n\tlibWrapper._UT_clear_ignores              = (() => LibWrapperConflicts.clear_ignores());\n\tlibWrapper._UT_TGT_SPLIT_REGEX            = TGT_SPLIT_RE;\n\tlibWrapper._UT_TGT_CLEANUP_REGEX          = TGT_CLEANUP_RE;\n}\nObject.freeze(libWrapper);\n\n\n\n// Define as property so that it can't be deleted\ndelete globalThis.libWrapper;\nObject.defineProperty(globalThis, 'libWrapper', {\n\tget: () => libWrapper,\n\tset: (value) => { throw new ERRORS.package(\"Not allowed to re-assign the global instance of libWrapper\") },\n\tconfigurable: false\n});\n\n\n\n// Setup unhandled error listeners\ninit_error_listeners();\n\n// Initialize libWrapper right before the 'init' hook. Unit tests just initialize immediately\n{\n\tconst libWrapperInit = decorate_name('libWrapperInit');\n\tconst obj = {\n\t\t[libWrapperInit]: async function(wrapped, ...args) {\n\t\t\t// Unregister our pre-initialisation patches as they are no longer necessary\n\t\t\tif(!IS_UNITTEST) {\n\t\t\t\tconst lw_info = new PackageInfo('lib-wrapper', PACKAGE_TYPES.MODULE);\n\t\t\t\t_unregister(lw_info, 'Game.toString', /*fail=*/ true);\n\t\t\t\t_unregister(lw_info, 'Game.prototype.initialize', /*fail=*/ true);\n\t\t\t}\n\n\t\t\t// Initialization steps\n\t\t\tlibwrapper_ready = true;\n\n\t\t\t//#if !_ROLLUP\n\t\t\tparse_manifest_version();\n\t\t\t//#endif\n\n\t\t\tawait i18n.init();\n\t\t\tLibWrapperSettings.init();\n\t\t\tLibWrapperStats.init();\n\t\t\tLibWrapperConflicts.init();\n\t\t\tLibWrapperNotifications.init();\n\n\t\t\t// Notify everyone the library has loaded and is ready to start registering wrappers\n\t\t\tconsole.info(`libWrapper ${VERSION.full_git}: Ready.`);\n\t\t\tHooks.callAll(`${HOOKS_SCOPE}.Ready`, libWrapper);\n\n\t\t\treturn wrapped(...args);\n\t\t}\n\t};\n\n\tif(!IS_UNITTEST) {\n\t\tlibWrapper.register('lib-wrapper', 'Game.prototype.initialize', obj[libWrapperInit], libWrapper.WRAPPER, {perf_mode: libWrapper.PERF_FAST});\n\n\t\t// We need to prevent people patching 'Game' and breaking libWrapper.\n\t\t// Unfortunately we cannot re-define 'Game' as a non-settable property, but we can prevent people from using 'Game.toString'.\n\t\tlibWrapper.register('lib-wrapper', 'Game.toString', function() {\n\t\t\tthrow new ERRORS.package(\"Using 'Game.toString()' before libWrapper initialises is not allowed for compatibility reasons.\");\n\t\t}, libWrapper.WRAPPER, {perf_mode: libWrapper.PERF_FAST});\n\n\t\t// Add a sanity check hook, just in case someone breaks our initialisation procedure\n\t\tHooks.once('init', ()=>{\n\t\t\tif(!libwrapper_ready)\n\t\t\t\tthrow new ERRORS.internal(\"Could not successfuly initialise libWrapper, likely due to a compatibility issue with another module.\");\n\t\t});\n\t}\n\telse\n\t\tobj[libWrapperInit](()=>{});\n}\n\n// Lock down registrations using package ID 'lib-wrapper'\nallow_libwrapper_registrations = false;"],"names":["ERRORS","base","Error","internal","package","already_overridden","invalid_chain","Object","seal","PACKAGE_ID","DEBUG","EnumValue","enum_cls","name","value","sort","isFrozen","toUpperCase","value_obj","Function","value_cls","undefined","freeze","prototype","constructor","reverse","has","set","list","push","sort_list_by_value","Enum","collection","has_value","Array","enum_name","dflt","this","get","static","res","a","b","value_cls_name","enum","toString","lower","toLowerCase","Map","key","i18nLangs","langBaseUrl","import","meta","url","endsWith","i18n","lang","isArray","includes","URL","request","fetch","status","ok","json","e","console","warn","href","jsons","langs","clientLanguageSetting","localStorage","clientLanguage","JSON","parse","debug","serverLanguage","game","length","results","Promise","all","map","x","_fetch","localize","split","reduce","y","en_json","error","args","format","replace","_","game_user_data","return_null","orig_game_user_data","user","data","userid","userId","user_data","users","find","_id","PACKAGE_TYPES","KEY_SEPARATORS","PACKAGE_ID_REGEX","RegExp","STACK_TRACE_REGEX","foreach_package_in_stack_trace","matchFn","stack_trace","ignore_ids","old_stack_limit","stackTraceLimit","Infinity","stack","matches","matchAll","match","type","match_id","match_type","game_world_id","world","id","WORLD","game_system_id","system","SYSTEM","modules","MODULE","PackageInfo","UNKNOWN","include_fn","Set","add","test","detect_id","from_key","is_valid_id","detect_type","set_unknown","equals","obj","active","fail","sep","known","exists","unknown_title","title","type_i18n","type_plus_id","type_plus_id_capitalized","str","charAt","slice","type_plus_id_i18n","type_plus_title","type_plus_title_i18n","logId","settingsName","bugs","version","core_version_range","minimumCoreVersion","compatibleCoreVersion","compatible_with_core","versions","fvtt_version","release","game_version","min","max","isNewerVersion","global_eval","eval","set_function_name","fn","displayName","defineProperty","writable","enumerable","configurable","decorate_name","suffix","decorate_class_function_names","klass","props","getOwnPropertyNames","getOwnPropertySymbols","prop","descriptor","getOwnPropertyDescriptor","WRAPPERS","is_error_object","LIBWRAPPER_IGNORE_MATCHES","get_involved_packages_message","packages","collect_all","needle","get_involved_packages","p","join","has_property_string_writable","desc","inject_packages_into_error","skip_package_detection","can_inject_message","packages_str","message","orig_msg","LibWrapperError","notification_fn","ui_msg","console_msg","super","captureStackTrace","LibWrapperInternalError","onUnhandled","technical_msg","package_info","key_prefix","type_prefix","user_msg","prefix","construct_message","package_id","LibWrapperPackageError","support_list","entry","pkg_title","pkg_type_i18n","console_ui_msg","display_version","display","game_release_display","notupd_msg","info_url","report_url","community_support_msg","get_community_support_message","LibWrapperNotifications","NOTIFICATION_SET","ui_notifications_enabled","orig_game_user_isGM","isGM","role","game_user_isGM","settings","msg","add_title","notify","globalThis","ui","notifications","call","permanent","ready","_ui","Hooks","once","bind","vargs","other_info","potential","other","format_obj","main","console_ui","LibWrapperStats","action","orig_game_user_can","can","permissions","game_permissions_str","rolePerms","game_user_can","collect_stats","_collect_stats","PACKAGES","CONFLICTS","wrapper","ignored","count","targets","target","target_data","conflicts","IgnoredConflictEntry","ignore_infos","ignore_errors","is_ignored","is_warning","names","LibWrapperConflicts","IGNORED","ignore_entries","clear","_is_ignored_oneway","forEach","register_conflict","_is_ignored","frozen_names","LibWrapperAlreadyOverriddenError","conflicting_info","pkg_i18n","pkg_i18n_capitalized","confl_i18n","confl_i18n_capitalized","conflict_msg","info_msg","info1_url","info2_url","bugs_msg","bugs1_url","bugs2_url","_wrapper","module","conflicting_id","conflicting_module","LibWrapperInvalidWrapperChainError","onUnhandledError","apply","on_libwrapper_error","on_any_error","onUnhandledErrorEvent","event","cause","reason","VERSION","version_at_least","major","minor","patch","WRAPPER_TYPES","WRAPPER","MIXED","OVERRIDE","PERF_MODES","NORMAL","AUTO","FAST","Wrapper","_add_name","_callstack_name","nm","arg1","fn_name","object","_lib_wrapper","is_property","_wrapped_getter","_wrapped_setter","_wrapped","_get_inherited_descriptor","getter_data","_getter_data_id","setter_data","_setter_data_id","_outstanding_wrappers","_current_handler_id","_pending_wrapped_calls","_pending_wrapped_calls_cnt","update_use_static_dispatch","_wrap","_get_handler","handler_id","_cached_handler_id","_cached_handler","_this","handler_nm","wrapped","is_static_dispatch","use_static_dispatch","should_skip_wrappers","get_wrapped","get_static_dispatch_chain","call_wrapper","handler","fn_data_id","dispatch_chain","_cached_static_dispatch_chain_id","_cached_static_dispatch_chain_obj","_cached_static_dispatch_chain","_init_dispatch_chain","call_wrapped","fn_data","get_fn_data","i","chain","indexOf","skip_existing_handlers","_calc_use_static_dispatch","perf_mode","SAFE","getter_nm","setter_nm","setter","set_nonproperty","getter","unwrap","iObj","getPrototypeOf","result","state","_call_wrapper_update_state","is_setter","is_dynamic_dispatch","pend","_cleanup_call_wrapped","then","v","pend_i","splice","index","next_index","is_last","next_state","called","valid","prev_data","next_fn","_cleanup_call_wrapper_thrown","_cleanup_call_wrapper","_invalidate_state","collect_affected","warned_conflict","affectedPackages","is_last_wrapper","notify_user","filter","libWrapper","unregister","conflict","warn_classic_wrapper","get_affected_packages","trace","detected_classic_wrapper","to_modify","prop_nm","_post_update_fn_data","priority","remove","is_empty","PRIORITIES","load_priorities","priority_cfg","current","base_priority","entries","LibWrapperSettings","FormApplication","register","hint","default","Boolean","scope","config","registerMenu","label","icon","restricted","onChange","show_ignored_conflicts","defaultOptions","template","height","width","classes","tabs","navSelector","contentSelector","initial","submitOnClose","closeOnSubmit","options","yes_callback","Dialog","content","buttons","yes","callback","no","render","getActiveWrappers","_d","d","getConflicts","total","other_id","obj_total","getPackages","ret","prioritized","normal","deprioritized","priorities","cfg_prioritized","cfg_deprioritized","inactive","info","localeCompare","getData","about","translation_credits","support","wrappers","activateListeners","html","on","$this","$","parent","toggleClass","checked","select","is","focus","which","up","selected","insertPos","prev","next","before","after","_from","_to","from","to","element","next_focus","append","val","empty","arr","each","option","attr","appendTo","submit","showYesNoDialog","async","ev","formData","fld","old_prio","new_prio","counter","old_data","new_data","keys","location","reload","libwrapper_ready","allow_libwrapper_registrations","TGT_SPLIT_RE","TGT_CLEANUP_RE","_split_target_and_setter","_valid_target_string","_get_target_object","_target","root_nm","pop","root","varname","get_global_variable","_create_wrapper","_create_wrapper_from_object","_find_package_data_in_wrapper","_find_package_data_with_target","target_and_setter","_name","_find_wrapper_by_name","_unregister","_unwrap_if_possible","_get_package_info","size","git_version","is_fallback","InternalError","PackageError","AlreadyOverriddenError","InvalidWrapperChainError","PERF_NORMAL","PERF_AUTO","PERF_FAST","PERF_MODE","target_without_set","Number","MAX_VALUE","_get_default_priority","register_package","existing","callAll","is_string","every","register_ignore","addEventListener","onError","err","init_hooksOnError_listener","orig","_call","patched","log","patched_fn","catch","init_pre_v9p2_listeners","libWrapperInit","lw_info","init"],"mappings":"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"}